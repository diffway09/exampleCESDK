import { LocationStrategy } from '@angular/common';
import { Inject, Injectable, Optional } from '@angular/core';
import { DefaultUrlSerializer } from '@angular/router';
import { START_PATH } from '../../tokens';
import { NativeScriptDebug } from '../../trace';
import { FrameService } from '../frame.service';
import { defaultNavOptions, Outlet } from './ns-location-utils';
import * as i0 from "@angular/core";
import * as i1 from "../frame.service";
export class NSLocationStrategy extends LocationStrategy {
    constructor(frameService, startPath) {
        super();
        this.frameService = frameService;
        this.startPath = startPath;
        this.outlets = [];
        this.popStateCallbacks = new Array();
        this._modalNavigationDepth = 0;
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routerLog('NSLocationStrategy.constructor()');
        }
    }
    getState() {
        return this.currentOutlet && this.currentOutlet.peekState();
    }
    path() {
        if (!this.currentUrlTree) {
            return this.startPath || '/';
        }
        const state = this.currentOutlet && this.currentOutlet.peekState();
        if (!state) {
            return '/';
        }
        const tree = this.currentUrlTree;
        const changedOutlet = this.getSegmentGroupByOutlet(this.currentOutlet);
        // Handle case where the user declares a component at path "/".
        // The url serializer doesn't parse this url as having a primary outlet.
        if (state.isRootSegmentGroup) {
            tree.root = state.segmentGroup;
        }
        else if (changedOutlet) {
            this.updateSegmentGroup(tree.root, changedOutlet, state.segmentGroup);
        }
        const urlSerializer = new DefaultUrlSerializer();
        tree.queryParams = state.queryParams;
        const url = urlSerializer.serialize(tree);
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routerLog('NSLocationStrategy.path(): ' + url);
        }
        return url;
    }
    prepareExternalUrl(internal) {
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routerLog('NSLocationStrategy.prepareExternalUrl() internal: ' + internal);
        }
        return internal;
    }
    pushState(state, title, url, queryParams) {
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routerLog('NSLocationStrategy.pushState state: ' + `${state}, title: ${title}, url: ${url}, queryParams: ${queryParams}`);
        }
        this.pushStateInternal(state, title, url, queryParams);
    }
    pushStateInternal(state, title, url, queryParams, replace = false) {
        const urlSerializer = new DefaultUrlSerializer();
        this.currentUrlTree = urlSerializer.parse(url);
        const urlTreeRoot = this.currentUrlTree.root;
        // Handle case where the user declares a component at path "/".
        // The url serializer doesn't parse this url as having a primary outlet.
        if (!Object.keys(urlTreeRoot.children).length) {
            const segmentGroup = this.currentUrlTree && this.currentUrlTree.root;
            const outletKey = this.getOutletKey(this.getSegmentGroupFullPath(segmentGroup), 'primary');
            const outlet = this.findOutlet(outletKey);
            if (outlet && this.updateStates(outlet, segmentGroup, this.currentUrlTree.queryParams, replace)) {
                this.currentOutlet = outlet; // If states updated
            }
            else if (!outlet) {
                // tslint:disable-next-line:max-line-length
                const rootOutlet = this.createOutlet('primary', null, segmentGroup, null, null, this.currentUrlTree.queryParams);
                this.currentOutlet = rootOutlet;
            }
            this.currentOutlet.peekState().isRootSegmentGroup = true;
            return;
        }
        const queue = [];
        let currentTree = urlTreeRoot;
        while (currentTree) {
            Object.keys(currentTree.children).forEach((outletName) => {
                const currentSegmentGroup = currentTree.children[outletName];
                currentSegmentGroup.outlet = outletName;
                currentSegmentGroup.root = urlTreeRoot;
                const outletPath = this.getSegmentGroupFullPath(currentTree);
                const outletKey = this.getOutletKey(outletPath, outletName);
                let outlet = this.findOutlet(outletKey);
                const parentOutletName = currentTree.outlet || '';
                const parentOutletPath = this.getSegmentGroupFullPath(currentTree.parent);
                const parentOutletKey = this.getOutletKey(parentOutletPath, parentOutletName);
                const parentOutlet = this.findOutlet(parentOutletKey);
                const containsLastState = outlet && outlet.containsTopState(currentSegmentGroup.toString());
                if (!outlet) {
                    // tslint:disable-next-line:max-line-length
                    outlet = this.createOutlet(outletKey, outletPath, currentSegmentGroup, parentOutlet, this._modalNavigationDepth, this.currentUrlTree.queryParams);
                    this.currentOutlet = outlet;
                }
                else if (this._modalNavigationDepth > 0 && outlet.showingModal && !containsLastState) {
                    // Navigation inside modal view.
                    this.upsertModalOutlet(outlet, currentSegmentGroup, this.currentUrlTree.queryParams, replace);
                }
                else {
                    outlet.parent = parentOutlet;
                    if (this.updateStates(outlet, currentSegmentGroup, this.currentUrlTree.queryParams, replace)) {
                        this.currentOutlet = outlet; // If states updated
                    }
                }
                queue.push(currentSegmentGroup);
            });
            currentTree = queue.shift();
        }
    }
    replaceState(state, title, url, queryParams) {
        const states = this.currentOutlet && this.currentOutlet.states;
        if (states && states.length > 0) {
            if (NativeScriptDebug.isLogEnabled()) {
                NativeScriptDebug.routerLog('NSLocationStrategy.replaceState changing existing state: ' + `${state}, title: ${title}, url: ${url}, queryParams: ${queryParams}`);
            }
            this.pushStateInternal(state, title, url, queryParams, true);
        }
        else {
            if (NativeScriptDebug.isLogEnabled()) {
                NativeScriptDebug.routerLog('NSLocationStrategy.replaceState pushing new state: ' + `${state}, title: ${title}, url: ${url}, queryParams: ${queryParams}`);
            }
            this.pushStateInternal(state, title, url, queryParams);
        }
    }
    forward() {
        throw new Error('NSLocationStrategy.forward() - not implemented');
    }
    back(outlet, frame) {
        this.currentOutlet = outlet || this.currentOutlet;
        if (this.currentOutlet.isPageNavigationBack) {
            const states = this.currentOutlet.states;
            // We are navigating to the previous page
            // clear the stack until we get to a page navigation state
            let state = states.pop();
            let count = 1;
            if (frame) {
                while (state.frame && state.frame !== frame) {
                    state = states.pop();
                    count++;
                }
            }
            while (!state.isPageNavigation) {
                state = states.pop();
                count++;
            }
            if (NativeScriptDebug.isLogEnabled()) {
                NativeScriptDebug.routerLog(`NSLocationStrategy.back() while navigating back. States popped: ${count}`);
            }
            this.callPopState(state, true);
        }
        else {
            const state = this.currentOutlet.peekState();
            if (state && state.isPageNavigation) {
                // This was a page navigation - so navigate through frame.
                if (NativeScriptDebug.isLogEnabled()) {
                    NativeScriptDebug.routerLog('NSLocationStrategy.back() while not navigating back but top' + ' state is page - will call frame.goBack()');
                }
                if (!outlet) {
                    const topmostFrame = this.frameService.getFrame();
                    this.currentOutlet = this.getOutletByFrame(topmostFrame) || this.currentOutlet;
                }
                const frameToBack = this.currentOutlet.getFrameToBack();
                if (frameToBack) {
                    frameToBack.goBack();
                }
            }
            else {
                // Nested navigation - just pop the state
                if (NativeScriptDebug.isLogEnabled()) {
                    NativeScriptDebug.routerLog('NSLocationStrategy.back() while not navigating back but top' + ' state is not page - just pop');
                }
                this.callPopState(this.currentOutlet.states.pop(), true);
            }
        }
    }
    canGoBack(outlet) {
        outlet = outlet || this.currentOutlet;
        return outlet.states.length > 1;
    }
    onPopState(fn) {
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routerLog('NSLocationStrategy.onPopState');
        }
        this.popStateCallbacks.push(fn);
    }
    getBaseHref() {
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routerLog('NSLocationStrategy.getBaseHref()');
        }
        return '';
    }
    callPopState(state, pop = true, outlet) {
        outlet = outlet || this.currentOutlet;
        const urlSerializer = new DefaultUrlSerializer();
        const changedOutlet = this.getSegmentGroupByOutlet(outlet);
        if (state && changedOutlet) {
            this.updateSegmentGroup(this.currentUrlTree.root, changedOutlet, state.segmentGroup);
        }
        else if (changedOutlet) {
            // when closing modal view there are scenarios (e.g. root viewContainerRef) when we need
            // to clean up the named page router outlet to make sure we will open the modal properly again if needed.
            this.updateSegmentGroup(this.currentUrlTree.root, changedOutlet, null);
        }
        const url = urlSerializer.serialize(this.currentUrlTree);
        const change = { state, type: 'popstate' };
        for (const fn of this.popStateCallbacks) {
            fn(change);
        }
    }
    toString() {
        let result = [];
        this.outlets.forEach((outlet) => {
            const outletStates = outlet.states;
            const outletLog = outletStates
                // tslint:disable-next-line:max-line-length
                .map((v, i) => `${outlet.outletKeys}.${i}.[${v.isPageNavigation ? 'PAGE' : 'INTERNAL'}].[${outlet.modalNavigationDepth ? 'MODAL' : 'BASE'}] "${v.segmentGroup.toString()}"`)
                .reverse();
            result = result.concat(outletLog);
        });
        return result.join('\n');
    }
    // Methods for syncing with page navigation in PageRouterOutlet
    _beginBackPageNavigation(frame, outletKey) {
        const outlet = this.getOutletByFrame(frame);
        if (!outlet || outlet.isPageNavigationBack) {
            if (NativeScriptDebug.isLogEnabled()) {
                NativeScriptDebug.routerError('Attempted to call startGoBack while going back.');
            }
            return;
        }
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routerLog('NSLocationStrategy.startGoBack()');
        }
        outlet.setOutletKeyNavigatingBack(outletKey);
        // outlet.isPageNavigationBack = true;
        // we find all the children and also set their isPageNavigationBack
        this.outlets
            .filter((o) => {
            let parent = o.parent;
            while (parent) {
                if (parent === outlet) {
                    return true;
                }
                parent = parent.parent;
            }
            return false;
        })
            .forEach((o) => (o.isPageNavigationBack = true));
        this.currentOutlet = outlet;
    }
    _finishBackPageNavigation(frame) {
        const outlet = this.getOutletByFrame(frame);
        if (!outlet || !outlet.isPageNavigationBack) {
            if (NativeScriptDebug.isLogEnabled()) {
                NativeScriptDebug.routerError('Attempted to call endGoBack while not going back.');
            }
            return;
        }
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routerLog('NSLocationStrategy.finishBackPageNavigation()');
        }
        outlet.isPageNavigationBack = false;
    }
    _beginModalNavigation(frame) {
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routerLog('NSLocationStrategy._beginModalNavigation()');
        }
        this.currentOutlet = this.getOutletByFrame(frame) || this.currentOutlet;
        // It is possible to have frame, but not corresponding Outlet, if
        // showing modal dialog on app.component.ts ngOnInit() e.g. In that case
        // the modal is treated as none modal navigation.
        if (this.currentOutlet) {
            this.currentOutlet.showingModal = true;
            this._modalNavigationDepth++;
        }
    }
    _closeModalNavigation() {
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routerLog('NSLocationStrategy.closeModalNavigation()');
        }
        const isShowingModal = this._modalNavigationDepth > 0;
        if (isShowingModal) {
            this._modalNavigationDepth--;
        }
        // currentOutlet should be the one that corresponds to the topmost frame
        const topmostOutlet = this.getOutletByFrame(this.frameService.getFrame());
        const outlet = this.findOutletByModal(this._modalNavigationDepth, isShowingModal) || topmostOutlet;
        if (outlet) {
            this.currentOutlet = outlet;
            this.currentOutlet.showingModal = false;
            this.callPopState(this.currentOutlet.peekState(), false);
            // this is needed because angular does a setTimeout on onPopState, so if we don't do this we might end up with inconsistent state
            return new Promise((resolve) => setTimeout(resolve, 0));
        }
    }
    _beginPageNavigation(frame, options) {
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routerLog('NSLocationStrategy._beginPageNavigation()');
        }
        this.currentOutlet = this.getOutletByFrame(frame) || this.currentOutlet;
        const lastState = this.currentOutlet.peekState();
        if (lastState) {
            lastState.isPageNavigation = true;
        }
        const navOptions = options || defaultNavOptions;
        if (navOptions.clearHistory) {
            if (NativeScriptDebug.isLogEnabled()) {
                NativeScriptDebug.routerLog('NSLocationStrategy._beginPageNavigation clearing states history');
            }
            this.currentOutlet.states = [lastState];
        }
        return navOptions;
    }
    _getOutlets() {
        return this.outlets;
    }
    updateOutletFrame(outlet, frame, isEmptyOutletFrame) {
        const lastState = outlet.peekState();
        if (lastState && !lastState.frame && !isEmptyOutletFrame) {
            lastState.frame = frame;
        }
        if (!outlet.containsFrame(frame)) {
            outlet.frames.push(frame);
        }
        this.currentOutlet = outlet;
    }
    clearOutlet(frame) {
        this.outlets = this.outlets.filter((currentOutlet) => {
            let isEqualToCurrent;
            if (this.currentOutlet) {
                isEqualToCurrent = currentOutlet.pathByOutlets === this.currentOutlet.pathByOutlets;
            }
            // Remove outlet from the url tree.
            if (currentOutlet.containsFrame(frame) && !isEqualToCurrent) {
                this.callPopState(null, true, currentOutlet);
            }
            // Skip frames filtering since currentOutlet is <router-outlet> when no frames available.
            if (currentOutlet.frames.length && !currentOutlet.isNSEmptyOutlet) {
                currentOutlet.frames = currentOutlet.frames.filter((currentFrame) => currentFrame !== frame);
                return currentOutlet.frames.length;
            }
            return !currentOutlet.containsFrame(frame);
        });
    }
    getSegmentGroupFullPath(segmentGroup) {
        let fullPath = '';
        while (segmentGroup) {
            const url = segmentGroup.toString();
            if (fullPath) {
                fullPath = (url ? url + '/' : '') + fullPath;
            }
            else {
                fullPath = url;
            }
            segmentGroup = segmentGroup.parent;
        }
        return fullPath;
    }
    getRouteFullPath(currentRoute) {
        const outletName = currentRoute.outlet;
        let fullPath;
        currentRoute = currentRoute.parent;
        while (currentRoute) {
            const urls = currentRoute.url.value || currentRoute.url;
            let url = urls;
            if (Array.isArray(urls)) {
                url = url.join('/');
            }
            fullPath = fullPath ? (url ? url + '/' : url) + fullPath : url;
            currentRoute = currentRoute.parent;
        }
        return fullPath ? fullPath + '-' + outletName : outletName;
    }
    getPathByOutlets(urlSegmentGroup) {
        if (!urlSegmentGroup) {
            return '';
        }
        let pathToOutlet;
        let lastPath = urlSegmentGroup.outlet || 'primary';
        let parent = urlSegmentGroup.parent;
        while (parent && urlSegmentGroup.root !== parent) {
            if (parent && parent.outlet !== lastPath) {
                if (lastPath === 'primary') {
                    lastPath = parent.outlet;
                }
                else {
                    lastPath = parent.outlet;
                    pathToOutlet = lastPath + '-' + (pathToOutlet || urlSegmentGroup.outlet);
                }
            }
            parent = parent.parent;
        }
        return pathToOutlet || lastPath;
    }
    findOutlet(outletKey, activatedRouteSnapshot) {
        let outlet = this.outlets.find((currentOutlet) => {
            const equalModalDepth = currentOutlet.modalNavigationDepth === this._modalNavigationDepth;
            return equalModalDepth && currentOutlet.outletKeys.indexOf(outletKey) > -1;
        });
        // No Outlet with the given outletKey could happen when using nested unnamed p-r-o
        // primary -> primary -> prymary
        if (!outlet && activatedRouteSnapshot) {
            const pathByOutlets = this.getPathByOutlets(activatedRouteSnapshot);
            outlet = this.outlets.find((currentOutlet) => {
                const equalModalDepth = currentOutlet.modalNavigationDepth === this._modalNavigationDepth;
                return equalModalDepth && currentOutlet.pathByOutlets === pathByOutlets;
            });
        }
        return outlet;
    }
    findOutletByModal(modalNavigation, isShowingModal) {
        return this.outlets.find((outlet) => {
            const equalModalDepth = outlet.modalNavigationDepth === modalNavigation;
            return isShowingModal ? equalModalDepth && outlet.showingModal : equalModalDepth;
        });
    }
    getOutletByFrame(frame) {
        let outlet;
        for (let index = 0; index < this.outlets.length; index++) {
            const currentOutlet = this.outlets[index];
            if (currentOutlet.containsFrame(frame)) {
                outlet = currentOutlet;
                break;
            }
        }
        return outlet;
    }
    updateStates(outlet, currentSegmentGroup, queryParams, replace = false) {
        const isNewPage = outlet.states.length === 0;
        const lastState = outlet.states[outlet.states.length - 1];
        const equalStateUrls = outlet.containsTopState(currentSegmentGroup.toString());
        const locationState = {
            segmentGroup: currentSegmentGroup,
            isRootSegmentGroup: false,
            isPageNavigation: isNewPage,
            queryParams: { ...queryParams },
        };
        if (!lastState || !equalStateUrls) {
            if (replace) {
                outlet.states.pop();
            }
            outlet.states.push(locationState);
            // Update last state segmentGroup of parent Outlet.
            if (this._modalNavigationDepth === 0 && !outlet.showingModal) {
                this.updateParentsStates(outlet, currentSegmentGroup.parent);
            }
            return true;
        }
        else {
            if (lastState && equalStateUrls) {
                // update query params for last state
                lastState.queryParams = { ...queryParams };
            }
        }
        return false;
    }
    updateParentsStates(outlet, newSegmentGroup) {
        let parentOutlet = outlet.parent;
        // Update parents lastState segmentGroups
        while (parentOutlet && newSegmentGroup) {
            const state = parentOutlet.peekState();
            if (state) {
                state.segmentGroup = newSegmentGroup;
                newSegmentGroup = newSegmentGroup.parent;
                parentOutlet = parentOutlet.parent;
            }
        }
    }
    // tslint:disable-next-line:max-line-length
    createOutlet(outletKey, path, segmentGroup, parent, modalNavigation, queryParams = {}) {
        const pathByOutlets = this.getPathByOutlets(segmentGroup);
        const newOutlet = new Outlet(outletKey, path, pathByOutlets, modalNavigation);
        const locationState = {
            segmentGroup: segmentGroup,
            isRootSegmentGroup: false,
            isPageNavigation: true, // It is a new OutletNode.
            queryParams: { ...queryParams },
        };
        newOutlet.states = [locationState];
        newOutlet.parent = parent;
        this.outlets.push(newOutlet);
        // Update last state segmentGroup of parent Outlet.
        if (this._modalNavigationDepth === 0 && !newOutlet.showingModal) {
            this.updateParentsStates(newOutlet, segmentGroup.parent);
        }
        return newOutlet;
    }
    getSegmentGroupByOutlet(outlet) {
        const pathList = outlet.pathByOutlets.split('-');
        let segmentGroup = this.currentUrlTree.root;
        let pathToOutlet;
        for (let index = 0; index < pathList.length; index++) {
            const currentPath = pathList[index];
            const childrenCount = Object.keys(segmentGroup.children).length;
            if (childrenCount && segmentGroup.children[currentPath]) {
                const url = segmentGroup.toString();
                pathToOutlet = pathToOutlet ? pathToOutlet + '/' + url : url;
                segmentGroup = segmentGroup.children[currentPath];
            }
            else {
                // If no child outlet found with the given name - forget about all previously found outlets.
                // example: seaching for 'primary-second-primary' shouldn't return 'primary-second'
                // if no 'primary' child available on 'second'.
                segmentGroup = null;
                break;
            }
        }
        // Paths should also match since there could be another Outlet
        // with the same pathByOutlets but different url path.
        if (segmentGroup && outlet.path && pathToOutlet && outlet.path !== pathToOutlet) {
            segmentGroup = null;
        }
        return segmentGroup;
    }
    // Traversal and replacement of segmentGroup.
    updateSegmentGroup(rootNode, oldSegmentGroup, newSegmentGroup) {
        const queue = [];
        let currentTree = rootNode;
        while (currentTree) {
            Object.keys(currentTree.children).forEach((outletName) => {
                if (currentTree.children[outletName] === oldSegmentGroup) {
                    if (newSegmentGroup) {
                        currentTree.children[outletName] = newSegmentGroup;
                    }
                    else {
                        delete currentTree.children[outletName];
                    }
                }
                queue.push(currentTree.children[outletName]);
            });
            currentTree = queue.shift();
        }
    }
    upsertModalOutlet(parentOutlet, segmentedGroup, queryParams, replace = false) {
        let currentModalOutlet = this.findOutletByModal(this._modalNavigationDepth);
        // We want to treat every p-r-o as a standalone Outlet.
        if (!currentModalOutlet) {
            if (this._modalNavigationDepth > 1) {
                // The parent of the current Outlet should be the previous opened modal (if any).
                parentOutlet = this.findOutletByModal(this._modalNavigationDepth - 1);
            }
            // No currentModalOutlet available when opening 'primary' p-r-o.
            const outletName = 'primary';
            const outletPath = parentOutlet.peekState().segmentGroup.toString();
            const outletKey = this.getOutletKey(outletPath, outletName);
            // tslint:disable-next-line:max-line-length
            currentModalOutlet = this.createOutlet(outletKey, outletPath, segmentedGroup, parentOutlet, this._modalNavigationDepth, queryParams);
            this.currentOutlet = currentModalOutlet;
        }
        else if (this.updateStates(currentModalOutlet, segmentedGroup, queryParams, replace)) {
            this.currentOutlet = currentModalOutlet; // If states updated
        }
    }
    getOutletKey(path, outletName) {
        return path ? path + '-' + outletName : outletName;
    }
    ngOnDestroy() {
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routerLog('NSLocationStrategy.ngOnDestroy()');
        }
        this.outlets = [];
        this.currentOutlet = null;
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "18.1.0", ngImport: i0, type: NSLocationStrategy, deps: [{ token: i1.FrameService }, { token: START_PATH, optional: true }], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "18.1.0", ngImport: i0, type: NSLocationStrategy, providedIn: 'root' }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "18.1.0", ngImport: i0, type: NSLocationStrategy, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root',
                }]
        }], ctorParameters: () => [{ type: i1.FrameService }, { type: undefined, decorators: [{
                    type: Inject,
                    args: [START_PATH]
                }, {
                    type: Optional
                }] }] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibnMtbG9jYXRpb24tc3RyYXRlZ3kuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi9wYWNrYWdlcy9hbmd1bGFyL3NyYy9saWIvbGVnYWN5L3JvdXRlci9ucy1sb2NhdGlvbi1zdHJhdGVneS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQXVCLGdCQUFnQixFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDeEUsT0FBTyxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFhLE1BQU0sZUFBZSxDQUFDO0FBQ3hFLE9BQU8sRUFBMEIsb0JBQW9CLEVBQW9DLE1BQU0saUJBQWlCLENBQUM7QUFFakgsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGNBQWMsQ0FBQztBQUMxQyxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDaEQsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQ2hELE9BQU8sRUFBRSxpQkFBaUIsRUFBb0MsTUFBTSxFQUFFLE1BQU0scUJBQXFCLENBQUM7OztBQUtsRyxNQUFNLE9BQU8sa0JBQW1CLFNBQVEsZ0JBQWdCO0lBU3RELFlBQ1UsWUFBMEIsRUFDTSxTQUFrQjtRQUUxRCxLQUFLLEVBQUUsQ0FBQztRQUhBLGlCQUFZLEdBQVosWUFBWSxDQUFjO1FBQ00sY0FBUyxHQUFULFNBQVMsQ0FBUztRQVZwRCxZQUFPLEdBQWtCLEVBQUUsQ0FBQztRQUc1QixzQkFBaUIsR0FBRyxJQUFJLEtBQUssRUFBbUIsQ0FBQztRQUdsRCwwQkFBcUIsR0FBRyxDQUFDLENBQUM7UUFPL0IsSUFBSSxpQkFBaUIsQ0FBQyxZQUFZLEVBQUUsRUFBRSxDQUFDO1lBQ3JDLGlCQUFpQixDQUFDLFNBQVMsQ0FBQyxrQ0FBa0MsQ0FBQyxDQUFDO1FBQ2xFLENBQUM7SUFDSCxDQUFDO0lBRUQsUUFBUTtRQUNOLE9BQU8sSUFBSSxDQUFDLGFBQWEsSUFBSSxJ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RSxNQUFNO2lCQUNuQjs7MEJBWUksTUFBTTsyQkFBQyxVQUFVOzswQkFBRyxRQUFRIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgTG9jYXRpb25DaGFuZ2VFdmVudCwgTG9jYXRpb25TdHJhdGVneSB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbic7XG5pbXBvcnQgeyBJbmplY3QsIEluamVjdGFibGUsIE9wdGlvbmFsLCBPbkRlc3Ryb3kgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEFjdGl2YXRlZFJvdXRlU25hcHNob3QsIERlZmF1bHRVcmxTZXJpYWxpemVyLCBQYXJhbXMsIFVybFNlZ21lbnRHcm91cCwgVXJsVHJlZSB9IGZyb20gJ0Bhbmd1bGFyL3JvdXRlcic7XG5pbXBvcnQgeyBGcmFtZSB9IGZyb20gJ0BuYXRpdmVzY3JpcHQvY29yZSc7XG5pbXBvcnQgeyBTVEFSVF9QQVRIIH0gZnJvbSAnLi4vLi4vdG9rZW5zJztcbmltcG9ydCB7IE5hdGl2ZVNjcmlwdERlYnVnIH0gZnJvbSAnLi4vLi4vdHJhY2UnO1xuaW1wb3J0IHsgRnJhbWVTZXJ2aWNlIH0gZnJvbSAnLi4vZnJhbWUuc2VydmljZSc7XG5pbXBvcnQgeyBkZWZhdWx0TmF2T3B0aW9ucywgTG9jYXRpb25TdGF0ZSwgTmF2aWdhdGlvbk9wdGlvbnMsIE91dGxldCB9IGZyb20gJy4vbnMtbG9jYXRpb24tdXRpbHMnO1xuXG5ASW5qZWN0YWJsZSh7XG4gIHByb3ZpZGVkSW46ICdyb290Jyxcbn0pXG5leHBvcnQgY2xhc3MgTlNMb2NhdGlvblN0cmF0ZWd5IGV4dGVuZHMgTG9jYXRpb25TdHJhdGVneSBpbXBsZW1lbnRzIE9uRGVzdHJveSB7XG4gIHByaXZhdGUgb3V0bGV0czogQXJyYXk8T3V0bGV0PiA9IFtdO1xuICBwcml2YXRlIGN1cnJlbnRPdXRsZXQ6IE91dGxldDtcblxuICBwcml2YXRlIHBvcFN0YXRlQ2FsbGJhY2tzID0gbmV3IEFycmF5PChfOiBhbnkpID0+IGFueT4oKTtcbiAgcHJpdmF0ZSBjdXJyZW50VXJsVHJlZTogVXJsVHJlZTtcblxuICBwdWJsaWMgX21vZGFsTmF2aWdhdGlvbkRlcHRoID0gMDtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIGZyYW1lU2VydmljZTogRnJhbWVTZXJ2aWNlLFxuICAgIEBJbmplY3QoU1RBUlRfUEFUSCkgQE9wdGlvbmFsKCkgcHJpdmF0ZSBzdGFydFBhdGg/OiBzdHJpbmcsXG4gICkge1xuICAgIHN1cGVyKCk7XG4gICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmlzTG9nRW5hYmxlZCgpKSB7XG4gICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yb3V0ZXJMb2coJ05TTG9jYXRpb25TdHJhdGVneS5jb25zdHJ1Y3RvcigpJyk7XG4gICAgfVxuICB9XG5cbiAgZ2V0U3RhdGUoKTogdW5rbm93biB7XG4gICAgcmV0dXJuIHRoaXMuY3VycmVudE91dGxldCAmJiB0aGlzLmN1cnJlbnRPdXRsZXQucGVla1N0YXRlKCk7XG4gIH1cblxuICBwYXRoKCk6IHN0cmluZyB7XG4gICAgaWYgKCF0aGlzLmN1cnJlbnRVcmxUcmVlKSB7XG4gICAgICByZXR1cm4gdGhpcy5zdGFydFBhdGggfHwgJy8nO1xuICAgIH1cblxuICAgIGNvbnN0IHN0YXRlID0gdGhpcy5jdXJyZW50T3V0bGV0ICYmIHRoaXMuY3VycmVudE91dGxldC5wZWVrU3RhdGUoKTtcbiAgICBpZiAoIXN0YXRlKSB7XG4gICAgICByZXR1cm4gJy8nO1xuICAgIH1cblxuICAgIGNvbnN0IHRyZWUgPSB0aGlzLmN1cnJlbnRVcmxUcmVlO1xuICAgIGNvbnN0IGNoYW5nZWRPdXRsZXQgPSB0aGlzLmdldFNlZ21lbnRHcm91cEJ5T3V0bGV0KHRoaXMuY3VycmVudE91dGxldCk7XG5cbiAgICAvLyBIYW5kbGUgY2FzZSB3aGVyZSB0aGUgdXNlciBkZWNsYXJlcyBhIGNvbXBvbmVudCBhdCBwYXRoIFwiL1wiLlxuICAgIC8vIFRoZSB1cmwgc2VyaWFsaXplciBkb2Vzbid0IHBhcnNlIHRoaXMgdXJsIGFzIGhhdmluZyBhIHByaW1hcnkgb3V0bGV0LlxuICAgIGlmIChzdGF0ZS5pc1Jvb3RTZWdtZW50R3JvdXApIHtcbiAgICAgIHRyZWUucm9vdCA9IHN0YXRlLnNlZ21lbnRHcm91cDtcbiAgICB9IGVsc2UgaWYgKGNoYW5nZWRPdXRsZXQpIHtcbiAgICAgIHRoaXMudXBkYXRlU2VnbWVudEdyb3VwKHRyZWUucm9vdCwgY2hhbmdlZE91dGxldCwgc3RhdGUuc2VnbWVudEdyb3VwKTtcbiAgICB9XG5cbiAgICBjb25zdCB1cmxTZXJpYWxpemVyID0gbmV3IERlZmF1bHRVcmxTZXJpYWxpemVyKCk7XG4gICAgdHJlZS5xdWVyeVBhcmFtcyA9IHN0YXRlLnF1ZXJ5UGFyYW1zO1xuICAgIGNvbnN0IHVybCA9IHVybFNlcmlhbGl6ZXIuc2VyaWFsaXplKHRyZWUpO1xuICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuICAgICAgTmF0aXZlU2NyaXB0RGVidWcucm91dGVyTG9nKCdOU0xvY2F0aW9uU3RyYXRlZ3kucGF0aCgpOiAnICsgdXJsKTtcbiAgICB9XG4gICAgcmV0dXJuIHVybDtcbiAgfVxuXG4gIHByZXBhcmVFeHRlcm5hbFVybChpbnRlcm5hbDogc3RyaW5nKTogc3RyaW5nIHtcbiAgICBpZiAoTmF0aXZlU2NyaXB0RGVidWcuaXNMb2dFbmFibGVkKCkpIHtcbiAgICAgIE5hdGl2ZVNjcmlwdERlYnVnLnJvdXRlckxvZygnTlNMb2NhdGlvblN0cmF0ZWd5LnByZXBhcmVFeHRlcm5hbFVybCgpIGludGVybmFsOiAnICsgaW50ZXJuYWwpO1xuICAgIH1cbiAgICByZXR1cm4gaW50ZXJuYWw7XG4gIH1cblxuICBwdXNoU3RhdGUoc3RhdGU6IGFueSwgdGl0bGU6IHN0cmluZywgdXJsOiBzdHJpbmcsIHF1ZXJ5UGFyYW1zOiBzdHJpbmcpOiB2b2lkIHtcbiAgICBpZiAoTmF0aXZlU2NyaXB0RGVidWcuaXNMb2dFbmFibGVkKCkpIHtcbiAgICAgIE5hdGl2ZVNjcmlwdERlYnVnLnJvdXRlckxvZygnTlNMb2NhdGlvblN0cmF0ZWd5LnB1c2hTdGF0ZSBzdGF0ZTogJyArIGAke3N0YXRlfSwgdGl0bGU6ICR7dGl0bGV9LCB1cmw6ICR7dXJsfSwgcXVlcnlQYXJhbXM6ICR7cXVlcnlQYXJhbXN9YCk7XG4gICAgfVxuICAgIHRoaXMucHVzaFN0YXRlSW50ZXJuYWwoc3RhdGUsIHRpdGxlLCB1cmwsIHF1ZXJ5UGFyYW1zKTtcbiAgfVxuXG4gIHB1c2hTdGF0ZUludGVybmFsKHN0YXRlOiBhbnksIHRpdGxlOiBzdHJpbmcsIHVybDogc3RyaW5nLCBxdWVyeVBhcmFtczogc3RyaW5nLCByZXBsYWNlID0gZmFsc2UpOiB2b2lkIHtcbiAgICBjb25zdCB1cmxTZXJpYWxpemVyID0gbmV3IERlZmF1bHRVcmxTZXJpYWxpemVyKCk7XG4gICAgdGhpcy5jdXJyZW50VXJsVHJlZSA9IHVybFNlcmlhbGl6ZXIucGFyc2UodXJsKTtcbiAgICBjb25zdCB1cmxUcmVlUm9vdCA9IHRoaXMuY3VycmVudFVybFRyZWUucm9vdDtcblxuICAgIC8vIEhhbmRsZSBjYXNlIHdoZXJlIHRoZSB1c2VyIGRlY2xhcmVzIGEgY29tcG9uZW50IGF0IHBhdGggXCIvXCIuXG4gICAgLy8gVGhlIHVybCBzZXJpYWxpemVyIGRvZXNuJ3QgcGFyc2UgdGhpcyB1cmwgYXMgaGF2aW5nIGEgcHJpbWFyeSBvdXRsZXQuXG4gICAgaWYgKCFPYmplY3Qua2V5cyh1cmxUcmVlUm9vdC5jaGlsZHJlbikubGVuZ3RoKSB7XG4gICAgICBjb25zdCBzZWdtZW50R3JvdXAgPSB0aGlzLmN1cnJlbnRVcmxUcmVlICYmIHRoaXMuY3VycmVudFVybFRyZWUucm9vdDtcbiAgICAgIGNvbnN0IG91dGxldEtleSA9IHRoaXMuZ2V0T3V0bGV0S2V5KHRoaXMuZ2V0U2VnbWVudEdyb3VwRnVsbFBhdGgoc2VnbWVudEdyb3VwKSwgJ3ByaW1hcnknKTtcbiAgICAgIGNvbnN0IG91dGxldCA9IHRoaXMuZmluZE91dGxldChvdXRsZXRLZXkpO1xuXG4gICAgICBpZiAob3V0bGV0ICYmIHRoaXMudXBkYXRlU3RhdGVzKG91dGxldCwgc2VnbWVudEdyb3VwLCB0aGlzLmN1cnJlbnRVcmxUcmVlLnF1ZXJ5UGFyYW1zLCByZXBsYWNlKSkge1xuICAgICAgICB0aGlzLmN1cnJlbnRPdXRsZXQgPSBvdXRsZXQ7IC8vIElmIHN0YXRlcyB1cGRhdGVkXG4gICAgICB9IGVsc2UgaWYgKCFvdXRsZXQpIHtcbiAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm1heC1saW5lLWxlbmd0aFxuICAgICAgICBjb25zdCByb290T3V0bGV0ID0gdGhpcy5jcmVhdGVPdXRsZXQoJ3ByaW1hcnknLCBudWxsLCBzZWdtZW50R3JvdXAsIG51bGwsIG51bGwsIHRoaXMuY3VycmVudFVybFRyZWUucXVlcnlQYXJhbXMpO1xuICAgICAgICB0aGlzLmN1cnJlbnRPdXRsZXQgPSByb290T3V0bGV0O1xuICAgICAgfVxuXG4gICAgICB0aGlzLmN1cnJlbnRPdXRsZXQucGVla1N0YXRlKCkuaXNSb290U2VnbWVudEdyb3VwID0gdHJ1ZTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCBxdWV1ZSA9IFtdO1xuICAgIGxldCBjdXJyZW50VHJlZSA9IDxhbnk+dXJsVHJlZVJvb3Q7XG5cbiAgICB3aGlsZSAoY3VycmVudFRyZWUpIHtcbiAgICAgIE9iamVjdC5rZXlzKGN1cnJlbnRUcmVlLmNoaWxkcmVuKS5mb3JFYWNoKChvdXRsZXROYW1lKSA9PiB7XG4gICAgICAgIGNvbnN0IGN1cnJlbnRTZWdtZW50R3JvdXAgPSBjdXJyZW50VHJlZS5jaGlsZHJlbltvdXRsZXROYW1lXTtcbiAgICAgICAgY3VycmVudFNlZ21lbnRHcm91cC5vdXRsZXQgPSBvdXRsZXROYW1lO1xuICAgICAgICBjdXJyZW50U2VnbWVudEdyb3VwLnJvb3QgPSB1cmxUcmVlUm9vdDtcblxuICAgICAgICBjb25zdCBvdXRsZXRQYXRoID0gdGhpcy5nZXRTZWdtZW50R3JvdXBGdWxsUGF0aChjdXJyZW50VHJlZSk7XG4gICAgICAgIGNvbnN0IG91dGxldEtleSA9IHRoaXMuZ2V0T3V0bGV0S2V5KG91dGxldFBhdGgsIG91dGxldE5hbWUpO1xuICAgICAgICBsZXQgb3V0bGV0ID0gdGhpcy5maW5kT3V0bGV0KG91dGxldEtleSk7XG5cbiAgICAgICAgY29uc3QgcGFyZW50T3V0bGV0TmFtZSA9IGN1cnJlbnRUcmVlLm91dGxldCB8fCAnJztcbiAgICAgICAgY29uc3QgcGFyZW50T3V0bGV0UGF0aCA9IHRoaXMuZ2V0U2VnbWVudEdyb3VwRnVsbFBhdGgoY3VycmVudFRyZWUucGFyZW50KTtcbiAgICAgICAgY29uc3QgcGFyZW50T3V0bGV0S2V5ID0gdGhpcy5nZXRPdXRsZXRLZXkocGFyZW50T3V0bGV0UGF0aCwgcGFyZW50T3V0bGV0TmFtZSk7XG4gICAgICAgIGNvbnN0IHBhcmVudE91dGxldCA9IHRoaXMuZmluZE91dGxldChwYXJlbnRPdXRsZXRLZXkpO1xuXG4gICAgICAgIGNvbnN0IGNvbnRhaW5zTGFzdFN0YXRlID0gb3V0bGV0ICYmIG91dGxldC5jb250YWluc1RvcFN0YXRlKGN1cnJlbnRTZWdtZW50R3JvdXAudG9TdHJpbmcoKSk7XG4gICAgICAgIGlmICghb3V0bGV0KSB7XG4gICAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm1heC1saW5lLWxlbmd0aFxuICAgICAgICAgIG91dGxldCA9IHRoaXMuY3JlYXRlT3V0bGV0KG91dGxldEtleSwgb3V0bGV0UGF0aCwgY3VycmVudFNlZ21lbnRHcm91cCwgcGFyZW50T3V0bGV0LCB0aGlzLl9tb2RhbE5hdmlnYXRpb25EZXB0aCwgdGhpcy5jdXJyZW50VXJsVHJlZS5xdWVyeVBhcmFtcyk7XG4gICAgICAgICAgdGhpcy5jdXJyZW50T3V0bGV0ID0gb3V0bGV0O1xuICAgICAgICB9IGVsc2UgaWYgKHRoaXMuX21vZGFsTmF2aWdhdGlvbkRlcHRoID4gMCAmJiBvdXRsZXQuc2hvd2luZ01vZGFsICYmICFjb250YWluc0xhc3RTdGF0ZSkge1xuICAgICAgICAgIC8vIE5hdmlnYXRpb24gaW5zaWRlIG1vZGFsIHZpZXcuXG4gICAgICAgICAgdGhpcy51cHNlcnRNb2RhbE91dGxldChvdXRsZXQsIGN1cnJlbnRTZWdtZW50R3JvdXAsIHRoaXMuY3VycmVudFVybFRyZWUucXVlcnlQYXJhbXMsIHJlcGxhY2UpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIG91dGxldC5wYXJlbnQgPSBwYXJlbnRPdXRsZXQ7XG5cbiAgICAgICAgICBpZiAodGhpcy51cGRhdGVTdGF0ZXMob3V0bGV0LCBjdXJyZW50U2VnbWVudEdyb3VwLCB0aGlzLmN1cnJlbnRVcmxUcmVlLnF1ZXJ5UGFyYW1zLCByZXBsYWNlKSkge1xuICAgICAgICAgICAgdGhpcy5jdXJyZW50T3V0bGV0ID0gb3V0bGV0OyAvLyBJZiBzdGF0ZXMgdXBkYXRlZFxuICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHF1ZXVlLnB1c2goY3VycmVudFNlZ21lbnRHcm91cCk7XG4gICAgICB9KTtcblxuICAgICAgY3VycmVudFRyZWUgPSBxdWV1ZS5zaGlmdCgpO1xuICAgIH1cbiAgfVxuXG4gIHJlcGxhY2VTdGF0ZShzdGF0ZTogYW55LCB0aXRsZTogc3RyaW5nLCB1cmw6IHN0cmluZywgcXVlcnlQYXJhbXM6IHN0cmluZyk6IHZvaWQge1xuICAgIGNvbnN0IHN0YXRlcyA9IHRoaXMuY3VycmVudE91dGxldCAmJiB0aGlzLmN1cnJlbnRPdXRsZXQuc3RhdGVzO1xuXG4gICAgaWYgKHN0YXRlcyAmJiBzdGF0ZXMubGVuZ3RoID4gMCkge1xuICAgICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmlzTG9nRW5hYmxlZCgpKSB7XG4gICAgICAgIE5hdGl2ZVNjcmlwdERlYnVnLnJvdXRlckxvZygnTlNMb2NhdGlvblN0cmF0ZWd5LnJlcGxhY2VTdGF0ZSBjaGFuZ2luZyBleGlzdGluZyBzdGF0ZTogJyArIGAke3N0YXRlfSwgdGl0bGU6ICR7dGl0bGV9LCB1cmw6ICR7dXJsfSwgcXVlcnlQYXJhbXM6ICR7cXVlcnlQYXJhbXN9YCk7XG4gICAgICB9XG4gICAgICB0aGlzLnB1c2hTdGF0ZUludGVybmFsKHN0YXRlLCB0aXRsZSwgdXJsLCBxdWVyeVBhcmFtcywgdHJ1ZSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuICAgICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yb3V0ZXJMb2coJ05TTG9jYXRpb25TdHJhdGVneS5yZXBsYWNlU3RhdGUgcHVzaGluZyBuZXcgc3RhdGU6ICcgKyBgJHtzdGF0ZX0sIHRpdGxlOiAke3RpdGxlfSwgdXJsOiAke3VybH0sIHF1ZXJ5UGFyYW1zOiAke3F1ZXJ5UGFyYW1zfWApO1xuICAgICAgfVxuICAgICAgdGhpcy5wdXNoU3RhdGVJbnRlcm5hbChzdGF0ZSwgdGl0bGUsIHVybCwgcXVlcnlQYXJhbXMpO1xuICAgIH1cbiAgfVxuXG4gIGZvcndhcmQoKTogdm9pZCB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdOU0xvY2F0aW9uU3RyYXRlZ3kuZm9yd2FyZCgpIC0gbm90IGltcGxlbWVudGVkJyk7XG4gIH1cblxuICBiYWNrKG91dGxldD86IE91dGxldCwgZnJhbWU/OiBGcmFtZSk6IHZvaWQge1xuICAgIHRoaXMuY3VycmVudE91dGxldCA9IG91dGxldCB8fCB0aGlzLmN1cnJlbnRPdXRsZXQ7XG5cbiAgICBpZiAodGhpcy5jdXJyZW50T3V0bGV0LmlzUGFnZU5hdmlnYXRpb25CYWNrKSB7XG4gICAgICBjb25zdCBzdGF0ZXMgPSB0aGlzLmN1cnJlbnRPdXRsZXQuc3RhdGVzO1xuICAgICAgLy8gV2UgYXJlIG5hdmlnYXRpbmcgdG8gdGhlIHByZXZpb3VzIHBhZ2VcbiAgICAgIC8vIGNsZWFyIHRoZSBzdGFjayB1bnRpbCB3ZSBnZXQgdG8gYSBwYWdlIG5hdmlnYXRpb24gc3RhdGVcbiAgICAgIGxldCBzdGF0ZSA9IHN0YXRlcy5wb3AoKTtcbiAgICAgIGxldCBjb3VudCA9IDE7XG5cbiAgICAgIGlmIChmcmFtZSkge1xuICAgICAgICB3aGlsZSAoc3RhdGUuZnJhbWUgJiYgc3RhdGUuZnJhbWUgIT09IGZyYW1lKSB7XG4gICAgICAgICAgc3RhdGUgPSBzdGF0ZXMucG9wKCk7XG4gICAgICAgICAgY291bnQrKztcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICB3aGlsZSAoIXN0YXRlLmlzUGFnZU5hdmlnYXRpb24pIHtcbiAgICAgICAgc3RhdGUgPSBzdGF0ZXMucG9wKCk7XG4gICAgICAgIGNvdW50Kys7XG4gICAgICB9XG5cbiAgICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuICAgICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yb3V0ZXJMb2coYE5TTG9jYXRpb25TdHJhdGVneS5iYWNrKCkgd2hpbGUgbmF2aWdhdGluZyBiYWNrLiBTdGF0ZXMgcG9wcGVkOiAke2NvdW50fWApO1xuICAgICAgfVxuICAgICAgdGhpcy5jYWxsUG9wU3RhdGUoc3RhdGUsIHRydWUpO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCBzdGF0ZSA9IHRoaXMuY3VycmVudE91dGxldC5wZWVrU3RhdGUoKTtcbiAgICAgIGlmIChzdGF0ZSAmJiBzdGF0ZS5pc1BhZ2VOYXZpZ2F0aW9uKSB7XG4gICAgICAgIC8vIFRoaXMgd2FzIGEgcGFnZSBuYXZpZ2F0aW9uIC0gc28gbmF2aWdhdGUgdGhyb3VnaCBmcmFtZS5cbiAgICAgICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmlzTG9nRW5hYmxlZCgpKSB7XG4gICAgICAgICAgTmF0aXZlU2NyaXB0RGVidWcucm91dGVyTG9nKCdOU0xvY2F0aW9uU3RyYXRlZ3kuYmFjaygpIHdoaWxlIG5vdCBuYXZpZ2F0aW5nIGJhY2sgYnV0IHRvcCcgKyAnIHN0YXRlIGlzIHBhZ2UgLSB3aWxsIGNhbGwgZnJhbWUuZ29CYWNrKCknKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghb3V0bGV0KSB7XG4gICAgICAgICAgY29uc3QgdG9wbW9zdEZyYW1lID0gdGhpcy5mcmFtZVNlcnZpY2UuZ2V0RnJhbWUoKTtcbiAgICAgICAgICB0aGlzLmN1cnJlbnRPdXRsZXQgPSB0aGlzLmdldE91dGxldEJ5RnJhbWUodG9wbW9zdEZyYW1lKSB8fCB0aGlzLmN1cnJlbnRPdXRsZXQ7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBmcmFtZVRvQmFjazogRnJhbWUgPSB0aGlzLmN1cnJlbnRPdXRsZXQuZ2V0RnJhbWVUb0JhY2soKTtcbiAgICAgICAgaWYgKGZyYW1lVG9CYWNrKSB7XG4gICAgICAgICAgZnJhbWVUb0JhY2suZ29CYWNrKCk7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIC8vIE5lc3RlZCBuYXZpZ2F0aW9uIC0ganVzdCBwb3AgdGhlIHN0YXRlXG4gICAgICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuICAgICAgICAgIE5hdGl2ZVNjcmlwdERlYnVnLnJvdXRlckxvZygnTlNMb2NhdGlvblN0cmF0ZWd5LmJhY2soKSB3aGlsZSBub3QgbmF2aWdhdGluZyBiYWNrIGJ1dCB0b3AnICsgJyBzdGF0ZSBpcyBub3QgcGFnZSAtIGp1c3QgcG9wJyk7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLmNhbGxQb3BTdGF0ZSh0aGlzLmN1cnJlbnRPdXRsZXQuc3RhdGVzLnBvcCgpLCB0cnVlKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBjYW5Hb0JhY2sob3V0bGV0PzogT3V0bGV0KSB7XG4gICAgb3V0bGV0ID0gb3V0bGV0IHx8IHRoaXMuY3VycmVudE91dGxldDtcbiAgICByZXR1cm4gb3V0bGV0LnN0YXRlcy5sZW5ndGggPiAxO1xuICB9XG5cbiAgb25Qb3BTdGF0ZShmbjogKF86IGFueSkgPT4gYW55KTogdm9pZCB7XG4gICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmlzTG9nRW5hYmxlZCgpKSB7XG4gICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yb3V0ZXJMb2coJ05TTG9jYXRpb25TdHJhdGVneS5vblBvcFN0YXRlJyk7XG4gICAgfVxuICAgIHRoaXMucG9wU3RhdGVDYWxsYmFja3MucHVzaChmbik7XG4gIH1cblxuICBnZXRCYXNlSHJlZigpOiBzdHJpbmcge1xuICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuICAgICAgTmF0aXZlU2NyaXB0RGVidWcucm91dGVyTG9nKCdOU0xvY2F0aW9uU3RyYXRlZ3kuZ2V0QmFzZUhyZWYoKScpO1xuICAgIH1cbiAgICByZXR1cm4gJyc7XG4gIH1cblxuICBwcml2YXRlIGNhbGxQb3BTdGF0ZShzdGF0ZTogTG9jYXRpb25TdGF0ZSwgcG9wOiBib29sZWFuID0gdHJ1ZSwgb3V0bGV0PzogT3V0bGV0KSB7XG4gICAgb3V0bGV0ID0gb3V0bGV0IHx8IHRoaXMuY3VycmVudE91dGxldDtcbiAgICBjb25zdCB1cmxTZXJpYWxpemVyID0gbmV3IERlZmF1bHRVcmxTZXJpYWxpemVyKCk7XG4gICAgY29uc3QgY2hhbmdlZE91dGxldCA9IHRoaXMuZ2V0U2VnbWVudEdyb3VwQnlPdXRsZXQob3V0bGV0KTtcblxuICAgIGlmIChzdGF0ZSAmJiBjaGFuZ2VkT3V0bGV0KSB7XG4gICAgICB0aGlzLnVwZGF0ZVNlZ21lbnRHcm91cCh0aGlzLmN1cnJlbnRVcmxUcmVlLnJvb3QsIGNoYW5nZWRPdXRsZXQsIHN0YXRlLnNlZ21lbnRHcm91cCk7XG4gICAgfSBlbHNlIGlmIChjaGFuZ2VkT3V0bGV0KSB7XG4gICAgICAvLyB3aGVuIGNsb3NpbmcgbW9kYWwgdmlldyB0aGVyZSBhcmUgc2NlbmFyaW9zIChlLmcuIHJvb3Qgdmlld0NvbnRhaW5lclJlZikgd2hlbiB3ZSBuZWVkXG4gICAgICAvLyB0byBjbGVhbiB1cCB0aGUgbmFtZWQgcGFnZSByb3V0ZXIgb3V0bGV0IHRvIG1ha2Ugc3VyZSB3ZSB3aWxsIG9wZW4gdGhlIG1vZGFsIHByb3Blcmx5IGFnYWluIGlmIG5lZWRlZC5cbiAgICAgIHRoaXMudXBkYXRlU2VnbWVudEdyb3VwKHRoaXMuY3VycmVudFVybFRyZWUucm9vdCwgY2hhbmdlZE91dGxldCwgbnVsbCk7XG4gICAgfVxuXG4gICAgY29uc3QgdXJsID0gdXJsU2VyaWFsaXplci5zZXJpYWxpemUodGhpcy5jdXJyZW50VXJsVHJlZSk7XG4gICAgY29uc3QgY2hhbmdlOiBMb2NhdGlvbkNoYW5nZUV2ZW50ID0geyBzdGF0ZSwgdHlwZTogJ3BvcHN0YXRlJyB9O1xuICAgIGZvciAoY29uc3QgZm4gb2YgdGhpcy5wb3BTdGF0ZUNhbGxiYWNrcykge1xuICAgICAgZm4oY2hhbmdlKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgdG9TdHJpbmcoKSB7XG4gICAgbGV0IHJlc3VsdCA9IFtdO1xuXG4gICAgdGhpcy5vdXRsZXRzLmZvckVhY2goKG91dGxldCkgPT4ge1xuICAgICAgY29uc3Qgb3V0bGV0U3RhdGVzID0gb3V0bGV0LnN0YXRlcztcbiAgICAgIGNvbnN0IG91dGxldExvZyA9IG91dGxldFN0YXRlc1xuICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bWF4LWxpbmUtbGVuZ3RoXG4gICAgICAgIC5tYXAoKHYsIGkpID0+IGAke291dGxldC5vdXRsZXRLZXlzfS4ke2l9Llske3YuaXNQYWdlTmF2aWdhdGlvbiA/ICdQQUdFJyA6ICdJTlRFUk5BTCd9XS5bJHtvdXRsZXQubW9kYWxOYXZpZ2F0aW9uRGVwdGggPyAnTU9EQUwnIDogJ0JBU0UnfV0gXCIke3Yuc2VnbWVudEdyb3VwLnRvU3RyaW5nKCl9XCJgKVxuICAgICAgICAucmV2ZXJzZSgpO1xuXG4gICAgICByZXN1bHQgPSByZXN1bHQuY29uY2F0KG91dGxldExvZyk7XG4gICAgfSk7XG5cbiAgICByZXR1cm4gcmVzdWx0LmpvaW4oJ1xcbicpO1xuICB9XG5cbiAgLy8gTWV0aG9kcyBmb3Igc3luY2luZyB3aXRoIHBhZ2UgbmF2aWdhdGlvbiBpbiBQYWdlUm91dGVyT3V0bGV0XG4gIHB1YmxpYyBfYmVnaW5CYWNrUGFnZU5hdmlnYXRpb24oZnJhbWU6IEZyYW1lLCBvdXRsZXRLZXk6IHN0cmluZykge1xuICAgIGNvbnN0IG91dGxldDogT3V0bGV0ID0gdGhpcy5nZXRPdXRsZXRCeUZyYW1lKGZyYW1lKTtcblxuICAgIGlmICghb3V0bGV0IHx8IG91dGxldC5pc1BhZ2VOYXZpZ2F0aW9uQmFjaykge1xuICAgICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmlzTG9nRW5hYmxlZCgpKSB7XG4gICAgICAgIE5hdGl2ZVNjcmlwdERlYnVnLnJvdXRlckVycm9yKCdBdHRlbXB0ZWQgdG8gY2FsbCBzdGFydEdvQmFjayB3aGlsZSBnb2luZyBiYWNrLicpO1xuICAgICAgfVxuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuICAgICAgTmF0aXZlU2NyaXB0RGVidWcucm91dGVyTG9nKCdOU0xvY2F0aW9uU3RyYXRlZ3kuc3RhcnRHb0JhY2soKScpO1xuICAgIH1cbiAgICBvdXRsZXQuc2V0T3V0bGV0S2V5TmF2aWdhdGluZ0JhY2sob3V0bGV0S2V5KTtcbiAgICAvLyBvdXRsZXQuaXNQYWdlTmF2aWdhdGlvbkJhY2sgPSB0cnVlO1xuICAgIC8vIHdlIGZpbmQgYWxsIHRoZSBjaGlsZHJlbiBhbmQgYWxzbyBzZXQgdGhlaXIgaXNQYWdlTmF2aWdhdGlvbkJhY2tcbiAgICB0aGlzLm91dGxldHNcbiAgICAgIC5maWx0ZXIoKG8pID0+IHtcbiAgICAgICAgbGV0IHBhcmVudCA9IG8ucGFyZW50O1xuICAgICAgICB3aGlsZSAocGFyZW50KSB7XG4gICAgICAgICAgaWYgKHBhcmVudCA9PT0gb3V0bGV0KSB7XG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICB9XG4gICAgICAgICAgcGFyZW50ID0gcGFyZW50LnBhcmVudDtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICB9KVxuICAgICAgLmZvckVhY2goKG8pID0+IChvLmlzUGFnZU5hdmlnYXRpb25CYWNrID0gdHJ1ZSkpO1xuXG4gICAgdGhpcy5jdXJyZW50T3V0bGV0ID0gb3V0bGV0O1xuICB9XG5cbiAgcHVibGljIF9maW5pc2hCYWNrUGFnZU5hdmlnYXRpb24oZnJhbWU6IEZyYW1lKSB7XG4gICAgY29uc3Qgb3V0bGV0OiBPdXRsZXQgPSB0aGlzLmdldE91dGxldEJ5RnJhbWUoZnJhbWUpO1xuXG4gICAgaWYgKCFvdXRsZXQgfHwgIW91dGxldC5pc1BhZ2VOYXZpZ2F0aW9uQmFjaykge1xuICAgICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmlzTG9nRW5hYmxlZCgpKSB7XG4gICAgICAgIE5hdGl2ZVNjcmlwdERlYnVnLnJvdXRlckVycm9yKCdBdHRlbXB0ZWQgdG8gY2FsbCBlbmRHb0JhY2sgd2hpbGUgbm90IGdvaW5nIGJhY2suJyk7XG4gICAgICB9XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmlzTG9nRW5hYmxlZCgpKSB7XG4gICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yb3V0ZXJMb2coJ05TTG9jYXRpb25TdHJhdGVneS5maW5pc2hCYWNrUGFnZU5hdmlnYXRpb24oKScpO1xuICAgIH1cbiAgICBvdXRsZXQuaXNQYWdlTmF2aWdhdGlvbkJhY2sgPSBmYWxzZTtcbiAgfVxuXG4gIHB1YmxpYyBfYmVnaW5Nb2RhbE5hdmlnYXRpb24oZnJhbWU6IEZyYW1lKTogdm9pZCB7XG4gICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmlzTG9nRW5hYmxlZCgpKSB7XG4gICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yb3V0ZXJMb2coJ05TTG9jYXRpb25TdHJhdGVneS5fYmVnaW5Nb2RhbE5hdmlnYXRpb24oKScpO1xuICAgIH1cblxuICAgIHRoaXMuY3VycmVudE91dGxldCA9IHRoaXMuZ2V0T3V0bGV0QnlGcmFtZShmcmFtZSkgfHwgdGhpcy5jdXJyZW50T3V0bGV0O1xuXG4gICAgLy8gSXQgaXMgcG9zc2libGUgdG8gaGF2ZSBmcmFtZSwgYnV0IG5vdCBjb3JyZXNwb25kaW5nIE91dGxldCwgaWZcbiAgICAvLyBzaG93aW5nIG1vZGFsIGRpYWxvZyBvbiBhcHAuY29tcG9uZW50LnRzIG5nT25Jbml0KCkgZS5nLiBJbiB0aGF0IGNhc2VcbiAgICAvLyB0aGUgbW9kYWwgaXMgdHJlYXRlZCBhcyBub25lIG1vZGFsIG5hdmlnYXRpb24uXG4gICAgaWYgKHRoaXMuY3VycmVudE91dGxldCkge1xuICAgICAgdGhpcy5jdXJyZW50T3V0bGV0LnNob3dpbmdNb2RhbCA9IHRydWU7XG4gICAgICB0aGlzLl9tb2RhbE5hdmlnYXRpb25EZXB0aCsrO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBfY2xvc2VNb2RhbE5hdmlnYXRpb24oKSB7XG4gICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmlzTG9nRW5hYmxlZCgpKSB7XG4gICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yb3V0ZXJMb2coJ05TTG9jYXRpb25TdHJhdGVneS5jbG9zZU1vZGFsTmF2aWdhdGlvbigpJyk7XG4gICAgfVxuXG4gICAgY29uc3QgaXNTaG93aW5nTW9kYWwgPSB0aGlzLl9tb2RhbE5hdmlnYXRpb25EZXB0aCA+IDA7XG5cbiAgICBpZiAoaXNTaG93aW5nTW9kYWwpIHtcbiAgICAgIHRoaXMuX21vZGFsTmF2aWdhdGlvbkRlcHRoLS07XG4gICAgfVxuXG4gICAgLy8gY3VycmVudE91dGxldCBzaG91bGQgYmUgdGhlIG9uZSB0aGF0IGNvcnJlc3BvbmRzIHRvIHRoZSB0b3Btb3N0IGZyYW1lXG4gICAgY29uc3QgdG9wbW9zdE91dGxldCA9IHRoaXMuZ2V0T3V0bGV0QnlGcmFtZSh0aGlzLmZyYW1lU2VydmljZS5nZXRGcmFtZSgpKTtcbiAgICBjb25zdCBvdXRsZXQgPSB0aGlzLmZpbmRPdXRsZXRCeU1vZGFsKHRoaXMuX21vZGFsTmF2aWdhdGlvbkRlcHRoLCBpc1Nob3dpbmdNb2RhbCkgfHwgdG9wbW9zdE91dGxldDtcblxuICAgIGlmIChvdXRsZXQpIHtcbiAgICAgIHRoaXMuY3VycmVudE91dGxldCA9IG91dGxldDtcbiAgICAgIHRoaXMuY3VycmVudE91dGxldC5zaG93aW5nTW9kYWwgPSBmYWxzZTtcbiAgICAgIHRoaXMuY2FsbFBvcFN0YXRlKHRoaXMuY3VycmVudE91dGxldC5wZWVrU3RhdGUoKSwgZmFsc2UpO1xuICAgICAgLy8gdGhpcyBpcyBuZWVkZWQgYmVjYXVzZSBhbmd1bGFyIGRvZXMgYSBzZXRUaW1lb3V0IG9uIG9uUG9wU3RhdGUsIHNvIGlmIHdlIGRvbid0IGRvIHRoaXMgd2UgbWlnaHQgZW5kIHVwIHdpdGggaW5jb25zaXN0ZW50IHN0YXRlXG4gICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHNldFRpbWVvdXQocmVzb2x2ZSwgMCkpO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBfYmVnaW5QYWdlTmF2aWdhdGlvbihmcmFtZTogRnJhbWUsIG9wdGlvbnM/OiBOYXZpZ2F0aW9uT3B0aW9ucyk6IE5hdmlnYXRpb25PcHRpb25zIHtcbiAgICBpZiAoTmF0aXZlU2NyaXB0RGVidWcuaXNMb2dFbmFibGVkKCkpIHtcbiAgICAgIE5hdGl2ZVNjcmlwdERlYnVnLnJvdXRlckxvZygnTlNMb2NhdGlvblN0cmF0ZWd5Ll9iZWdpblBhZ2VOYXZpZ2F0aW9uKCknKTtcbiAgICB9XG5cbiAgICB0aGlzLmN1cnJlbnRPdXRsZXQgPSB0aGlzLmdldE91dGxldEJ5RnJhbWUoZnJhbWUpIHx8IHRoaXMuY3VycmVudE91dGxldDtcbiAgICBjb25zdCBsYXN0U3RhdGUgPSB0aGlzLmN1cnJlbnRPdXRsZXQucGVla1N0YXRlKCk7XG5cbiAgICBpZiAobGFzdFN0YXRlKSB7XG4gICAgICBsYXN0U3RhdGUuaXNQYWdlTmF2aWdhdGlvbiA9IHRydWU7XG4gICAgfVxuXG4gICAgY29uc3QgbmF2T3B0aW9ucyA9IG9wdGlvbnMgfHwgZGVmYXVsdE5hdk9wdGlvbnM7XG5cbiAgICBpZiAobmF2T3B0aW9ucy5jbGVhckhpc3RvcnkpIHtcbiAgICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuICAgICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yb3V0ZXJMb2coJ05TTG9jYXRpb25TdHJhdGVneS5fYmVnaW5QYWdlTmF2aWdhdGlvbiBjbGVhcmluZyBzdGF0ZXMgaGlzdG9yeScpO1xuICAgICAgfVxuICAgICAgdGhpcy5jdXJyZW50T3V0bGV0LnN0YXRlcyA9IFtsYXN0U3RhdGVdO1xuICAgIH1cbiAgICByZXR1cm4gbmF2T3B0aW9ucztcbiAgfVxuXG4gIHB1YmxpYyBfZ2V0T3V0bGV0cygpOiBBcnJheTxPdXRsZXQ+IHtcbiAgICByZXR1cm4gdGhpcy5vdXRsZXRzO1xuICB9XG5cbiAgdXBkYXRlT3V0bGV0RnJhbWUob3V0bGV0OiBPdXRsZXQsIGZyYW1lOiBGcmFtZSwgaXNFbXB0eU91dGxldEZyYW1lOiBib29sZWFuKSB7XG4gICAgY29uc3QgbGFzdFN0YXRlID0gb3V0bGV0LnBlZWtTdGF0ZSgpO1xuXG4gICAgaWYgKGxhc3RTdGF0ZSAmJiAhbGFzdFN0YXRlLmZyYW1lICYmICFpc0VtcHR5T3V0bGV0RnJhbWUpIHtcbiAgICAgIGxhc3RTdGF0ZS5mcmFtZSA9IGZyYW1lO1xuICAgIH1cblxuICAgIGlmICghb3V0bGV0LmNvbnRhaW5zRnJhbWUoZnJhbWUpKSB7XG4gICAgICBvdXRsZXQuZnJhbWVzLnB1c2goZnJhbWUpO1xuICAgIH1cbiAgICB0aGlzLmN1cnJlbnRPdXRsZXQgPSBvdXRsZXQ7XG4gIH1cblxuICBjbGVhck91dGxldChmcmFtZTogRnJhbWUpIHtcbiAgICB0aGlzLm91dGxldHMgPSB0aGlzLm91dGxldHMuZmlsdGVyKChjdXJyZW50T3V0bGV0KSA9PiB7XG4gICAgICBsZXQgaXNFcXVhbFRvQ3VycmVudDtcblxuICAgICAgaWYgKHRoaXMuY3VycmVudE91dGxldCkge1xuICAgICAgICBpc0VxdWFsVG9DdXJyZW50ID0gY3VycmVudE91dGxldC5wYXRoQnlPdXRsZXRzID09PSB0aGlzLmN1cnJlbnRPdXRsZXQucGF0aEJ5T3V0bGV0cztcbiAgICAgIH1cblxuICAgICAgLy8gUmVtb3ZlIG91dGxldCBmcm9tIHRoZSB1cmwgdHJlZS5cbiAgICAgIGlmIChjdXJyZW50T3V0bGV0LmNvbnRhaW5zRnJhbWUoZnJhbWUpICYmICFpc0VxdWFsVG9DdXJyZW50KSB7XG4gICAgICAgIHRoaXMuY2FsbFBvcFN0YXRlKG51bGwsIHRydWUsIGN1cnJlbnRPdXRsZXQpO1xuICAgICAgfVxuXG4gICAgICAvLyBTa2lwIGZyYW1lcyBmaWx0ZXJpbmcgc2luY2UgY3VycmVudE91dGxldCBpcyA8cm91dGVyLW91dGxldD4gd2hlbiBubyBmcmFtZXMgYXZhaWxhYmxlLlxuICAgICAgaWYgKGN1cnJlbnRPdXRsZXQuZnJhbWVzLmxlbmd0aCAmJiAhY3VycmVudE91dGxldC5pc05TRW1wdHlPdXRsZXQpIHtcbiAgICAgICAgY3VycmVudE91dGxldC5mcmFtZXMgPSBjdXJyZW50T3V0bGV0LmZyYW1lcy5maWx0ZXIoKGN1cnJlbnRGcmFtZSkgPT4gY3VycmVudEZyYW1lICE9PSBmcmFtZSk7XG4gICAgICAgIHJldHVybiBjdXJyZW50T3V0bGV0LmZyYW1lcy5sZW5ndGg7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiAhY3VycmVudE91dGxldC5jb250YWluc0ZyYW1lKGZyYW1lKTtcbiAgICB9KTtcbiAgfVxuXG4gIGdldFNlZ21lbnRHcm91cEZ1bGxQYXRoKHNlZ21lbnRHcm91cDogVXJsU2VnbWVudEdyb3VwKTogc3RyaW5nIHtcbiAgICBsZXQgZnVsbFBhdGggPSAnJztcblxuICAgIHdoaWxlIChzZWdtZW50R3JvdXApIHtcbiAgICAgIGNvbnN0IHVybCA9IHNlZ21lbnRHcm91cC50b1N0cmluZygpO1xuXG4gICAgICBpZiAoZnVsbFBhdGgpIHtcbiAgICAgICAgZnVsbFBhdGggPSAodXJsID8gdXJsICsgJy8nIDogJycpICsgZnVsbFBhdGg7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBmdWxsUGF0aCA9IHVybDtcbiAgICAgIH1cblxuICAgICAgc2VnbWVudEdyb3VwID0gc2VnbWVudEdyb3VwLnBhcmVudDtcbiAgICB9XG5cbiAgICByZXR1cm4gZnVsbFBhdGg7XG4gIH1cblxuICBnZXRSb3V0ZUZ1bGxQYXRoKGN1cnJlbnRSb3V0ZTogYW55KTogc3RyaW5nIHtcbiAgICBjb25zdCBvdXRsZXROYW1lID0gY3VycmVudFJvdXRlLm91dGxldDtcbiAgICBsZXQgZnVsbFBhdGg7XG5cbiAgICBjdXJyZW50Um91dGUgPSBjdXJyZW50Um91dGUucGFyZW50O1xuICAgIHdoaWxlIChjdXJyZW50Um91dGUpIHtcbiAgICAgIGNvbnN0IHVybHMgPSBjdXJyZW50Um91dGUudXJsLnZhbHVlIHx8IGN1cnJlbnRSb3V0ZS51cmw7XG4gICAgICBsZXQgdXJsID0gdXJscztcblxuICAgICAgaWYgKEFycmF5LmlzQXJyYXkodXJscykpIHtcbiAgICAgICAgdXJsID0gdXJsLmpvaW4oJy8nKTtcbiAgICAgIH1cblxuICAgICAgZnVsbFBhdGggPSBmdWxsUGF0aCA/ICh1cmwgPyB1cmwgKyAnLycgOiB1cmwpICsgZnVsbFBhdGggOiB1cmw7XG4gICAgICBjdXJyZW50Um91dGUgPSBjdXJyZW50Um91dGUucGFyZW50O1xuICAgIH1cblxuICAgIHJldHVybiBmdWxsUGF0aCA/IGZ1bGxQYXRoICsgJy0nICsgb3V0bGV0TmFtZSA6IG91dGxldE5hbWU7XG4gIH1cblxuICBnZXRQYXRoQnlPdXRsZXRzKHVybFNlZ21lbnRHcm91cDogYW55KTogc3RyaW5nIHtcbiAgICBpZiAoIXVybFNlZ21lbnRHcm91cCkge1xuICAgICAgcmV0dXJuICcnO1xuICAgIH1cblxuICAgIGxldCBwYXRoVG9PdXRsZXQ7XG4gICAgbGV0IGxhc3RQYXRoID0gdXJsU2VnbWVudEdyb3VwLm91dGxldCB8fCAncHJpbWFyeSc7XG4gICAgbGV0IHBhcmVudCA9IHVybFNlZ21lbnRHcm91cC5wYXJlbnQ7XG5cbiAgICB3aGlsZSAocGFyZW50ICYmIHVybFNlZ21lbnRHcm91cC5yb290ICE9PSBwYXJlbnQpIHtcbiAgICAgIGlmIChwYXJlbnQgJiYgcGFyZW50Lm91dGxldCAhPT0gbGFzdFBhdGgpIHtcbiAgICAgICAgaWYgKGxhc3RQYXRoID09PSAncHJpbWFyeScpIHtcbiAgICAgICAgICBsYXN0UGF0aCA9IHBhcmVudC5vdXRsZXQ7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgbGFzdFBhdGggPSBwYXJlbnQub3V0bGV0O1xuICAgICAgICAgIHBhdGhUb091dGxldCA9IGxhc3RQYXRoICsgJy0nICsgKHBhdGhUb091dGxldCB8fCB1cmxTZWdtZW50R3JvdXAub3V0bGV0KTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBwYXJlbnQgPSBwYXJlbnQucGFyZW50O1xuICAgIH1cblxuICAgIHJldHVybiBwYXRoVG9PdXRsZXQgfHwgbGFzdFBhdGg7XG4gIH1cblxuICBmaW5kT3V0bGV0KG91dGxldEtleTogc3RyaW5nLCBhY3RpdmF0ZWRSb3V0ZVNuYXBzaG90PzogQWN0aXZhdGVkUm91dGVTbmFwc2hvdCk6IE91dGxldCB7XG4gICAgbGV0IG91dGxldDogT3V0bGV0ID0gdGhpcy5vdXRsZXRzLmZpbmQoKGN1cnJlbnRPdXRsZXQpID0+IHtcbiAgICAgIGNvbnN0IGVxdWFsTW9kYWxEZXB0aCA9IGN1cnJlbnRPdXRsZXQubW9kYWxOYXZpZ2F0aW9uRGVwdGggPT09IHRoaXMuX21vZGFsTmF2aWdhdGlvbkRlcHRoO1xuICAgICAgcmV0dXJuIGVxdWFsTW9kYWxEZXB0aCAmJiBjdXJyZW50T3V0bGV0Lm91dGxldEtleXMuaW5kZXhPZihvdXRsZXRLZXkpID4gLTE7XG4gICAgfSk7XG5cbiAgICAvLyBObyBPdXRsZXQgd2l0aCB0aGUgZ2l2ZW4gb3V0bGV0S2V5IGNvdWxkIGhhcHBlbiB3aGVuIHVzaW5nIG5lc3RlZCB1bm5hbWVkIHAtci1vXG4gICAgLy8gcHJpbWFyeSAtPiBwcmltYXJ5IC0+IHByeW1hcnlcbiAgICBpZiAoIW91dGxldCAmJiBhY3RpdmF0ZWRSb3V0ZVNuYXBzaG90KSB7XG4gICAgICBjb25zdCBwYXRoQnlPdXRsZXRzID0gdGhpcy5nZXRQYXRoQnlPdXRsZXRzKGFjdGl2YXRlZFJvdXRlU25hcHNob3QpO1xuICAgICAgb3V0bGV0ID0gdGhpcy5vdXRsZXRzLmZpbmQoKGN1cnJlbnRPdXRsZXQpID0+IHtcbiAgICAgICAgY29uc3QgZXF1YWxNb2RhbERlcHRoID0gY3VycmVudE91dGxldC5tb2RhbE5hdmlnYXRpb25EZXB0aCA9PT0gdGhpcy5fbW9kYWxOYXZpZ2F0aW9uRGVwdGg7XG4gICAgICAgIHJldHVybiBlcXVhbE1vZGFsRGVwdGggJiYgY3VycmVudE91dGxldC5wYXRoQnlPdXRsZXRzID09PSBwYXRoQnlPdXRsZXRzO1xuICAgICAgfSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIG91dGxldDtcbiAgfVxuXG4gIHByaXZhdGUgZmluZE91dGxldEJ5TW9kYWwobW9kYWxOYXZpZ2F0aW9uOiBudW1iZXIsIGlzU2hvd2luZ01vZGFsPzogYm9vbGVhbik6IE91dGxldCB7XG4gICAgcmV0dXJuIHRoaXMub3V0bGV0cy5maW5kKChvdXRsZXQpID0+IHtcbiAgICAgIGNvbnN0IGVxdWFsTW9kYWxEZXB0aCA9IG91dGxldC5tb2RhbE5hdmlnYXRpb25EZXB0aCA9PT0gbW9kYWxOYXZpZ2F0aW9uO1xuICAgICAgcmV0dXJuIGlzU2hvd2luZ01vZGFsID8gZXF1YWxNb2RhbERlcHRoICYmIG91dGxldC5zaG93aW5nTW9kYWwgOiBlcXVhbE1vZGFsRGVwdGg7XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIGdldE91dGxldEJ5RnJhbWUoZnJhbWU6IEZyYW1lKTogT3V0bGV0IHtcbiAgICBsZXQgb3V0bGV0O1xuXG4gICAgZm9yIChsZXQgaW5kZXggPSAwOyBpbmRleCA8IHRoaXMub3V0bGV0cy5sZW5ndGg7IGluZGV4KyspIHtcbiAgICAgIGNvbnN0IGN1cnJlbnRPdXRsZXQgPSB0aGlzLm91dGxldHNbaW5kZXhdO1xuXG4gICAgICBpZiAoY3VycmVudE91dGxldC5jb250YWluc0ZyYW1lKGZyYW1lKSkge1xuICAgICAgICBvdXRsZXQgPSBjdXJyZW50T3V0bGV0O1xuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gb3V0bGV0O1xuICB9XG5cbiAgcHJpdmF0ZSB1cGRhdGVTdGF0ZXMob3V0bGV0OiBPdXRsZXQsIGN1cnJlbnRTZWdtZW50R3JvdXA6IFVybFNlZ21lbnRHcm91cCwgcXVlcnlQYXJhbXM6IFBhcmFtcywgcmVwbGFjZSA9IGZhbHNlKTogYm9vbGVhbiB7XG4gICAgY29uc3QgaXNOZXdQYWdlID0gb3V0bGV0LnN0YXRlcy5sZW5ndGggPT09IDA7XG4gICAgY29uc3QgbGFzdFN0YXRlID0gb3V0bGV0LnN0YXRlc1tvdXRsZXQuc3RhdGVzLmxlbmd0aCAtIDFdO1xuICAgIGNvbnN0IGVxdWFsU3RhdGVVcmxzID0gb3V0bGV0LmNvbnRhaW5zVG9wU3RhdGUoY3VycmVudFNlZ21lbnRHcm91cC50b1N0cmluZygpKTtcblxuICAgIGNvbnN0IGxvY2F0aW9uU3RhdGU6IExvY2F0aW9uU3RhdGUgPSB7XG4gICAgICBzZWdtZW50R3JvdXA6IGN1cnJlbnRTZWdtZW50R3JvdXAsXG4gICAgICBpc1Jvb3RTZWdtZW50R3JvdXA6IGZhbHNlLFxuICAgICAgaXNQYWdlTmF2aWdhdGlvbjogaXNOZXdQYWdlLFxuICAgICAgcXVlcnlQYXJhbXM6IHsgLi4ucXVlcnlQYXJhbXMgfSxcbiAgICB9O1xuXG4gICAgaWYgKCFsYXN0U3RhdGUgfHwgIWVxdWFsU3RhdGVVcmxzKSB7XG4gICAgICBpZiAocmVwbGFjZSkge1xuICAgICAgICBvdXRsZXQuc3RhdGVzLnBvcCgpO1xuICAgICAgfVxuICAgICAgb3V0bGV0LnN0YXRlcy5wdXNoKGxvY2F0aW9uU3RhdGUpO1xuXG4gICAgICAvLyBVcGRhdGUgbGFzdCBzdGF0ZSBzZWdtZW50R3JvdXAgb2YgcGFyZW50IE91dGxldC5cbiAgICAgIGlmICh0aGlzLl9tb2RhbE5hdmlnYXRpb25EZXB0aCA9PT0gMCAmJiAhb3V0bGV0LnNob3dpbmdNb2RhbCkge1xuICAgICAgICB0aGlzLnVwZGF0ZVBhcmVudHNTdGF0ZXMob3V0bGV0LCBjdXJyZW50U2VnbWVudEdyb3VwLnBhcmVudCk7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH0gZWxzZSB7XG4gICAgICBpZiAobGFzdFN0YXRlICYmIGVxdWFsU3RhdGVVcmxzKSB7XG4gICAgICAgIC8vIHVwZGF0ZSBxdWVyeSBwYXJhbXMgZm9yIGxhc3Qgc3RhdGVcbiAgICAgICAgbGFzdFN0YXRlLnF1ZXJ5UGFyYW1zID0geyAuLi5xdWVyeVBhcmFtcyB9O1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG4gIHByaXZhdGUgdXBkYXRlUGFyZW50c1N0YXRlcyhvdXRsZXQ6IE91dGxldCwgbmV3U2VnbWVudEdyb3VwOiBVcmxTZWdtZW50R3JvdXApIHtcbiAgICBsZXQgcGFyZW50T3V0bGV0ID0gb3V0bGV0LnBhcmVudDtcblxuICAgIC8vIFVwZGF0ZSBwYXJlbnRzIGxhc3RTdGF0ZSBzZWdtZW50R3JvdXBzXG4gICAgd2hpbGUgKHBhcmVudE91dGxldCAmJiBuZXdTZWdtZW50R3JvdXApIHtcbiAgICAgIGNvbnN0IHN0YXRlID0gcGFyZW50T3V0bGV0LnBlZWtTdGF0ZSgpO1xuXG4gICAgICBpZiAoc3RhdGUpIHtcbiAgICAgICAgc3RhdGUuc2VnbWVudEdyb3VwID0gbmV3U2VnbWVudEdyb3VwO1xuICAgICAgICBuZXdTZWdtZW50R3JvdXAgPSBuZXdTZWdtZW50R3JvdXAucGFyZW50O1xuICAgICAgICBwYXJlbnRPdXRsZXQgPSBwYXJlbnRPdXRsZXQucGFyZW50O1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTptYXgtbGluZS1sZW5ndGhcbiAgcHJpdmF0ZSBjcmVhdGVPdXRsZXQob3V0bGV0S2V5OiBzdHJpbmcsIHBhdGg6IHN0cmluZywgc2VnbWVudEdyb3VwOiBhbnksIHBhcmVudDogT3V0bGV0LCBtb2RhbE5hdmlnYXRpb24/OiBudW1iZXIsIHF1ZXJ5UGFyYW1zOiBQYXJhbXMgPSB7fSk6IE91dGxldCB7XG4gICAgY29uc3QgcGF0aEJ5T3V0bGV0cyA9IHRoaXMuZ2V0UGF0aEJ5T3V0bGV0cyhzZWdtZW50R3JvdXApO1xuICAgIGNvbnN0IG5ld091dGxldCA9IG5ldyBPdXRsZXQob3V0bGV0S2V5LCBwYXRoLCBwYXRoQnlPdXRsZXRzLCBtb2RhbE5hdmlnYXRpb24pO1xuXG4gICAgY29uc3QgbG9jYXRpb25TdGF0ZTogTG9jYXRpb25TdGF0ZSA9IHtcbiAgICAgIHNlZ21lbnRHcm91cDogc2VnbWVudEdyb3VwLFxuICAgICAgaXNSb290U2VnbWVudEdyb3VwOiBmYWxzZSxcbiAgICAgIGlzUGFnZU5hdmlnYXRpb246IHRydWUsIC8vIEl0IGlzIGEgbmV3IE91dGxldE5vZGUuXG4gICAgICBxdWVyeVBhcmFtczogeyAuLi5xdWVyeVBhcmFtcyB9LFxuICAgIH07XG5cbiAgICBuZXdPdXRsZXQuc3RhdGVzID0gW2xvY2F0aW9uU3RhdGVdO1xuICAgIG5ld091dGxldC5wYXJlbnQgPSBwYXJlbnQ7XG4gICAgdGhpcy5vdXRsZXRzLnB1c2gobmV3T3V0bGV0KTtcblxuICAgIC8vIFVwZGF0ZSBsYXN0IHN0YXRlIHNlZ21lbnRHcm91cCBvZiBwYXJlbnQgT3V0bGV0LlxuICAgIGlmICh0aGlzLl9tb2RhbE5hdmlnYXRpb25EZXB0aCA9PT0gMCAmJiAhbmV3T3V0bGV0LnNob3dpbmdNb2RhbCkge1xuICAgICAgdGhpcy51cGRhdGVQYXJlbnRzU3RhdGVzKG5ld091dGxldCwgc2VnbWVudEdyb3VwLnBhcmVudCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIG5ld091dGxldDtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0U2VnbWVudEdyb3VwQnlPdXRsZXQob3V0bGV0OiBPdXRsZXQpOiBVcmxTZWdtZW50R3JvdXAge1xuICAgIGNvbnN0IHBhdGhMaXN0ID0gb3V0bGV0LnBhdGhCeU91dGxldHMuc3BsaXQoJy0nKTtcbiAgICBsZXQgc2VnbWVudEdyb3VwID0gdGhpcy5jdXJyZW50VXJsVHJlZS5yb290O1xuICAgIGxldCBwYXRoVG9PdXRsZXQ7XG5cbiAgICBmb3IgKGxldCBpbmRleCA9IDA7IGluZGV4IDwgcGF0aExpc3QubGVuZ3RoOyBpbmRleCsrKSB7XG4gICAgICBjb25zdCBjdXJyZW50UGF0aCA9IHBhdGhMaXN0W2luZGV4XTtcbiAgICAgIGNvbnN0IGNoaWxkcmVuQ291bnQgPSBPYmplY3Qua2V5cyhzZWdtZW50R3JvdXAuY2hpbGRyZW4pLmxlbmd0aDtcblxuICAgICAgaWYgKGNoaWxkcmVuQ291bnQgJiYgc2VnbWVudEdyb3VwLmNoaWxkcmVuW2N1cnJlbnRQYXRoXSkge1xuICAgICAgICBjb25zdCB1cmwgPSBzZWdtZW50R3JvdXAudG9TdHJpbmcoKTtcbiAgICAgICAgcGF0aFRvT3V0bGV0ID0gcGF0aFRvT3V0bGV0ID8gcGF0aFRvT3V0bGV0ICsgJy8nICsgdXJsIDogdXJsO1xuICAgICAgICBzZWdtZW50R3JvdXAgPSBzZWdtZW50R3JvdXAuY2hpbGRyZW5bY3VycmVudFBhdGhdO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgLy8gSWYgbm8gY2hpbGQgb3V0bGV0IGZvdW5kIHdpdGggdGhlIGdpdmVuIG5hbWUgLSBmb3JnZXQgYWJvdXQgYWxsIHByZXZpb3VzbHkgZm91bmQgb3V0bGV0cy5cbiAgICAgICAgLy8gZXhhbXBsZTogc2VhY2hpbmcgZm9yICdwcmltYXJ5LXNlY29uZC1wcmltYXJ5JyBzaG91bGRuJ3QgcmV0dXJuICdwcmltYXJ5LXNlY29uZCdcbiAgICAgICAgLy8gaWYgbm8gJ3ByaW1hcnknIGNoaWxkIGF2YWlsYWJsZSBvbiAnc2Vjb25kJy5cbiAgICAgICAgc2VnbWVudEdyb3VwID0gbnVsbDtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gUGF0aHMgc2hvdWxkIGFsc28gbWF0Y2ggc2luY2UgdGhlcmUgY291bGQgYmUgYW5vdGhlciBPdXRsZXRcbiAgICAvLyB3aXRoIHRoZSBzYW1lIHBhdGhCeU91dGxldHMgYnV0IGRpZmZlcmVudCB1cmwgcGF0aC5cbiAgICBpZiAoc2VnbWVudEdyb3VwICYmIG91dGxldC5wYXRoICYmIHBhdGhUb091dGxldCAmJiBvdXRsZXQucGF0aCAhPT0gcGF0aFRvT3V0bGV0KSB7XG4gICAgICBzZWdtZW50R3JvdXAgPSBudWxsO1xuICAgIH1cblxuICAgIHJldHVybiBzZWdtZW50R3JvdXA7XG4gIH1cblxuICAvLyBUcmF2ZXJzYWwgYW5kIHJlcGxhY2VtZW50IG9mIHNlZ21lbnRHcm91cC5cbiAgcHJpdmF0ZSB1cGRhdGVTZWdtZW50R3JvdXAocm9vdE5vZGU6IGFueSwgb2xkU2VnbWVudEdyb3VwOiBVcmxTZWdtZW50R3JvdXAsIG5ld1NlZ21lbnRHcm91cDogVXJsU2VnbWVudEdyb3VwKSB7XG4gICAgY29uc3QgcXVldWUgPSBbXTtcbiAgICBsZXQgY3VycmVudFRyZWUgPSByb290Tm9kZTtcblxuICAgIHdoaWxlIChjdXJyZW50VHJlZSkge1xuICAgICAgT2JqZWN0LmtleXMoY3VycmVudFRyZWUuY2hpbGRyZW4pLmZvckVhY2goKG91dGxldE5hbWUpID0+IHtcbiAgICAgICAgaWYgKGN1cnJlbnRUcmVlLmNoaWxkcmVuW291dGxldE5hbWVdID09PSBvbGRTZWdtZW50R3JvdXApIHtcbiAgICAgICAgICBpZiAobmV3U2VnbWVudEdyb3VwKSB7XG4gICAgICAgICAgICBjdXJyZW50VHJlZS5jaGlsZHJlbltvdXRsZXROYW1lXSA9IG5ld1NlZ21lbnRHcm91cDtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgZGVsZXRlIGN1cnJlbnRUcmVlLmNoaWxkcmVuW291dGxldE5hbWVdO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBxdWV1ZS5wdXNoKGN1cnJlbnRUcmVlLmNoaWxkcmVuW291dGxldE5hbWVdKTtcbiAgICAgIH0pO1xuXG4gICAgICBjdXJyZW50VHJlZSA9IHF1ZXVlLnNoaWZ0KCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSB1cHNlcnRNb2RhbE91dGxldChwYXJlbnRPdXRsZXQ6IE91dGxldCwgc2VnbWVudGVkR3JvdXA6IFVybFNlZ21lbnRHcm91cCwgcXVlcnlQYXJhbXM6IFBhcmFtcywgcmVwbGFjZSA9IGZhbHNlKSB7XG4gICAgbGV0IGN1cnJlbnRNb2RhbE91dGxldCA9IHRoaXMuZmluZE91dGxldEJ5TW9kYWwodGhpcy5fbW9kYWxOYXZpZ2F0aW9uRGVwdGgpO1xuXG4gICAgLy8gV2Ugd2FudCB0byB0cmVhdCBldmVyeSBwLXItbyBhcyBhIHN0YW5kYWxvbmUgT3V0bGV0LlxuICAgIGlmICghY3VycmVudE1vZGFsT3V0bGV0KSB7XG4gICAgICBpZiAodGhpcy5fbW9kYWxOYXZpZ2F0aW9uRGVwdGggPiAxKSB7XG4gICAgICAgIC8vIFRoZSBwYXJlbnQgb2YgdGhlIGN1cnJlbnQgT3V0bGV0IHNob3VsZCBiZSB0aGUgcHJldmlvdXMgb3BlbmVkIG1vZGFsIChpZiBhbnkpLlxuICAgICAgICBwYXJlbnRPdXRsZXQgPSB0aGlzLmZpbmRPdXRsZXRCeU1vZGFsKHRoaXMuX21vZGFsTmF2aWdhdGlvbkRlcHRoIC0gMSk7XG4gICAgICB9XG5cbiAgICAgIC8vIE5vIGN1cnJlbnRNb2RhbE91dGxldCBhdmFpbGFibGUgd2hlbiBvcGVuaW5nICdwcmltYXJ5JyBwLXItby5cbiAgICAgIGNvbnN0IG91dGxldE5hbWUgPSAncHJpbWFyeSc7XG4gICAgICBjb25zdCBvdXRsZXRQYXRoID0gcGFyZW50T3V0bGV0LnBlZWtTdGF0ZSgpLnNlZ21lbnRHcm91cC50b1N0cmluZygpO1xuICAgICAgY29uc3Qgb3V0bGV0S2V5ID0gdGhpcy5nZXRPdXRsZXRLZXkob3V0bGV0UGF0aCwgb3V0bGV0TmFtZSk7XG4gICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bWF4LWxpbmUtbGVuZ3RoXG4gICAgICBjdXJyZW50TW9kYWxPdXRsZXQgPSB0aGlzLmNyZWF0ZU91dGxldChvdXRsZXRLZXksIG91dGxldFBhdGgsIHNlZ21lbnRlZEdyb3VwLCBwYXJlbnRPdXRsZXQsIHRoaXMuX21vZGFsTmF2aWdhdGlvbkRlcHRoLCBxdWVyeVBhcmFtcyk7XG4gICAgICB0aGlzLmN1cnJlbnRPdXRsZXQgPSBjdXJyZW50TW9kYWxPdXRsZXQ7XG4gICAgfSBlbHNlIGlmICh0aGlzLnVwZGF0ZVN0YXRlcyhjdXJyZW50TW9kYWxPdXRsZXQsIHNlZ21lbnRlZEdyb3VwLCBxdWVyeVBhcmFtcywgcmVwbGFjZSkpIHtcbiAgICAgIHRoaXMuY3VycmVudE91dGxldCA9IGN1cnJlbnRNb2RhbE91dGxldDsgLy8gSWYgc3RhdGVzIHVwZGF0ZWRcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGdldE91dGxldEtleShwYXRoOiBzdHJpbmcsIG91dGxldE5hbWU6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHBhdGggPyBwYXRoICsgJy0nICsgb3V0bGV0TmFtZSA6IG91dGxldE5hbWU7XG4gIH1cblxuICBuZ09uRGVzdHJveSgpIHtcbiAgICBpZiAoTmF0aXZlU2NyaXB0RGVidWcuaXNMb2dFbmFibGVkKCkpIHtcbiAgICAgIE5hdGl2ZVNjcmlwdERlYnVnLnJvdXRlckxvZygnTlNMb2NhdGlvblN0cmF0ZWd5Lm5nT25EZXN0cm95KCknKTtcbiAgICB9XG5cbiAgICB0aGlzLm91dGxldHMgPSBbXTtcbiAgICB0aGlzLmN1cnJlbnRPdXRsZXQgPSBudWxsO1xuICB9XG59XG4iXX0=
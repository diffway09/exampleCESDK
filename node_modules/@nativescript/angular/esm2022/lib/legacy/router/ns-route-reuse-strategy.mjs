import { Injectable } from '@angular/core';
import { NativeScriptDebug } from '../../trace';
import { NSLocationStrategy } from './ns-location-strategy';
import { destroyComponentRef, findTopActivatedRouteNodeForOutlet, pageRouterActivatedSymbol } from './page-router-outlet-utils';
import * as i0 from "@angular/core";
import * as i1 from "./ns-location-strategy";
const getSnapshotKey = function (snapshot) {
    return snapshot.pathFromRoot.join('->');
};
/**
 * Detached state cache
 */
class DetachedStateCache {
    constructor() {
        this.cache = new Array();
    }
    get length() {
        return this.cache.length;
    }
    push(cacheItem) {
        this.cache.push(cacheItem);
    }
    pop() {
        return this.cache.pop();
    }
    peek() {
        return this.cache[this.cache.length - 1];
    }
    clear() {
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routeReuseStrategyLog(`DetachedStateCache.clear() ${this.cache.length} items will be destroyed`);
        }
        while (this.cache.length > 0) {
            const state = this.cache.pop().state;
            if (!state.componentRef) {
                throw new Error('No componentRef found in DetachedRouteHandle');
            }
            destroyComponentRef(state.componentRef);
        }
    }
    markCurrentForClear() {
        for (const item of this.cache) {
            item.markedForDeletion = true;
        }
    }
    clearMarked() {
        // try to preserve same order as .clear()
        for (let i = this.cache.length - 1; i >= 0; i--) {
            const cacheItem = this.cache[i];
            if (cacheItem.markedForDeletion) {
                const state = cacheItem.state;
                if (!state.componentRef) {
                    throw new Error('No componentRef found in DetachedRouteHandle');
                }
                destroyComponentRef(state.componentRef);
                this.cache.splice(i, 1);
            }
        }
    }
    clearModalCache() {
        let removedItemsCount = 0;
        const hasModalPages = this.cache.some((cacheItem) => {
            return cacheItem.isModal;
        });
        if (hasModalPages) {
            let modalCacheCleared = false;
            while (!modalCacheCleared) {
                const cacheItem = this.peek();
                const state = cacheItem.state;
                if (!state.componentRef) {
                    throw new Error('No componentRef found in DetachedRouteHandle');
                }
                destroyComponentRef(state.componentRef);
                if (cacheItem.isModal) {
                    modalCacheCleared = true;
                }
                this.pop();
                removedItemsCount++;
            }
        }
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routeReuseStrategyLog(`DetachedStateCache.clearModalCache() ${removedItemsCount} items will be destroyed`);
        }
    }
}
/**
 * Detaches subtrees loaded inside PageRouterOutlet in forward navigation
 * and reattaches them on back.
 * Reuses routes as long as their route config is the same.
 */
export class NSRouteReuseStrategy {
    constructor(location) {
        this.location = location;
        this.cacheByOutlet = {};
    }
    shouldDetach(route) {
        route = findTopActivatedRouteNodeForOutlet(route);
        const { outlet } = this.findValidOutletAndKey(route);
        const key = getSnapshotKey(route);
        let isPageActivated = false;
        let tmp = route;
        while (!(isPageActivated = tmp[pageRouterActivatedSymbol]) && tmp.parent) {
            tmp = tmp.parent;
        }
        const isBack = outlet ? outlet.isPageNavigationBack : false;
        let shouldDetach = outlet && !isBack && isPageActivated;
        if (outlet) {
            if (outlet.parent && !outlet.parent.shouldDetach) {
                shouldDetach = false;
            }
            outlet.shouldDetach = shouldDetach;
        }
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routeReuseStrategyLog(`shouldDetach isBack: ${isBack} key: ${key} result: ${shouldDetach}`);
        }
        return shouldDetach;
    }
    findValidOutletAndKey(targetRoute) {
        let route = targetRoute;
        const routeOutletKey = this.location.getRouteFullPath(route);
        let outletKey = routeOutletKey;
        let outlet = this.location.findOutlet(outletKey, route);
        while (!outlet) {
            if (!route.parent) {
                return { outlet: null, outletKey: routeOutletKey };
            }
            route = route.parent;
            outletKey = this.location.getRouteFullPath(route);
            outlet = this.location.findOutlet(outletKey, route);
        }
        if (outlet) {
            while (!outlet.outletKeys.includes(outletKey)) {
                if (!route.parent) {
                    NativeScriptDebug.routeReuseStrategyLog(`Could not find valid outlet key for route: ${targetRoute}.`);
                    return { outlet, outletKey: routeOutletKey };
                }
                route = route.parent;
                outletKey = this.location.getRouteFullPath(route);
            }
        }
        return { outlet, outletKey };
    }
    shouldAttach(route) {
        route = findTopActivatedRouteNodeForOutlet(route);
        const { outlet, outletKey } = this.findValidOutletAndKey(route);
        const cache = this.cacheByOutlet[outletKey];
        if (!cache) {
            return false;
        }
        const key = getSnapshotKey(route);
        const isBack = outlet ? outlet.isPageNavigationBack : false;
        const shouldAttach = isBack && cache.peek()?.key === key;
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routeReuseStrategyLog(`shouldAttach isBack: ${isBack} key: ${key} result: ${shouldAttach}`);
        }
        if (outlet) {
            outlet.shouldDetach = true;
        }
        return shouldAttach;
    }
    store(route, state) {
        route = findTopActivatedRouteNodeForOutlet(route);
        const key = getSnapshotKey(route);
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routeReuseStrategyLog(`store key: ${key}, state: ${state}`);
        }
        const { outletKey } = this.findValidOutletAndKey(route);
        // tslint:disable-next-line:max-line-length
        const cache = (this.cacheByOutlet[outletKey] = this.cacheByOutlet[outletKey] || new DetachedStateCache());
        if (state) {
            let isModal = false;
            if (this.location._modalNavigationDepth > 0) {
                isModal = true;
            }
            cache.push({ key, state, isModal });
        }
        else {
            const topItem = cache.peek();
            if (topItem.key === key) {
                cache.pop();
                if (!cache.length) {
                    delete this.cacheByOutlet[outletKey];
                }
            }
            else {
                throw new Error("Trying to pop from DetachedStateCache but keys don't match. " + `expected: ${topItem.key} actual: ${key}`);
            }
        }
    }
    retrieve(route) {
        route = findTopActivatedRouteNodeForOutlet(route);
        const { outlet, outletKey } = this.findValidOutletAndKey(route);
        const cache = this.cacheByOutlet[outletKey];
        if (!cache) {
            return null;
        }
        const key = getSnapshotKey(route);
        const isBack = outlet ? outlet.isPageNavigationBack : false;
        const cachedItem = cache.peek();
        let state = null;
        if (isBack && cachedItem && cachedItem.key === key) {
            state = cachedItem.state;
        }
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routeReuseStrategyLog(`retrieved isBack: ${isBack} key: ${key} state: ${state}`);
        }
        return state;
    }
    shouldReuseRoute(future, curr) {
        const shouldReuse = future.routeConfig === curr.routeConfig;
        if (shouldReuse && curr && curr[pageRouterActivatedSymbol]) {
            // When reusing route - copy the pageRouterActivated to the new snapshot
            // It's needed in shouldDetach to determine if the route should be detached.
            future[pageRouterActivatedSymbol] = curr[pageRouterActivatedSymbol];
        }
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routeReuseStrategyLog(`shouldReuseRoute result: ${shouldReuse}`);
        }
        return shouldReuse;
    }
    clearCache(outletKey) {
        const cache = this.cacheByOutlet[outletKey];
        if (cache) {
            cache.clear();
        }
    }
    markCacheForClear(outletKey) {
        const cache = this.cacheByOutlet[outletKey];
        if (cache) {
            cache.markCurrentForClear();
        }
    }
    popCache(outletKey) {
        const cache = this.cacheByOutlet[outletKey];
        if (cache) {
            if (cache.peek()) {
                const state = cache.pop()?.state;
                if (state?.componentRef) {
                    destroyComponentRef(state?.componentRef);
                }
            }
        }
    }
    markCacheForPop(outletKey) {
        const cache = this.cacheByOutlet[outletKey];
        if (cache) {
            const item = cache.peek();
            if (item) {
                item.markedForDeletion = true;
            }
        }
    }
    clearMarkedCache(outletKey) {
        const cache = this.cacheByOutlet[outletKey];
        if (cache) {
            cache.clearMarked();
        }
    }
    clearModalCache(outletKey) {
        const cache = this.cacheByOutlet[outletKey];
        if (cache) {
            cache.clearModalCache();
        }
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "18.1.0", ngImport: i0, type: NSRouteReuseStrategy, deps: [{ token: i1.NSLocationStrategy }], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "18.1.0", ngImport: i0, type: NSRouteReuseStrategy }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "18.1.0", ngImport: i0, type: NSRouteReuseStrategy, decorators: [{
            type: Injectable
        }], ctorParameters: () => [{ type: i1.NSLocationStrategy }] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibnMtcm91dGUtcmV1c2Utc3RyYXRlZ3kuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi9wYWNrYWdlcy9hbmd1bGFyL3NyYy9saWIvbGVnYWN5L3JvdXRlci9ucy1yb3V0ZS1yZXVzZS1zdHJhdGVneS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRzNDLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUNoRCxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUM1RCxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsa0NBQWtDLEVBQUUseUJBQXlCLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQzs7O0FBU2hJLE1BQU0sY0FBYyxHQUFHLFVBQVUsUUFBZ0M7SUFDL0QsT0FBTyxRQUFRLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztBQUMxQyxDQUFDLENBQUM7QUFFRjs7R0FFRztBQUNILE1BQU0sa0JBQWtCO0lBQXhCO1FBQ1UsVUFBSyxHQUFHLElBQUksS0FBSyxFQUFhLENBQUM7SUFzRnpDLENBQUM7SUFwRkMsSUFBVyxNQUFNO1FBQ2YsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQztJQUMzQixDQUFDO0lBRU0sSUFBSSxDQUFDLFNBQW9CO1FBQzlCLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBQzdCLENBQUM7SUFFTSxHQUFHO1FBQ1IsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsRUFBRSxDQUFDO0lBQzFCLENBQUM7SUFFTSxJQUFJO1FBQ1QsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDO0lBQzNDLENBQUM7SUFFTSxLQUFLO1FBQ1Ys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WUFBWSxDQUFDLENBQUM7Z0JBQzNDLENBQUM7WUFDSCxDQUFDO1FBQ0gsQ0FBQztJQUNILENBQUM7SUFFRCxlQUFlLENBQUMsU0FBaUI7UUFDL0IsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUU1QyxJQUFJLEtBQUssRUFBRSxDQUFDO1lBQ1YsTUFBTSxJQUFJLEdBQUcsS0FBSyxDQUFDLElBQUksRUFBRSxDQUFDO1lBQzFCLElBQUksSUFBSSxFQUFFLENBQUM7Z0JBQ1QsSUFBSSxDQUFDLGlCQUFpQixHQUFHLElBQUksQ0FBQztZQUNoQyxDQUFDO1FBQ0gsQ0FBQztJQUNILENBQUM7SUFFRCxnQkFBZ0IsQ0FBQyxTQUFpQjtRQUNoQyxNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBRTVDLElBQUksS0FBSyxFQUFFLENBQUM7WUFDVixLQUFLLENBQUMsV0FBVyxFQUFFLENBQUM7UUFDdEIsQ0FBQztJQUNILENBQUM7SUFFRCxlQUFlLENBQUMsU0FBaUI7UUFDL0IsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUU1QyxJQUFJLEtBQUssRUFBRSxDQUFDO1lBQ1YsS0FBSyxDQUFDLGVBQWUsRUFBRSxDQUFDO1FBQzFCLENBQUM7SUFDSCxDQUFDOzhHQXROVSxvQkFBb0I7a0hBQXBCLG9CQUFvQjs7MkZBQXBCLG9CQUFvQjtrQkFEaEMsVUFBVSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IFJvdXRlUmV1c2VTdHJhdGVneSwgQWN0aXZhdGVkUm91dGVTbmFwc2hvdCwgRGV0YWNoZWRSb3V0ZUhhbmRsZSB9IGZyb20gJ0Bhbmd1bGFyL3JvdXRlcic7XG5cbmltcG9ydCB7IE5hdGl2ZVNjcmlwdERlYnVnIH0gZnJvbSAnLi4vLi4vdHJhY2UnO1xuaW1wb3J0IHsgTlNMb2NhdGlvblN0cmF0ZWd5IH0gZnJvbSAnLi9ucy1sb2NhdGlvbi1zdHJhdGVneSc7XG5pbXBvcnQgeyBkZXN0cm95Q29tcG9uZW50UmVmLCBmaW5kVG9wQWN0aXZhdGVkUm91dGVOb2RlRm9yT3V0bGV0LCBwYWdlUm91dGVyQWN0aXZhdGVkU3ltYm9sIH0gZnJvbSAnLi9wYWdlLXJvdXRlci1vdXRsZXQtdXRpbHMnO1xuXG5pbnRlcmZhY2UgQ2FjaGVJdGVtIHtcbiAga2V5OiBzdHJpbmc7XG4gIHN0YXRlOiBEZXRhY2hlZFJvdXRlSGFuZGxlO1xuICBpc01vZGFsOiBib29sZWFuO1xuICBtYXJrZWRGb3JEZWxldGlvbj86IGJvb2xlYW47XG59XG5cbmNvbnN0IGdldFNuYXBzaG90S2V5ID0gZnVuY3Rpb24gKHNuYXBzaG90OiBBY3RpdmF0ZWRSb3V0ZVNuYXBzaG90KTogc3RyaW5nIHtcbiAgcmV0dXJuIHNuYXBzaG90LnBhdGhGcm9tUm9vdC5qb2luKCctPicpO1xufTtcblxuLyoqXG4gKiBEZXRhY2hlZCBzdGF0ZSBjYWNoZVxuICovXG5jbGFzcyBEZXRhY2hlZFN0YXRlQ2FjaGUge1xuICBwcml2YXRlIGNhY2hlID0gbmV3IEFycmF5PENhY2hlSXRlbT4oKTtcblxuICBwdWJsaWMgZ2V0IGxlbmd0aCgpOiBudW1iZXIge1xuICAgIHJldHVybiB0aGlzLmNhY2hlLmxlbmd0aDtcbiAgfVxuXG4gIHB1YmxpYyBwdXNoKGNhY2hlSXRlbTogQ2FjaGVJdGVtKSB7XG4gICAgdGhpcy5jYWNoZS5wdXNoKGNhY2hlSXRlbSk7XG4gIH1cblxuICBwdWJsaWMgcG9wKCk6IENhY2hlSXRlbSB7XG4gICAgcmV0dXJuIHRoaXMuY2FjaGUucG9wKCk7XG4gIH1cblxuICBwdWJsaWMgcGVlaygpOiBDYWNoZUl0ZW0ge1xuICAgIHJldHVybiB0aGlzLmNhY2hlW3RoaXMuY2FjaGUubGVuZ3RoIC0gMV07XG4gIH1cblxuICBwdWJsaWMgY2xlYXIoKSB7XG4gICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmlzTG9nRW5hYmxlZCgpKSB7XG4gICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yb3V0ZVJldXNlU3RyYXRlZ3lMb2coYERldGFjaGVkU3RhdGVDYWNoZS5jbGVhcigpICR7dGhpcy5jYWNoZS5sZW5ndGh9IGl0ZW1zIHdpbGwgYmUgZGVzdHJveWVkYCk7XG4gICAgfVxuXG4gICAgd2hpbGUgKHRoaXMuY2FjaGUubGVuZ3RoID4gMCkge1xuICAgICAgY29uc3Qgc3RhdGUgPSA8YW55PnRoaXMuY2FjaGUucG9wKCkuc3RhdGU7XG4gICAgICBpZiAoIXN0YXRlLmNvbXBvbmVudFJlZikge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ05vIGNvbXBvbmVudFJlZiBmb3VuZCBpbiBEZXRhY2hlZFJvdXRlSGFuZGxlJyk7XG4gICAgICB9XG5cbiAgICAgIGRlc3Ryb3lDb21wb25lbnRSZWYoc3RhdGUuY29tcG9uZW50UmVmKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgbWFya0N1cnJlbnRGb3JDbGVhcigpIHtcbiAgICBmb3IgKGNvbnN0IGl0ZW0gb2YgdGhpcy5jYWNoZSkge1xuICAgICAgaXRlbS5tYXJrZWRGb3JEZWxldGlvbiA9IHRydWU7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGNsZWFyTWFya2VkKCkge1xuICAgIC8vIHRyeSB0byBwcmVzZXJ2ZSBzYW1lIG9yZGVyIGFzIC5jbGVhcigpXG4gICAgZm9yIChsZXQgaSA9IHRoaXMuY2FjaGUubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHtcbiAgICAgIGNvbnN0IGNhY2hlSXRlbSA9IHRoaXMuY2FjaGVbaV07XG4gICAgICBpZiAoY2FjaGVJdGVtLm1hcmtlZEZvckRlbGV0aW9uKSB7XG4gICAgICAgIGNvbnN0IHN0YXRlID0gPGFueT5jYWNoZUl0ZW0uc3RhdGU7XG4gICAgICAgIGlmICghc3RhdGUuY29tcG9uZW50UmVmKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdObyBjb21wb25lbnRSZWYgZm91bmQgaW4gRGV0YWNoZWRSb3V0ZUhhbmRsZScpO1xuICAgICAgICB9XG5cbiAgICAgICAgZGVzdHJveUNvbXBvbmVudFJlZihzdGF0ZS5jb21wb25lbnRSZWYpO1xuICAgICAgICB0aGlzLmNhY2hlLnNwbGljZShpLCAxKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwdWJsaWMgY2xlYXJNb2RhbENhY2hlKCkge1xuICAgIGxldCByZW1vdmVkSXRlbXNDb3VudCA9IDA7XG4gICAgY29uc3QgaGFzTW9kYWxQYWdlcyA9IHRoaXMuY2FjaGUuc29tZSgoY2FjaGVJdGVtKSA9PiB7XG4gICAgICByZXR1cm4gY2FjaGVJdGVtLmlzTW9kYWw7XG4gICAgfSk7XG5cbiAgICBpZiAoaGFzTW9kYWxQYWdlcykge1xuICAgICAgbGV0IG1vZGFsQ2FjaGVDbGVhcmVkID0gZmFsc2U7XG5cbiAgICAgIHdoaWxlICghbW9kYWxDYWNoZUNsZWFyZWQpIHtcbiAgICAgICAgY29uc3QgY2FjaGVJdGVtID0gdGhpcy5wZWVrKCk7XG4gICAgICAgIGNvbnN0IHN0YXRlID0gPGFueT5jYWNoZUl0ZW0uc3RhdGU7XG5cbiAgICAgICAgaWYgKCFzdGF0ZS5jb21wb25lbnRSZWYpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ05vIGNvbXBvbmVudFJlZiBmb3VuZCBpbiBEZXRhY2hlZFJvdXRlSGFuZGxlJyk7XG4gICAgICAgIH1cblxuICAgICAgICBkZXN0cm95Q29tcG9uZW50UmVmKHN0YXRlLmNvbXBvbmVudFJlZik7XG4gICAgICAgIGlmIChjYWNoZUl0ZW0uaXNNb2RhbCkge1xuICAgICAgICAgIG1vZGFsQ2FjaGVDbGVhcmVkID0gdHJ1ZTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMucG9wKCk7XG4gICAgICAgIHJlbW92ZWRJdGVtc0NvdW50Kys7XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmlzTG9nRW5hYmxlZCgpKSB7XG4gICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yb3V0ZVJldXNlU3RyYXRlZ3lMb2coYERldGFjaGVkU3RhdGVDYWNoZS5jbGVhck1vZGFsQ2FjaGUoKSAke3JlbW92ZWRJdGVtc0NvdW50fSBpdGVtcyB3aWxsIGJlIGRlc3Ryb3llZGApO1xuICAgIH1cbiAgfVxufVxuXG4vKipcbiAqIERldGFjaGVzIHN1YnRyZWVzIGxvYWRlZCBpbnNpZGUgUGFnZVJvdXRlck91dGxldCBpbiBmb3J3YXJkIG5hdmlnYXRpb25cbiAqIGFuZCByZWF0dGFjaGVzIHRoZW0gb24gYmFjay5cbiAqIFJldXNlcyByb3V0ZXMgYXMgbG9uZyBhcyB0aGVpciByb3V0ZSBjb25maWcgaXMgdGhlIHNhbWUuXG4gKi9cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBOU1JvdXRlUmV1c2VTdHJhdGVneSBpbXBsZW1lbnRzIFJvdXRlUmV1c2VTdHJhdGVneSB7XG4gIHByaXZhdGUgY2FjaGVCeU91dGxldDogeyBba2V5OiBzdHJpbmddOiBEZXRhY2hlZFN0YXRlQ2FjaGUgfSA9IHt9O1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgbG9jYXRpb246IE5TTG9jYXRpb25TdHJhdGVneSkge31cblxuICBzaG91bGREZXRhY2gocm91dGU6IEFjdGl2YXRlZFJvdXRlU25hcHNob3QpOiBib29sZWFuIHtcbiAgICByb3V0ZSA9IGZpbmRUb3BBY3RpdmF0ZWRSb3V0ZU5vZGVGb3JPdXRsZXQocm91dGUpO1xuXG4gICAgY29uc3QgeyBvdXRsZXQgfSA9IHRoaXMuZmluZFZhbGlkT3V0bGV0QW5kS2V5KHJvdXRlKTtcbiAgICBjb25zdCBrZXkgPSBnZXRTbmFwc2hvdEtleShyb3V0ZSk7XG5cbiAgICBsZXQgaXNQYWdlQWN0aXZhdGVkID0gZmFsc2U7XG4gICAgbGV0IHRtcCA9IHJvdXRlO1xuICAgIHdoaWxlICghKGlzUGFnZUFjdGl2YXRlZCA9IHRtcFtwYWdlUm91dGVyQWN0aXZhdGVkU3ltYm9sXSkgJiYgdG1wLnBhcmVudCkge1xuICAgICAgdG1wID0gdG1wLnBhcmVudDtcbiAgICB9XG4gICAgY29uc3QgaXNCYWNrID0gb3V0bGV0ID8gb3V0bGV0LmlzUGFnZU5hdmlnYXRpb25CYWNrIDogZmFsc2U7XG4gICAgbGV0IHNob3VsZERldGFjaCA9IG91dGxldCAmJiAhaXNCYWNrICYmIGlzUGFnZUFjdGl2YXRlZDtcblxuICAgIGlmIChvdXRsZXQpIHtcbiAgICAgIGlmIChvdXRsZXQucGFyZW50ICYmICFvdXRsZXQucGFyZW50LnNob3VsZERldGFjaCkge1xuICAgICAgICBzaG91bGREZXRhY2ggPSBmYWxzZTtcbiAgICAgIH1cblxuICAgICAgb3V0bGV0LnNob3VsZERldGFjaCA9IHNob3VsZERldGFjaDtcbiAgICB9XG5cbiAgICBpZiAoTmF0aXZlU2NyaXB0RGVidWcuaXNMb2dFbmFibGVkKCkpIHtcbiAgICAgIE5hdGl2ZVNjcmlwdERlYnVnLnJvdXRlUmV1c2VTdHJhdGVneUxvZyhgc2hvdWxkRGV0YWNoIGlzQmFjazogJHtpc0JhY2t9IGtleTogJHtrZXl9IHJlc3VsdDogJHtzaG91bGREZXRhY2h9YCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHNob3VsZERldGFjaDtcbiAgfVxuICBwcm90ZWN0ZWQgZmluZFZhbGlkT3V0bGV0QW5kS2V5KHRhcmdldFJvdXRlOiBBY3RpdmF0ZWRSb3V0ZVNuYXBzaG90KSB7XG4gICAgbGV0IHJvdXRlID0gdGFyZ2V0Um91dGU7XG4gICAgY29uc3Qgcm91dGVPdXRsZXRLZXkgPSB0aGlzLmxvY2F0aW9uLmdldFJvdXRlRnVsbFBhdGgocm91dGUpO1xuICAgIGxldCBvdXRsZXRLZXkgPSByb3V0ZU91dGxldEtleTtcbiAgICBsZXQgb3V0bGV0ID0gdGhpcy5sb2NhdGlvbi5maW5kT3V0bGV0KG91dGxldEtleSwgcm91dGUpO1xuICAgIHdoaWxlICghb3V0bGV0KSB7XG4gICAgICBpZiAoIXJvdXRlLnBhcmVudCkge1xuICAgICAgICByZXR1cm4geyBvdXRsZXQ6IG51bGwsIG91dGxldEtleTogcm91dGVPdXRsZXRLZXkgfTtcbiAgICAgIH1cbiAgICAgIHJvdXRlID0gcm91dGUucGFyZW50O1xuICAgICAgb3V0bGV0S2V5ID0gdGhpcy5sb2NhdGlvbi5nZXRSb3V0ZUZ1bGxQYXRoKHJvdXRlKTtcbiAgICAgIG91dGxldCA9IHRoaXMubG9jYXRpb24uZmluZE91dGxldChvdXRsZXRLZXksIHJvdXRlKTtcbiAgICB9XG5cbiAgICBpZiAob3V0bGV0KSB7XG4gICAgICB3aGlsZSAoIW91dGxldC5vdXRsZXRLZXlzLmluY2x1ZGVzKG91dGxldEtleSkpIHtcbiAgICAgICAgaWYgKCFyb3V0ZS5wYXJlbnQpIHtcbiAgICAgICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yb3V0ZVJldXNlU3RyYXRlZ3lMb2coYENvdWxkIG5vdCBmaW5kIHZhbGlkIG91dGxldCBrZXkgZm9yIHJvdXRlOiAke3RhcmdldFJvdXRlfS5gKTtcbiAgICAgICAgICByZXR1cm4geyBvdXRsZXQsIG91dGxldEtleTogcm91dGVPdXRsZXRLZXkgfTtcbiAgICAgICAgfVxuICAgICAgICByb3V0ZSA9IHJvdXRlLnBhcmVudDtcbiAgICAgICAgb3V0bGV0S2V5ID0gdGhpcy5sb2NhdGlvbi5nZXRSb3V0ZUZ1bGxQYXRoKHJvdXRlKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4geyBvdXRsZXQsIG91dGxldEtleSB9O1xuICB9XG5cbiAgc2hvdWxkQXR0YWNoKHJvdXRlOiBBY3RpdmF0ZWRSb3V0ZVNuYXBzaG90KTogYm9vbGVhbiB7XG4gICAgcm91dGUgPSBmaW5kVG9wQWN0aXZhdGVkUm91dGVOb2RlRm9yT3V0bGV0KHJvdXRlKTtcblxuICAgIGNvbnN0IHsgb3V0bGV0LCBvdXRsZXRLZXkgfSA9IHRoaXMuZmluZFZhbGlkT3V0bGV0QW5kS2V5KHJvdXRlKTtcbiAgICBjb25zdCBjYWNoZSA9IHRoaXMuY2FjaGVCeU91dGxldFtvdXRsZXRLZXldO1xuICAgIGlmICghY2FjaGUpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICBjb25zdCBrZXkgPSBnZXRTbmFwc2hvdEtleShyb3V0ZSk7XG4gICAgY29uc3QgaXNCYWNrID0gb3V0bGV0ID8gb3V0bGV0LmlzUGFnZU5hdmlnYXRpb25CYWNrIDogZmFsc2U7XG4gICAgY29uc3Qgc2hvdWxkQXR0YWNoID0gaXNCYWNrICYmIGNhY2hlLnBlZWsoKT8ua2V5ID09PSBrZXk7XG5cbiAgICBpZiAoTmF0aXZlU2NyaXB0RGVidWcuaXNMb2dFbmFibGVkKCkpIHtcbiAgICAgIE5hdGl2ZVNjcmlwdERlYnVnLnJvdXRlUmV1c2VTdHJhdGVneUxvZyhgc2hvdWxkQXR0YWNoIGlzQmFjazogJHtpc0JhY2t9IGtleTogJHtrZXl9IHJlc3VsdDogJHtzaG91bGRBdHRhY2h9YCk7XG4gICAgfVxuXG4gICAgaWYgKG91dGxldCkge1xuICAgICAgb3V0bGV0LnNob3VsZERldGFjaCA9IHRydWU7XG4gICAgfVxuXG4gICAgcmV0dXJuIHNob3VsZEF0dGFjaDtcbiAgfVxuXG4gIHN0b3JlKHJvdXRlOiBBY3RpdmF0ZWRSb3V0ZVNuYXBzaG90LCBzdGF0ZTogRGV0YWNoZWRSb3V0ZUhhbmRsZSk6IHZvaWQge1xuICAgIHJvdXRlID0gZmluZFRvcEFjdGl2YXRlZFJvdXRlTm9kZUZvck91dGxldChyb3V0ZSk7XG5cbiAgICBjb25zdCBrZXkgPSBnZXRTbmFwc2hvdEtleShyb3V0ZSk7XG4gICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmlzTG9nRW5hYmxlZCgpKSB7XG4gICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yb3V0ZVJldXNlU3RyYXRlZ3lMb2coYHN0b3JlIGtleTogJHtrZXl9LCBzdGF0ZTogJHtzdGF0ZX1gKTtcbiAgICB9XG5cbiAgICBjb25zdCB7IG91dGxldEtleSB9ID0gdGhpcy5maW5kVmFsaWRPdXRsZXRBbmRLZXkocm91dGUpO1xuXG4gICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm1heC1saW5lLWxlbmd0aFxuICAgIGNvbnN0IGNhY2hlID0gKHRoaXMuY2FjaGVCeU91dGxldFtvdXRsZXRLZXldID0gdGhpcy5jYWNoZUJ5T3V0bGV0W291dGxldEtleV0gfHwgbmV3IERldGFjaGVkU3RhdGVDYWNoZSgpKTtcblxuICAgIGlmIChzdGF0ZSkge1xuICAgICAgbGV0IGlzTW9kYWwgPSBmYWxzZTtcbiAgICAgIGlmICh0aGlzLmxvY2F0aW9uLl9tb2RhbE5hdmlnYXRpb25EZXB0aCA+IDApIHtcbiAgICAgICAgaXNNb2RhbCA9IHRydWU7XG4gICAgICB9XG5cbiAgICAgIGNhY2hlLnB1c2goeyBrZXksIHN0YXRlLCBpc01vZGFsIH0pO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCB0b3BJdGVtID0gY2FjaGUucGVlaygpO1xuICAgICAgaWYgKHRvcEl0ZW0ua2V5ID09PSBrZXkpIHtcbiAgICAgICAgY2FjaGUucG9wKCk7XG5cbiAgICAgICAgaWYgKCFjYWNoZS5sZW5ndGgpIHtcbiAgICAgICAgICBkZWxldGUgdGhpcy5jYWNoZUJ5T3V0bGV0W291dGxldEtleV07XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcIlRyeWluZyB0byBwb3AgZnJvbSBEZXRhY2hlZFN0YXRlQ2FjaGUgYnV0IGtleXMgZG9uJ3QgbWF0Y2guIFwiICsgYGV4cGVjdGVkOiAke3RvcEl0ZW0ua2V5fSBhY3R1YWw6ICR7a2V5fWApO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHJldHJpZXZlKHJvdXRlOiBBY3RpdmF0ZWRSb3V0ZVNuYXBzaG90KTogRGV0YWNoZWRSb3V0ZUhhbmRsZSB8IG51bGwge1xuICAgIHJvdXRlID0gZmluZFRvcEFjdGl2YXRlZFJvdXRlTm9kZUZvck91dGxldChyb3V0ZSk7XG5cbiAgICBjb25zdCB7IG91dGxldCwgb3V0bGV0S2V5IH0gPSB0aGlzLmZpbmRWYWxpZE91dGxldEFuZEtleShyb3V0ZSk7XG4gICAgY29uc3QgY2FjaGUgPSB0aGlzLmNhY2hlQnlPdXRsZXRbb3V0bGV0S2V5XTtcbiAgICBpZiAoIWNhY2hlKSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICBjb25zdCBrZXkgPSBnZXRTbmFwc2hvdEtleShyb3V0ZSk7XG4gICAgY29uc3QgaXNCYWNrID0gb3V0bGV0ID8gb3V0bGV0LmlzUGFnZU5hdmlnYXRpb25CYWNrIDogZmFsc2U7XG4gICAgY29uc3QgY2FjaGVkSXRlbSA9IGNhY2hlLnBlZWsoKTtcblxuICAgIGxldCBzdGF0ZSA9IG51bGw7XG4gICAgaWYgKGlzQmFjayAmJiBjYWNoZWRJdGVtICYmIGNhY2hlZEl0ZW0ua2V5ID09PSBrZXkpIHtcbiAgICAgIHN0YXRlID0gY2FjaGVkSXRlbS5zdGF0ZTtcbiAgICB9XG5cbiAgICBpZiAoTmF0aXZlU2NyaXB0RGVidWcuaXNMb2dFbmFibGVkKCkpIHtcbiAgICAgIE5hdGl2ZVNjcmlwdERlYnVnLnJvdXRlUmV1c2VTdHJhdGVneUxvZyhgcmV0cmlldmVkIGlzQmFjazogJHtpc0JhY2t9IGtleTogJHtrZXl9IHN0YXRlOiAke3N0YXRlfWApO1xuICAgIH1cblxuICAgIHJldHVybiBzdGF0ZTtcbiAgfVxuXG4gIHNob3VsZFJldXNlUm91dGUoZnV0dXJlOiBBY3RpdmF0ZWRSb3V0ZVNuYXBzaG90LCBjdXJyOiBBY3RpdmF0ZWRSb3V0ZVNuYXBzaG90KTogYm9vbGVhbiB7XG4gICAgY29uc3Qgc2hvdWxkUmV1c2UgPSBmdXR1cmUucm91dGVDb25maWcgPT09IGN1cnIucm91dGVDb25maWc7XG5cbiAgICBpZiAoc2hvdWxkUmV1c2UgJiYgY3VyciAmJiBjdXJyW3BhZ2VSb3V0ZXJBY3RpdmF0ZWRTeW1ib2xdKSB7XG4gICAgICAvLyBXaGVuIHJldXNpbmcgcm91dGUgLSBjb3B5IHRoZSBwYWdlUm91dGVyQWN0aXZhdGVkIHRvIHRoZSBuZXcgc25hcHNob3RcbiAgICAgIC8vIEl0J3MgbmVlZGVkIGluIHNob3VsZERldGFjaCB0byBkZXRlcm1pbmUgaWYgdGhlIHJvdXRlIHNob3VsZCBiZSBkZXRhY2hlZC5cbiAgICAgIGZ1dHVyZVtwYWdlUm91dGVyQWN0aXZhdGVkU3ltYm9sXSA9IGN1cnJbcGFnZVJvdXRlckFjdGl2YXRlZFN5bWJvbF07XG4gICAgfVxuXG4gICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmlzTG9nRW5hYmxlZCgpKSB7XG4gICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yb3V0ZVJldXNlU3RyYXRlZ3lMb2coYHNob3VsZFJldXNlUm91dGUgcmVzdWx0OiAke3Nob3VsZFJldXNlfWApO1xuICAgIH1cblxuICAgIHJldHVybiBzaG91bGRSZXVzZTtcbiAgfVxuXG4gIGNsZWFyQ2FjaGUob3V0bGV0S2V5OiBzdHJpbmcpIHtcbiAgICBjb25zdCBjYWNoZSA9IHRoaXMuY2FjaGVCeU91dGxldFtvdXRsZXRLZXldO1xuXG4gICAgaWYgKGNhY2hlKSB7XG4gICAgICBjYWNoZS5jbGVhcigpO1xuICAgIH1cbiAgfVxuXG4gIG1hcmtDYWNoZUZvckNsZWFyKG91dGxldEtleTogc3RyaW5nKSB7XG4gICAgY29uc3QgY2FjaGUgPSB0aGlzLmNhY2hlQnlPdXRsZXRbb3V0bGV0S2V5XTtcblxuICAgIGlmIChjYWNoZSkge1xuICAgICAgY2FjaGUubWFya0N1cnJlbnRGb3JDbGVhcigpO1xuICAgIH1cbiAgfVxuXG4gIHBvcENhY2hlKG91dGxldEtleTogc3RyaW5nKSB7XG4gICAgY29uc3QgY2FjaGUgPSB0aGlzLmNhY2hlQnlPdXRsZXRbb3V0bGV0S2V5XTtcblxuICAgIGlmIChjYWNoZSkge1xuICAgICAgaWYgKGNhY2hlLnBlZWsoKSkge1xuICAgICAgICBjb25zdCBzdGF0ZTogYW55ID0gY2FjaGUucG9wKCk/LnN0YXRlO1xuICAgICAgICBpZiAoc3RhdGU/LmNvbXBvbmVudFJlZikge1xuICAgICAgICAgIGRlc3Ryb3lDb21wb25lbnRSZWYoc3RhdGU/LmNvbXBvbmVudFJlZik7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBtYXJrQ2FjaGVGb3JQb3Aob3V0bGV0S2V5OiBzdHJpbmcpIHtcbiAgICBjb25zdCBjYWNoZSA9IHRoaXMuY2FjaGVCeU91dGxldFtvdXRsZXRLZXldO1xuXG4gICAgaWYgKGNhY2hlKSB7XG4gICAgICBjb25zdCBpdGVtID0gY2FjaGUucGVlaygpO1xuICAgICAgaWYgKGl0ZW0pIHtcbiAgICAgICAgaXRlbS5tYXJrZWRGb3JEZWxldGlvbiA9IHRydWU7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgY2xlYXJNYXJrZWRDYWNoZShvdXRsZXRLZXk6IHN0cmluZykge1xuICAgIGNvbnN0IGNhY2hlID0gdGhpcy5jYWNoZUJ5T3V0bGV0W291dGxldEtleV07XG5cbiAgICBpZiAoY2FjaGUpIHtcbiAgICAgIGNhY2hlLmNsZWFyTWFya2VkKCk7XG4gICAgfVxuICB9XG5cbiAgY2xlYXJNb2RhbENhY2hlKG91dGxldEtleTogc3RyaW5nKSB7XG4gICAgY29uc3QgY2FjaGUgPSB0aGlzLmNhY2hlQnlPdXRsZXRbb3V0bGV0S2V5XTtcblxuICAgIGlmIChjYWNoZSkge1xuICAgICAgY2FjaGUuY2xlYXJNb2RhbENhY2hlKCk7XG4gICAgfVxuICB9XG59XG4iXX0=
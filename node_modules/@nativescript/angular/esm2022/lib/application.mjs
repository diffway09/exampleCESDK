import { ApplicationRef, NgModuleRef, NgZone, PlatformRef, ÉµinternalCreateApplication as internalCreateApplication } from '@angular/core';
import { filter, map, take } from 'rxjs/operators';
import { Application, Color, profile, removeTaggedAdditionalCSS, TextView, View, Utils } from '@nativescript/core';
import { AppHostView } from './app-host-view';
import { NativeScriptLoadingService } from './loading.service';
import { APP_ROOT_VIEW, DISABLE_ROOT_VIEW_HANDLING, NATIVESCRIPT_ROOT_MODULE_ID } from './tokens';
import { Subject } from 'rxjs';
import { NativeScriptDebug } from './trace';
import { NATIVESCRIPT_MODULE_PROVIDERS, NATIVESCRIPT_MODULE_STATIC_PROVIDERS } from './nativescript';
export function disableRootViewHanding(view) {
    view.__disable_root_view_handling = true;
}
export const preAngularDisposal$ = new Subject();
export const postAngularBootstrap$ = new Subject();
/**
 * @deprecated
 */
export const onBeforeLivesync = preAngularDisposal$.pipe(filter((v) => v.moduleType === 'main' && v.reason === 'hotreload'), map((v) => v.reference));
/**
 * @deprecated
 */
export const onAfterLivesync = postAngularBootstrap$.pipe(filter((v) => v.moduleType === 'main'), map((v) => ({ moduleRef: v.reference })));
if (import.meta['webpackHot']) {
    import.meta['webpackHot'].decline();
    global.__onLiveSyncCore = () => {
        Application.getRootView()?._onCssStateChange();
        // all other changes are applied by runNativeScriptAngularApp
    };
}
function emitModuleBootstrapEvent(ref, name, reason) {
    postAngularBootstrap$.next({
        moduleType: name,
        reference: ref,
        reason,
    });
}
function destroyRef(ref, name, reason) {
    if (ref) {
        if (ref instanceof PlatformRef) {
            preAngularDisposal$.next({
                moduleType: 'platform',
                reference: ref,
                reason: name,
            });
        }
        if (ref instanceof NgModuleRef || ref instanceof ApplicationRef) {
            preAngularDisposal$.next({
                moduleType: name,
                reference: ref,
                reason,
            });
        }
        ref.destroy();
    }
}
function runZoneSyncTask(fn) {
    if (typeof Zone === 'undefined') {
        return;
    }
    const zone = Zone.current;
    const task = zone.scheduleEventTask('sync_function', fn, {}, () => {
        //
    }, () => {
        //
    });
    try {
        // console.log(task.state);
        task.invoke();
        // zone.runTask(task);
        // console.log(task.state);
    }
    finally {
        zone.cancelTask(task);
    }
}
function ZoneCanWorkSync() {
    let canRunSync = false;
    runZoneSyncTask(() => {
        Promise.resolve().then(() => (canRunSync = true));
    });
    return canRunSync;
}
/**
 * Tests if global.__drainMicrotaskQueue can be used to drain microtasks
 * Because of Zone.js, even though the native queue might be drained, zone microtasks might not be
 * @param makeTestDrain should it drain the current microtask queue to ensure the queue can be drained
 * @returns if global.__drainMicrotaskQueue can be called
 */
function nativeQueueCanBeDrained(makeTestDrain) {
    if (typeof global.__drainMicrotaskQueue !== 'function') {
        return false;
    }
    if (!makeTestDrain) {
        return true;
    }
    let canRunSync = false;
    Promise.resolve().then(() => (canRunSync = true));
    global.__drainMicrotaskQueue();
    return canRunSync;
}
/**
 * Runs a function in the most synchronous way possible
 * @param fn function to run
 * @param done function to chain after done
 */
function runSynchronously(fn, done) {
    if (typeof Zone !== 'undefined' && ZoneCanWorkSync()) {
        runZoneSyncTask(fn);
        done?.();
        return;
    }
    if (nativeQueueCanBeDrained(true)) {
        fn();
        global.__drainMicrotaskQueue();
        done?.();
        return;
    }
    fn();
    if (done) {
        Utils.queueMacrotask(done);
    }
}
function createProvidersConfig(options) {
    return {
        appProviders: [...NATIVESCRIPT_MODULE_PROVIDERS, ...NATIVESCRIPT_MODULE_STATIC_PROVIDERS, ...(options?.providers ?? [])],
        // platformProviders: INTERNAL_BROWSER_PLATFORM_PROVIDERS
    };
}
export function bootstrapApplication(rootComponent, options) {
    return internalCreateApplication({ rootComponent, ...createProvidersConfig(options) });
}
export function runNativeScriptAngularApp(options) {
    let mainModuleRef = null;
    let loadingModuleRef;
    let platformRef = null;
    let bootstrapId = -1;
    const updatePlatformRef = (moduleRef, reason) => {
        const newPlatformRef = moduleRef.injector.get(PlatformRef);
        if (newPlatformRef === platformRef) {
            return;
        }
        destroyRef(platformRef, reason);
        platformRef = newPlatformRef;
        platformRef.onDestroy(() => (platformRef = platformRef === newPlatformRef ? null : platformRef));
    };
    let launchEventDone = true;
    let targetRootView = null;
    const setRootView = (ref) => {
        if (bootstrapId === -1) {
            // treat edge cases
            return;
        }
        if (ref instanceof NgModuleRef || ref instanceof ApplicationRef) {
            if (ref.injector.get(DISABLE_ROOT_VIEW_HANDLING, false)) {
                return;
            }
        }
        else {
            if (ref['__disable_root_view_handling']) {
                return;
            }
        }
        Application.getRootView()?._closeAllModalViewsInternal(); // cleanup old rootview
        NativeScriptDebug.bootstrapLog(`Setting RootView ${launchEventDone ? 'outside of' : 'during'} launch event`);
        // TODO: check for leaks when root view isn't properly destroyed
        if (ref instanceof View) {
            if (NativeScriptDebug.isLogEnabled()) {
                NativeScriptDebug.bootstrapLog(`Setting RootView to ${ref}`);
            }
            if (options.embedded) {
                Application.run({ create: () => ref });
            }
            else if (launchEventDone) {
                Application.resetRootView({ create: () => ref });
            }
            else {
                targetRootView = ref;
            }
            return;
        }
        const view = ref.injector.get(APP_ROOT_VIEW);
        const newRoot = view instanceof AppHostView ? view.content : view;
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.bootstrapLog(`Setting RootView to ${newRoot}`);
        }
        if (options.embedded) {
            Application.run({ create: () => newRoot });
        }
        else if (launchEventDone) {
            Application.resetRootView({ create: () => newRoot });
        }
        else {
            targetRootView = newRoot;
        }
    };
    const showErrorUI = (error) => {
        const message = error.message + '\n\n' + error.stack;
        const errorTextBox = new TextView();
        errorTextBox.text = message;
        errorTextBox.color = new Color('red');
        setRootView(errorTextBox);
    };
    const bootstrapRoot = (reason) => {
        try {
            bootstrapId = Date.now();
            const currentBootstrapId = bootstrapId;
            let bootstrapped = false;
            let onMainBootstrap = () => {
                setRootView(mainModuleRef);
            };
            runSynchronously(() => options.appModuleBootstrap(reason).then((ref) => {
                if (currentBootstrapId !== bootstrapId) {
                    // this module is old and not needed anymore
                    // this may happen when developer uses async app initializer and the user exits the app before this bootstraps
                    ref.destroy();
                    return;
                }
                mainModuleRef = ref;
                (ref instanceof ApplicationRef ? ref.components[0] : ref).onDestroy(() => (mainModuleRef = mainModuleRef === ref ? null : mainModuleRef));
                updatePlatformRef(ref, reason);
                const styleTag = ref.injector.get(NATIVESCRIPT_ROOT_MODULE_ID);
                (ref instanceof ApplicationRef ? ref.components[0] : ref).onDestroy(() => {
                    removeTaggedAdditionalCSS(styleTag);
                });
                bootstrapped = true;
                onMainBootstrap();
                emitModuleBootstrapEvent(ref, 'main', reason);
                // bootstrapped component: (ref as any)._bootstrapComponents[0];
            }, (err) => {
                bootstrapped = true;
                NativeScriptDebug.bootstrapLogError(`Error bootstrapping app module:\n${err.message}\n\n${err.stack}`);
                showErrorUI(err);
                throw err;
            }), () => {
                if (currentBootstrapId !== bootstrapId) {
                    return;
                }
                if (!bootstrapped) {
                    if (options.loadingModule) {
                        runSynchronously(() => options.loadingModule(reason).then((loadingRef) => {
                            if (currentBootstrapId !== bootstrapId) {
                                // this module is old and not needed anymore
                                // this may happen when developer uses async app initializer and the user exits the app before this bootstraps
                                loadingRef.destroy();
                                return;
                            }
                            loadingModuleRef = loadingRef;
                            (loadingModuleRef instanceof ApplicationRef ? loadingModuleRef.components[0] : loadingModuleRef).onDestroy(() => (loadingModuleRef = loadingModuleRef === loadingRef ? null : loadingModuleRef));
                            updatePlatformRef(loadingRef, reason);
                            const styleTag = loadingModuleRef.injector.get(NATIVESCRIPT_ROOT_MODULE_ID);
                            (loadingModuleRef instanceof ApplicationRef ? loadingModuleRef.components[0] : loadingModuleRef).onDestroy(() => {
                                removeTaggedAdditionalCSS(styleTag);
                            });
                            setRootView(loadingRef);
                            onMainBootstrap = () => {
                                // delay showing the new rootview to avoid flashes
                                Utils.queueMacrotask(() => {
                                    const loadingService = loadingModuleRef.injector.get(NativeScriptLoadingService);
                                    loadingModuleRef.injector.get(NgZone).run(() => {
                                        loadingService._notifyMainModuleReady();
                                    });
                                    loadingService.readyToDestroy$
                                        .pipe(filter((ready) => ready), take(1))
                                        .subscribe(() => {
                                        destroyRef(loadingModuleRef, 'loading', reason);
                                        loadingModuleRef = null;
                                        setRootView(mainModuleRef);
                                    });
                                });
                            };
                            emitModuleBootstrapEvent(loadingModuleRef, 'loading', reason);
                        }, (err) => {
                            NativeScriptDebug.bootstrapLogError(`Error bootstrapping loading module:\n${err.message}\n\n${err.stack}`);
                            showErrorUI(err);
                            throw err;
                        }));
                    }
                    else if (options.launchView) {
                        let launchView = options.launchView(reason);
                        setRootView(launchView);
                        if (launchView.startAnimation) {
                            setTimeout(() => {
                                // ensure launch animation is executed after launchView added to view stack
                                launchView.startAnimation();
                            });
                        }
                        onMainBootstrap = () => {
                            // delay showing the new rootview to avoid flashes
                            Utils.queueMacrotask(() => {
                                if (launchView.cleanup) {
                                    launchView
                                        .cleanup()
                                        .catch()
                                        .then(() => {
                                        launchView = null;
                                        setRootView(mainModuleRef);
                                    });
                                }
                                else {
                                    launchView = null;
                                    setRootView(mainModuleRef);
                                }
                            });
                        };
                    }
                    else {
                        console.warn('App is bootstrapping asynchronously (likely APP_INITIALIZER) but did not provide a launchView or LoadingModule.');
                    }
                }
            });
        }
        catch (err) {
            NativeScriptDebug.bootstrapLogError(`Error in Bootstrap Function:\n${err.message}\n\n${err.stack}`);
        }
    };
    const disposePlatform = (reason) => {
        destroyRef(platformRef, reason);
        platformRef = null;
    };
    const disposeLastModules = (reason) => {
        // reset bootstrap ID to make sure any modules bootstrapped after this are discarded
        bootstrapId = -1;
        destroyRef(loadingModuleRef, 'loading', reason);
        loadingModuleRef = null;
        destroyRef(mainModuleRef, 'main', reason);
        mainModuleRef = null;
    };
    const launchCallback = profile('@nativescript/angular/platform-common.launchCallback', (args) => {
        launchEventDone = false;
        bootstrapRoot('applaunch');
        launchEventDone = true;
        args.root = targetRootView || null;
    });
    const exitCallback = profile('@nativescript/angular/platform-common.exitCallback', (args) => {
        disposeLastModules('appexit');
    });
    let oldAddEventListener;
    if (typeof Zone !== 'undefined' && global.NativeScriptGlobals?.events?.[Zone.__symbol__('addEventListener')]) {
        oldAddEventListener = global.NativeScriptGlobals.events.addEventListener;
        global.NativeScriptGlobals.events.addEventListener = global.NativeScriptGlobals.events[Zone.__symbol__('addEventListener')];
    }
    if (!options.embedded) {
        Application.on(Application.launchEvent, launchCallback);
    }
    Application.on(Application.exitEvent, exitCallback);
    if (oldAddEventListener) {
        global.NativeScriptGlobals.events.addEventListener = oldAddEventListener;
    }
    if (import.meta['webpackHot']) {
        // handle HMR Application.run
        global['__dispose_app_ng_platform__'] = () => {
            disposePlatform('hotreload');
        };
        global['__dispose_app_ng_modules__'] = () => {
            disposeLastModules('hotreload');
        };
        global['__bootstrap_app_ng_modules__'] = () => {
            bootstrapRoot('hotreload');
        };
        global['__cleanup_ng_hot__'] = () => {
            Application.off(Application.launchEvent, launchCallback);
            Application.off(Application.exitEvent, exitCallback);
            disposeLastModules('hotreload');
            disposePlatform('hotreload');
        };
        global['__reboot_ng_modules__'] = (shouldDisposePlatform = false) => {
            disposeLastModules('hotreload');
            if (shouldDisposePlatform) {
                disposePlatform('hotreload');
            }
            bootstrapRoot('hotreload');
        };
        if (!Application.hasLaunched()) {
            Application.run();
            return;
        }
        bootstrapRoot('hotreload');
        return;
    }
    if (options.embedded) {
        bootstrapRoot('applaunch');
    }
    else {
        Application.run();
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBwbGljYXRpb24uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9wYWNrYWdlcy9hbmd1bGFyL3NyYy9saWIvYXBwbGljYXRpb24udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLGNBQWMsRUFBd0IsV0FBVyxFQUFFLE1BQU0sRUFBRSxXQUFXLEVBQWtCLDBCQUEwQixJQUFJLHlCQUF5QixFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ2hMLE9BQU8sRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFLElBQUksRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ25ELE9BQU8sRUFBRSxXQUFXLEVBQXdCLEtBQUssRUFBK0IsT0FBTyxFQUFFLHlCQUF5QixFQUFlLFFBQVEsRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFTLE1BQU0sb0JBQW9CLENBQUM7QUFDMUwsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQzlDLE9BQU8sRUFBRSwwQkFBMEIsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQy9ELE9BQU8sRUFBRSxhQUFhLEVBQUUsMEJBQTBCLEVBQUUsMkJBQTJCLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFDbEcsT0FBTyxFQUFjLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUMzQyxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxTQUFTLENBQUM7QUFDNUMsT0FBTyxFQUFFLDZCQUE2QixFQUFFLG9DQUFvQyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFhckcsTUFBTSxVQUFVLHNCQUFzQixDQUFDLElBQW1CO0lBQ3hELElBQUksQ0FBQyw0QkFBNEIsR0FBRyxJQUFJLENBQUM7QUFDM0MsQ0FBQztBQWdCRCxNQUFNLENBQUMsTUFBTSxtQkFBbUIsR0FBRyxJQUFJLE9BQU8sRUFBaUIsQ0FBQztBQUNoRSxNQUFNLENBQUMsTUFBTSxxQkFBcUIsR0FBRyxJQUFJLE9BQU8sRUFBaUIsQ0FBQztBQUVs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QUMvQixXQUFXLENBQUMsR0FBRyxFQUFFLENBQUM7WUFDbEIsT0FBTztRQUNULENBQUM7UUFDRCxhQUFhLENBQUMsV0FBVyxDQUFDLENBQUM7UUFDM0IsT0FBTztJQUNULENBQUM7SUFFRCxJQUFJLE9BQU8sQ0FBQyxRQUFRLEVBQUUsQ0FBQztRQUNyQixhQUFhLENBQUMsV0FBVyxDQUFDLENBQUM7SUFDN0IsQ0FBQztTQUFNLENBQUM7UUFDTixXQUFXLENBQUMsR0FBRyxFQUFFLENBQUM7SUFDcEIsQ0FBQztBQUNILENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBcHBsaWNhdGlvblJlZiwgRW52aXJvbm1lbnRQcm92aWRlcnMsIE5nTW9kdWxlUmVmLCBOZ1pvbmUsIFBsYXRmb3JtUmVmLCBQcm92aWRlciwgVHlwZSwgybVpbnRlcm5hbENyZWF0ZUFwcGxpY2F0aW9uIGFzIGludGVybmFsQ3JlYXRlQXBwbGljYXRpb24gfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IGZpbHRlciwgbWFwLCB0YWtlIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgQXBwbGljYXRpb24sIEFwcGxpY2F0aW9uRXZlbnREYXRhLCBDb2xvciwgTGF1bmNoRXZlbnREYXRhLCBMYXlvdXRCYXNlLCBwcm9maWxlLCByZW1vdmVUYWdnZWRBZGRpdGlvbmFsQ1NTLCBTdGFja0xheW91dCwgVGV4dFZpZXcsIFZpZXcsIFV0aWxzLCBUcmFjZSB9IGZyb20gJ0BuYXRpdmVzY3JpcHQvY29yZSc7XG5pbXBvcnQgeyBBcHBIb3N0VmlldyB9IGZyb20gJy4vYXBwLWhvc3Qtdmlldyc7XG5pbXBvcnQgeyBOYXRpdmVTY3JpcHRMb2FkaW5nU2VydmljZSB9IGZyb20gJy4vbG9hZGluZy5zZXJ2aWNlJztcbmltcG9ydCB7IEFQUF9ST09UX1ZJRVcsIERJU0FCTEVfUk9PVF9WSUVXX0hBTkRMSU5HLCBOQVRJVkVTQ1JJUFRfUk9PVF9NT0RVTEVfSUQgfSBmcm9tICcuL3Rva2Vucyc7XG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBOYXRpdmVTY3JpcHREZWJ1ZyB9IGZyb20gJy4vdHJhY2UnO1xuaW1wb3J0IHsgTkFUSVZFU0NSSVBUX01PRFVMRV9QUk9WSURFUlMsIE5BVElWRVNDUklQVF9NT0RVTEVfU1RBVElDX1BST1ZJREVSUyB9IGZyb20gJy4vbmF0aXZlc2NyaXB0JztcblxuZXhwb3J0IGludGVyZmFjZSBBcHBMYXVuY2hWaWV3IGV4dGVuZHMgTGF5b3V0QmFzZSB7XG4gIC8vIGNhbGxlZCB3aGVuIHRoZSBhbmltYXRpb24gaXMgdG8gYmVnaW5cbiAgc3RhcnRBbmltYXRpb24/OiAoKSA9PiB2b2lkO1xuICAvLyBjYWxsZWQgd2hlbiBib290c3RyYXAgaXMgY29tcGxldGUgYW5kIGNsZWFudXAgY2FuIGJlZ2luXG4gIC8vIHNob3VsZCByZXNvbHZlIHdoZW4gYW5pbWF0aW9uIGlzIGNvbXBsZXRlbHkgZmluaXNoZWRcbiAgY2xlYW51cD86ICgpID0+IFByb21pc2U8YW55PjtcblxuICAvLyBkbyB5b3Ugd2FudCB0byBoYW5kbGUgc2V0dGluZyB0aGlzIGFzIGEgcm9vdHZpZXcgbWFudWFsbHk/XG4gIF9fZGlzYWJsZV9yb290X3ZpZXdfaGFuZGxpbmc/OiBib29sZWFuO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZGlzYWJsZVJvb3RWaWV3SGFuZGluZyh2aWV3OiBBcHBMYXVuY2hWaWV3KSB7XG4gIHZpZXcuX19kaXNhYmxlX3Jvb3Rfdmlld19oYW5kbGluZyA9IHRydWU7XG59XG5cbmV4cG9ydCB0eXBlIE5nTW9kdWxlUmVhc29uID0gJ2hvdHJlbG9hZCcgfCAnYXBwbGF1bmNoJyB8ICdhcHBleGl0JztcblxuZXhwb3J0IHR5cGUgTmdNb2R1bGVFdmVudCA9XG4gIHwge1xuICAgICAgbW9kdWxlVHlwZTogJ21haW4nIHwgJ2xvYWRpbmcnIHwgc3RyaW5nO1xuICAgICAgcmVmZXJlbmNlOiBOZ01vZHVsZVJlZjx1bmtub3duPiB8IEFwcGxpY2F0aW9uUmVmO1xuICAgICAgcmVhc29uOiBOZ01vZHVsZVJlYXNvbiB8IHN0cmluZztcbiAgICB9XG4gIHwge1xuICAgICAgbW9kdWxlVHlwZTogJ3BsYXRmb3JtJztcbiAgICAgIHJlZmVyZW5jZTogUGxhdGZvcm1SZWY7XG4gICAgICByZWFzb246IE5nTW9kdWxlUmVhc29uIHwgc3RyaW5nO1xuICAgIH07XG5cbmV4cG9ydCBjb25zdCBwcmVBbmd1bGFyRGlzcG9zYWwkID0gbmV3IFN1YmplY3Q8TmdNb2R1bGVFdmVudD4oKTtcbmV4cG9ydCBjb25zdCBwb3N0QW5ndWxhckJvb3RzdHJhcCQgPSBuZXcgU3ViamVjdDxOZ01vZHVsZUV2ZW50PigpO1xuXG4vKipcbiAqIEBkZXByZWNhdGVkXG4gKi9cbmV4cG9ydCBjb25zdCBvbkJlZm9yZUxpdmVzeW5jOiBPYnNlcnZhYmxlPE5nTW9kdWxlUmVmPGFueT4+ID0gcHJlQW5ndWxhckRpc3Bvc2FsJC5waXBlKFxuICBmaWx0ZXIoKHYpID0+IHYubW9kdWxlVHlwZSA9PT0gJ21haW4nICYmIHYucmVhc29uID09PSAnaG90cmVsb2FkJyksXG4gIG1hcCgodikgPT4gdi5yZWZlcmVuY2UgYXMgTmdNb2R1bGVSZWY8YW55Pilcbik7XG4vKipcbiAqIEBkZXByZWNhdGVkXG4gKi9cbmV4cG9ydCBjb25zdCBvbkFmdGVyTGl2ZXN5bmM6IE9ic2VydmFibGU8e1xuICBtb2R1bGVSZWY/OiBOZ01vZHVsZVJlZjxhbnk+O1xuICBlcnJvcj86IEVycm9yO1xufT4gPSBwb3N0QW5ndWxhckJvb3RzdHJhcCQucGlwZShcbiAgZmlsdGVyKCh2KSA9PiB2Lm1vZHVsZVR5cGUgPT09ICdtYWluJyksXG4gIG1hcCgodikgPT4gKHsgbW9kdWxlUmVmOiB2LnJlZmVyZW5jZSBhcyBOZ01vZHVsZVJlZjxhbnk+IH0pKVxuKTtcbmV4cG9ydCBpbnRlcmZhY2UgQXBwUnVuT3B0aW9uczxULCBLPiB7XG4gIC8qKlxuICAgKiBSdW5zIHdoZW4gdGhlIGFwcCBpcyBsYXVuY2hlZCBvciBkdXJpbmcgSE1SLlxuICAgKiBNYXkgbm90IHJ1biBpbW1lZGlhdGVseSBpZiB0aGUgYXBwIHdhcyBzdGFydGVkIGluIGJhY2tncm91bmQgKGUuZy4gcHVzaCBub3RpZmljYXRpb24pXG4gICAqIEBwYXJhbSByZWFzb24gcmVhc29uIGZvciBib290c3RyYXAuIEBzZWUge05nTW9kdWxlUmVhc29ufVxuICAgKiBAcmV0dXJucyBQcm9taXNlIHRvIHRoZSBib290c3RyYXBwZWQgTmdNb2R1bGVSZWZcbiAgICovXG4gIGFwcE1vZHVsZUJvb3RzdHJhcDogKHJlYXNvbjogTmdNb2R1bGVSZWFzb24pID0+IFByb21pc2U8TmdNb2R1bGVSZWY8VD4gfCBBcHBsaWNhdGlvblJlZj47XG4gIC8qKlxuICAgKiBMb2FkcyBhIGN1c3RvbSBOZ01vZHVsZSBmb3IgdGhlIGxvYWRpbmcgc2NyZWVuLlxuICAgKiBUaGlzIGxvYWRzIG9ubHkgaWYgYXBwTW9kdWxlQm9vdHN0cmFwIGRvZXNuJ3QgcmVzb2x2ZSBzeW5jaHJvbm91c2x5IChlLmcuIGFzeW5jIEFQUF9JTklUSUFMSVpFUikuXG4gICAqIEBwYXJhbSByZWFzb24gcmVhc29uIGZvciBib290c3RyYXAuIEBzZWUge05nTW9kdWxlUmVhc29ufVxuICAgKiBAcmV0dXJucyBQcm9taXNlIHRvIHRoZSBib290c3RyYXBwZWQgTmdNb2R1bGVSZWYuIE11c3QgcmVzb2x2ZSBpbW1lZGlhdGVseSAobm8gYXN5bmMgaW5pdGlhbGl6YXRpb24pXG4gICAqL1xuICBsb2FkaW5nTW9kdWxlPzogKHJlYXNvbjogTmdNb2R1bGVSZWFzb24pID0+IFByb21pc2U8TmdNb2R1bGVSZWY8Sz4gfCBBcHBsaWNhdGlvblJlZj47XG4gIC8qKlxuICAgKiBTaW1wbGVyIHRoYW4gbG9hZGluZ01vZHVsZSwgdGhpcyB3aWxsIHNob3cgYSB2aWV3IHdoaWxlIHRoZSBhcHAgaXMgYm9vdHN0cmFwcGluZyBhc3luY2hyb25vdXNseS5cbiAgICogQHBhcmFtIHJlYXNvbiByZWFzb24gZm9yIGJvb3RzdHJhcC4gQHNlZSB7TmdNb2R1bGVSZWFzb259XG4gICAqIEByZXR1cm5zIFZpZXcgdGhhdCB3aWxsIGJlIHNob3duIHdoaWxlIGFwcCBib290c1xuICAgKi9cbiAgbGF1bmNoVmlldz86IChyZWFzb246IE5nTW9kdWxlUmVhc29uKSA9PiBBcHBMYXVuY2hWaWV3O1xuICAvKipcbiAgICogV2V0aGVyIHdlIGFyZSBydW5uaW5nIGluIGFuIGVtYmVkZGVkIGNvbnRleHQgKGUuZy4gZW1iZWRkaW5nIE5hdGl2ZVNjcmlwdCBpbiBhbiBleGlzdGluZyBhcHApXG4gICAqL1xuICBlbWJlZGRlZD86IGJvb2xlYW47XG59XG5cbmlmIChpbXBvcnQubWV0YVsnd2VicGFja0hvdCddKSB7XG4gIGltcG9ydC5tZXRhWyd3ZWJwYWNrSG90J10uZGVjbGluZSgpO1xuICBnbG9iYWwuX19vbkxpdmVTeW5jQ29yZSA9ICgpID0+IHtcbiAgICBBcHBsaWNhdGlvbi5nZXRSb290VmlldygpPy5fb25Dc3NTdGF0ZUNoYW5nZSgpO1xuICAgIC8vIGFsbCBvdGhlciBjaGFuZ2VzIGFyZSBhcHBsaWVkIGJ5IHJ1bk5hdGl2ZVNjcmlwdEFuZ3VsYXJBcHBcbiAgfTtcbn1cblxuZnVuY3Rpb24gZW1pdE1vZHVsZUJvb3RzdHJhcEV2ZW50PFQ+KHJlZjogTmdNb2R1bGVSZWY8VD4gfCBBcHBsaWNhdGlvblJlZiwgbmFtZTogJ21haW4nIHwgJ2xvYWRpbmcnLCByZWFzb246IE5nTW9kdWxlUmVhc29uKSB7XG4gIHBvc3RBbmd1bGFyQm9vdHN0cmFwJC5uZXh0KHtcbiAgICBtb2R1bGVUeXBlOiBuYW1lLFxuICAgIHJlZmVyZW5jZTogcmVmLFxuICAgIHJlYXNvbixcbiAgfSk7XG59XG5cbmZ1bmN0aW9uIGRlc3Ryb3lSZWY8VD4ocmVmOiBOZ01vZHVsZVJlZjxUPiB8IEFwcGxpY2F0aW9uUmVmLCBuYW1lOiAnbWFpbicgfCAnbG9hZGluZycsIHJlYXNvbjogTmdNb2R1bGVSZWFzb24pOiB2b2lkO1xuZnVuY3Rpb24gZGVzdHJveVJlZihyZWY6IFBsYXRmb3JtUmVmLCByZWFzb246IE5nTW9kdWxlUmVhc29uKTogdm9pZDtcbmZ1bmN0aW9uIGRlc3Ryb3lSZWY8VD4ocmVmOiBQbGF0Zm9ybVJlZiB8IEFwcGxpY2F0aW9uUmVmIHwgTmdNb2R1bGVSZWY8VD4sIG5hbWU/OiBzdHJpbmcsIHJlYXNvbj86IHN0cmluZyk6IHZvaWQge1xuICBpZiAocmVmKSB7XG4gICAgaWYgKHJlZiBpbnN0YW5jZW9mIFBsYXRmb3JtUmVmKSB7XG4gICAgICBwcmVBbmd1bGFyRGlzcG9zYWwkLm5leHQoe1xuICAgICAgICBtb2R1bGVUeXBlOiAncGxhdGZvcm0nLFxuICAgICAgICByZWZlcmVuY2U6IHJlZixcbiAgICAgICAgcmVhc29uOiBuYW1lLFxuICAgICAgfSk7XG4gICAgfVxuICAgIGlmIChyZWYgaW5zdGFuY2VvZiBOZ01vZHVsZVJlZiB8fCByZWYgaW5zdGFuY2VvZiBBcHBsaWNhdGlvblJlZikge1xuICAgICAgcHJlQW5ndWxhckRpc3Bvc2FsJC5uZXh0KHtcbiAgICAgICAgbW9kdWxlVHlwZTogbmFtZSxcbiAgICAgICAgcmVmZXJlbmNlOiByZWYsXG4gICAgICAgIHJlYXNvbixcbiAgICAgIH0pO1xuICAgIH1cbiAgICByZWYuZGVzdHJveSgpO1xuICB9XG59XG5cbmZ1bmN0aW9uIHJ1blpvbmVTeW5jVGFzayhmbjogKCkgPT4gdm9pZCkge1xuICBpZiAodHlwZW9mIFpvbmUgPT09ICd1bmRlZmluZWQnKSB7XG4gICAgcmV0dXJuO1xuICB9XG4gIGNvbnN0IHpvbmUgPSBab25lLmN1cnJlbnQ7XG4gIGNvbnN0IHRhc2sgPSB6b25lLnNjaGVkdWxlRXZlbnRUYXNrKFxuICAgICdzeW5jX2Z1bmN0aW9uJyxcbiAgICBmbixcbiAgICB7fSxcbiAgICAoKSA9PiB7XG4gICAgICAvL1xuICAgIH0sXG4gICAgKCkgPT4ge1xuICAgICAgLy9cbiAgICB9XG4gICk7XG4gIHRyeSB7XG4gICAgLy8gY29uc29sZS5sb2codGFzay5zdGF0ZSk7XG4gICAgdGFzay5pbnZva2UoKTtcbiAgICAvLyB6b25lLnJ1blRhc2sodGFzayk7XG4gICAgLy8gY29uc29sZS5sb2codGFzay5zdGF0ZSk7XG4gIH0gZmluYWxseSB7XG4gICAgem9uZS5jYW5jZWxUYXNrKHRhc2spO1xuICB9XG59XG5cbmZ1bmN0aW9uIFpvbmVDYW5Xb3JrU3luYygpIHtcbiAgbGV0IGNhblJ1blN5bmMgPSBmYWxzZTtcbiAgcnVuWm9uZVN5bmNUYXNrKCgpID0+IHtcbiAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IChjYW5SdW5TeW5jID0gdHJ1ZSkpO1xuICB9KTtcbiAgcmV0dXJuIGNhblJ1blN5bmM7XG59XG5cbi8qKlxuICogVGVzdHMgaWYgZ2xvYmFsLl9fZHJhaW5NaWNyb3Rhc2tRdWV1ZSBjYW4gYmUgdXNlZCB0byBkcmFpbiBtaWNyb3Rhc2tzXG4gKiBCZWNhdXNlIG9mIFpvbmUuanMsIGV2ZW4gdGhvdWdoIHRoZSBuYXRpdmUgcXVldWUgbWlnaHQgYmUgZHJhaW5lZCwgem9uZSBtaWNyb3Rhc2tzIG1pZ2h0IG5vdCBiZVxuICogQHBhcmFtIG1ha2VUZXN0RHJhaW4gc2hvdWxkIGl0IGRyYWluIHRoZSBjdXJyZW50IG1pY3JvdGFzayBxdWV1ZSB0byBlbnN1cmUgdGhlIHF1ZXVlIGNhbiBiZSBkcmFpbmVkXG4gKiBAcmV0dXJucyBpZiBnbG9iYWwuX19kcmFpbk1pY3JvdGFza1F1ZXVlIGNhbiBiZSBjYWxsZWRcbiAqL1xuZnVuY3Rpb24gbmF0aXZlUXVldWVDYW5CZURyYWluZWQobWFrZVRlc3REcmFpbjogYm9vbGVhbikge1xuICBpZiAodHlwZW9mIChnbG9iYWwgYXMgYW55KS5fX2RyYWluTWljcm90YXNrUXVldWUgIT09ICdmdW5jdGlvbicpIHtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cbiAgaWYgKCFtYWtlVGVzdERyYWluKSB7XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cbiAgbGV0IGNhblJ1blN5bmMgPSBmYWxzZTtcbiAgUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiAoY2FuUnVuU3luYyA9IHRydWUpKTtcbiAgKGdsb2JhbCBhcyBhbnkpLl9fZHJhaW5NaWNyb3Rhc2tRdWV1ZSgpO1xuICByZXR1cm4gY2FuUnVuU3luYztcbn1cblxuLyoqXG4gKiBSdW5zIGEgZnVuY3Rpb24gaW4gdGhlIG1vc3Qgc3luY2hyb25vdXMgd2F5IHBvc3NpYmxlXG4gKiBAcGFyYW0gZm4gZnVuY3Rpb24gdG8gcnVuXG4gKiBAcGFyYW0gZG9uZSBmdW5jdGlvbiB0byBjaGFpbiBhZnRlciBkb25lXG4gKi9cbmZ1bmN0aW9uIHJ1blN5bmNocm9ub3VzbHkoZm46ICgpID0+IHZvaWQsIGRvbmU/OiAoKSA9PiB2b2lkKTogdm9pZCB7XG4gIGlmICh0eXBlb2YgWm9uZSAhPT0gJ3VuZGVmaW5lZCcgJiYgWm9uZUNhbldvcmtTeW5jKCkpIHtcbiAgICBydW5ab25lU3luY1Rhc2soZm4pO1xuICAgIGRvbmU/LigpO1xuICAgIHJldHVybjtcbiAgfVxuICBpZiAobmF0aXZlUXVldWVDYW5CZURyYWluZWQodHJ1ZSkpIHtcbiAgICBmbigpO1xuICAgIChnbG9iYWwgYXMgYW55KS5fX2RyYWluTWljcm90YXNrUXVldWUoKTtcbiAgICBkb25lPy4oKTtcbiAgICByZXR1cm47XG4gIH1cbiAgZm4oKTtcbiAgaWYgKGRvbmUpIHtcbiAgICBVdGlscy5xdWV1ZU1hY3JvdGFzayhkb25lKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBjcmVhdGVQcm92aWRlcnNDb25maWcob3B0aW9ucz86IEFwcGxpY2F0aW9uQ29uZmlnKSB7XG4gIHJldHVybiB7XG4gICAgYXBwUHJvdmlkZXJzOiBbLi4uTkFUSVZFU0NSSVBUX01PRFVMRV9QUk9WSURFUlMsIC4uLk5BVElWRVNDUklQVF9NT0RVTEVfU1RBVElDX1BST1ZJREVSUywgLi4uKG9wdGlvbnM/LnByb3ZpZGVycyA/PyBbXSldLFxuICAgIC8vIHBsYXRmb3JtUHJvdmlkZXJzOiBJTlRFUk5BTF9CUk9XU0VSX1BMQVRGT1JNX1BST1ZJREVSU1xuICB9O1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEFwcGxpY2F0aW9uQ29uZmlnIHtcbiAgLyoqXG4gICAqIExpc3Qgb2YgcHJvdmlkZXJzIHRoYXQgc2hvdWxkIGJlIGF2YWlsYWJsZSB0byB0aGUgcm9vdCBjb21wb25lbnQgYW5kIGFsbCBpdHMgY2hpbGRyZW4uXG4gICAqL1xuICBwcm92aWRlcnM6IEFycmF5PFByb3ZpZGVyIHwgRW52aXJvbm1lbnRQcm92aWRlcnM+O1xufVxuZXhwb3J0IGZ1bmN0aW9uIGJvb3RzdHJhcEFwcGxpY2F0aW9uKHJvb3RDb21wb25lbnQ6IFR5cGU8dW5rbm93bj4sIG9wdGlvbnM/OiBBcHBsaWNhdGlvbkNvbmZpZyk6IFByb21pc2U8QXBwbGljYXRpb25SZWY+IHtcbiAgcmV0dXJuIGludGVybmFsQ3JlYXRlQXBwbGljYXRpb24oeyByb290Q29tcG9uZW50LCAuLi5jcmVhdGVQcm92aWRlcnNDb25maWcob3B0aW9ucykgfSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBydW5OYXRpdmVTY3JpcHRBbmd1bGFyQXBwPFQsIEs+KG9wdGlvbnM6IEFwcFJ1bk9wdGlvbnM8VCwgSz4pIHtcbiAgbGV0IG1haW5Nb2R1bGVSZWY6IE5nTW9kdWxlUmVmPFQ+IHwgQXBwbGljYXRpb25SZWYgPSBudWxsO1xuICBsZXQgbG9hZGluZ01vZHVsZVJlZjogTmdNb2R1bGVSZWY8Sz4gfCBBcHBsaWNhdGlvblJlZjtcbiAgbGV0IHBsYXRmb3JtUmVmOiBQbGF0Zm9ybVJlZiA9IG51bGw7XG4gIGxldCBib290c3RyYXBJZCA9IC0xO1xuICBjb25zdCB1cGRhdGVQbGF0Zm9ybVJlZiA9IChtb2R1bGVSZWY6IE5nTW9kdWxlUmVmPFQgfCBLPiB8IEFwcGxpY2F0aW9uUmVmLCByZWFzb246IE5nTW9kdWxlUmVhc29uKSA9PiB7XG4gICAgY29uc3QgbmV3UGxhdGZvcm1SZWYgPSBtb2R1bGVSZWYuaW5qZWN0b3IuZ2V0KFBsYXRmb3JtUmVmKTtcbiAgICBpZiAobmV3UGxhdGZvcm1SZWYgPT09IHBsYXRmb3JtUmVmKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGRlc3Ryb3lSZWYocGxhdGZvcm1SZWYsIHJlYXNvbik7XG4gICAgcGxhdGZvcm1SZWYgPSBuZXdQbGF0Zm9ybVJlZjtcbiAgICBwbGF0Zm9ybVJlZi5vbkRlc3Ryb3koKCkgPT4gKHBsYXRmb3JtUmVmID0gcGxhdGZvcm1SZWYgPT09IG5ld1BsYXRmb3JtUmVmID8gbnVsbCA6IHBsYXRmb3JtUmVmKSk7XG4gIH07XG4gIGxldCBsYXVuY2hFdmVudERvbmUgPSB0cnVlO1xuICBsZXQgdGFyZ2V0Um9vdFZpZXc6IFZpZXcgPSBudWxsO1xuICBjb25zdCBzZXRSb290VmlldyA9IChyZWY6IE5nTW9kdWxlUmVmPFQgfCBLPiB8IEFwcGxpY2F0aW9uUmVmIHwgVmlldykgPT4ge1xuICAgIGlmIChib290c3RyYXBJZCA9PT0gLTEpIHtcbiAgICAgIC8vIHRyZWF0IGVkZ2UgY2FzZXNcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgaWYgKHJlZiBpbnN0YW5jZW9mIE5nTW9kdWxlUmVmIHx8IHJlZiBpbnN0YW5jZW9mIEFwcGxpY2F0aW9uUmVmKSB7XG4gICAgICBpZiAocmVmLmluamVjdG9yLmdldChESVNBQkxFX1JPT1RfVklFV19IQU5ETElORywgZmFsc2UpKSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKHJlZlsnX19kaXNhYmxlX3Jvb3Rfdmlld19oYW5kbGluZyddKSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICB9XG4gICAgQXBwbGljYXRpb24uZ2V0Um9vdFZpZXcoKT8uX2Nsb3NlQWxsTW9kYWxWaWV3c0ludGVybmFsKCk7IC8vIGNsZWFudXAgb2xkIHJvb3R2aWV3XG4gICAgTmF0aXZlU2NyaXB0RGVidWcuYm9vdHN0cmFwTG9nKGBTZXR0aW5nIFJvb3RWaWV3ICR7bGF1bmNoRXZlbnREb25lID8gJ291dHNpZGUgb2YnIDogJ2R1cmluZyd9IGxhdW5jaCBldmVudGApO1xuICAgIC8vIFRPRE86IGNoZWNrIGZvciBsZWFrcyB3aGVuIHJvb3QgdmlldyBpc24ndCBwcm9wZXJseSBkZXN0cm95ZWRcbiAgICBpZiAocmVmIGluc3RhbmNlb2YgVmlldykge1xuICAgICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmlzTG9nRW5hYmxlZCgpKSB7XG4gICAgICAgIE5hdGl2ZVNjcmlwdERlYnVnLmJvb3RzdHJhcExvZyhgU2V0dGluZyBSb290VmlldyB0byAke3JlZn1gKTtcbiAgICAgIH1cbiAgICAgIGlmIChvcHRpb25zLmVtYmVkZGVkKSB7XG4gICAgICAgIEFwcGxpY2F0aW9uLnJ1bih7IGNyZWF0ZTogKCkgPT4gcmVmIH0pO1xuICAgICAgfSBlbHNlIGlmIChsYXVuY2hFdmVudERvbmUpIHtcbiAgICAgICAgQXBwbGljYXRpb24ucmVzZXRSb290Vmlldyh7IGNyZWF0ZTogKCkgPT4gcmVmIH0pO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGFyZ2V0Um9vdFZpZXcgPSByZWY7XG4gICAgICB9XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGNvbnN0IHZpZXcgPSByZWYuaW5qZWN0b3IuZ2V0KEFQUF9ST09UX1ZJRVcpIGFzIEFwcEhvc3RWaWV3IHwgVmlldztcbiAgICBjb25zdCBuZXdSb290ID0gdmlldyBpbnN0YW5jZW9mIEFwcEhvc3RWaWV3ID8gdmlldy5jb250ZW50IDogdmlldztcbiAgICBpZiAoTmF0aXZlU2NyaXB0RGVidWcuaXNMb2dFbmFibGVkKCkpIHtcbiAgICAgIE5hdGl2ZVNjcmlwdERlYnVnLmJvb3RzdHJhcExvZyhgU2V0dGluZyBSb290VmlldyB0byAke25ld1Jvb3R9YCk7XG4gICAgfVxuICAgIGlmIChvcHRpb25zLmVtYmVkZGVkKSB7XG4gICAgICBBcHBsaWNhdGlvbi5ydW4oeyBjcmVhdGU6ICgpID0+IG5ld1Jvb3QgfSk7XG4gICAgfSBlbHNlIGlmIChsYXVuY2hFdmVudERvbmUpIHtcbiAgICAgIEFwcGxpY2F0aW9uLnJlc2V0Um9vdFZpZXcoeyBjcmVhdGU6ICgpID0+IG5ld1Jvb3QgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRhcmdldFJvb3RWaWV3ID0gbmV3Um9vdDtcbiAgICB9XG4gIH07XG4gIGNvbnN0IHNob3dFcnJvclVJID0gKGVycm9yOiBFcnJvcikgPT4ge1xuICAgIGNvbnN0IG1lc3NhZ2UgPSBlcnJvci5tZXNzYWdlICsgJ1xcblxcbicgKyBlcnJvci5zdGFjaztcbiAgICBjb25zdCBlcnJvclRleHRCb3ggPSBuZXcgVGV4dFZpZXcoKTtcbiAgICBlcnJvclRleHRCb3gudGV4dCA9IG1lc3NhZ2U7XG4gICAgZXJyb3JUZXh0Qm94LmNvbG9yID0gbmV3IENvbG9yKCdyZWQnKTtcbiAgICBzZXRSb290VmlldyhlcnJvclRleHRCb3gpO1xuICB9O1xuICBjb25zdCBib290c3RyYXBSb290ID0gKHJlYXNvbjogTmdNb2R1bGVSZWFzb24pID0+IHtcbiAgICB0cnkge1xuICAgICAgYm9vdHN0cmFwSWQgPSBEYXRlLm5vdygpO1xuICAgICAgY29uc3QgY3VycmVudEJvb3RzdHJhcElkID0gYm9vdHN0cmFwSWQ7XG4gICAgICBsZXQgYm9vdHN0cmFwcGVkID0gZmFsc2U7XG4gICAgICBsZXQgb25NYWluQm9vdHN0cmFwID0gKCkgPT4ge1xuICAgICAgICBzZXRSb290VmlldyhtYWluTW9kdWxlUmVmKTtcbiAgICAgIH07XG4gICAgICBydW5TeW5jaHJvbm91c2x5KFxuICAgICAgICAoKSA9PlxuICAgICAgICAgIG9wdGlvbnMuYXBwTW9kdWxlQm9vdHN0cmFwKHJlYXNvbikudGhlbihcbiAgICAgICAgICAgIChyZWYpID0+IHtcbiAgICAgICAgICAgICAgaWYgKGN1cnJlbnRCb290c3RyYXBJZCAhPT0gYm9vdHN0cmFwSWQpIHtcbiAgICAgICAgICAgICAgICAvLyB0aGlzIG1vZHVsZSBpcyBvbGQgYW5kIG5vdCBuZWVkZWQgYW55bW9yZVxuICAgICAgICAgICAgICAgIC8vIHRoaXMgbWF5IGhhcHBlbiB3aGVuIGRldmVsb3BlciB1c2VzIGFzeW5jIGFwcCBpbml0aWFsaXplciBhbmQgdGhlIHVzZXIgZXhpdHMgdGhlIGFwcCBiZWZvcmUgdGhpcyBib290c3RyYXBzXG4gICAgICAgICAgICAgICAgcmVmLmRlc3Ryb3koKTtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgbWFpbk1vZHVsZVJlZiA9IHJlZjtcblxuICAgICAgICAgICAgICAocmVmIGluc3RhbmNlb2YgQXBwbGljYXRpb25SZWYgPyByZWYuY29tcG9uZW50c1swXSA6IHJlZikub25EZXN0cm95KCgpID0+IChtYWluTW9kdWxlUmVmID0gbWFpbk1vZHVsZVJlZiA9PT0gcmVmID8gbnVsbCA6IG1haW5Nb2R1bGVSZWYpKTtcbiAgICAgICAgICAgICAgdXBkYXRlUGxhdGZvcm1SZWYocmVmLCByZWFzb24pO1xuICAgICAgICAgICAgICBjb25zdCBzdHlsZVRhZyA9IHJlZi5pbmplY3Rvci5nZXQoTkFUSVZFU0NSSVBUX1JPT1RfTU9EVUxFX0lEKTtcbiAgICAgICAgICAgICAgKHJlZiBpbnN0YW5jZW9mIEFwcGxpY2F0aW9uUmVmID8gcmVmLmNvbXBvbmVudHNbMF0gOiByZWYpLm9uRGVzdHJveSgoKSA9PiB7XG4gICAgICAgICAgICAgICAgcmVtb3ZlVGFnZ2VkQWRkaXRpb25hbENTUyhzdHlsZVRhZyk7XG4gICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICBib290c3RyYXBwZWQgPSB0cnVlO1xuICAgICAgICAgICAgICBvbk1haW5Cb290c3RyYXAoKTtcbiAgICAgICAgICAgICAgZW1pdE1vZHVsZUJvb3RzdHJhcEV2ZW50KHJlZiwgJ21haW4nLCByZWFzb24pO1xuICAgICAgICAgICAgICAvLyBib290c3RyYXBwZWQgY29tcG9uZW50OiAocmVmIGFzIGFueSkuX2Jvb3RzdHJhcENvbXBvbmVudHNbMF07XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgKGVycikgPT4ge1xuICAgICAgICAgICAgICBib290c3RyYXBwZWQgPSB0cnVlO1xuICAgICAgICAgICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5ib290c3RyYXBMb2dFcnJvcihgRXJyb3IgYm9vdHN0cmFwcGluZyBhcHAgbW9kdWxlOlxcbiR7ZXJyLm1lc3NhZ2V9XFxuXFxuJHtlcnIuc3RhY2t9YCk7XG4gICAgICAgICAgICAgIHNob3dFcnJvclVJKGVycik7XG4gICAgICAgICAgICAgIHRocm93IGVycjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICApLFxuICAgICAgICAoKSA9PiB7XG4gICAgICAgICAgaWYgKGN1cnJlbnRCb290c3RyYXBJZCAhPT0gYm9vdHN0cmFwSWQpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICB9XG4gICAgICAgICAgaWYgKCFib290c3RyYXBwZWQpIHtcbiAgICAgICAgICAgIGlmIChvcHRpb25zLmxvYWRpbmdNb2R1bGUpIHtcbiAgICAgICAgICAgICAgcnVuU3luY2hyb25vdXNseSgoKSA9PlxuICAgICAgICAgICAgICAgIG9wdGlvbnMubG9hZGluZ01vZHVsZShyZWFzb24pLnRoZW4oXG4gICAgICAgICAgICAgICAgICAobG9hZGluZ1JlZikgPT4ge1xuICAgICAgICAgICAgICAgICAgICBpZiAoY3VycmVudEJvb3RzdHJhcElkICE9PSBib290c3RyYXBJZCkge1xuICAgICAgICAgICAgICAgICAgICAgIC8vIHRoaXMgbW9kdWxlIGlzIG9sZCBhbmQgbm90IG5lZWRlZCBhbnltb3JlXG4gICAgICAgICAgICAgICAgICAgICAgLy8gdGhpcyBtYXkgaGFwcGVuIHdoZW4gZGV2ZWxvcGVyIHVzZXMgYXN5bmMgYXBwIGluaXRpYWxpemVyIGFuZCB0aGUgdXNlciBleGl0cyB0aGUgYXBwIGJlZm9yZSB0aGlzIGJvb3RzdHJhcHNcbiAgICAgICAgICAgICAgICAgICAgICBsb2FkaW5nUmVmLmRlc3Ryb3koKTtcbiAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgbG9hZGluZ01vZHVsZVJlZiA9IGxvYWRpbmdSZWY7XG4gICAgICAgICAgICAgICAgICAgIChsb2FkaW5nTW9kdWxlUmVmIGluc3RhbmNlb2YgQXBwbGljYXRpb25SZWYgPyBsb2FkaW5nTW9kdWxlUmVmLmNvbXBvbmVudHNbMF0gOiBsb2FkaW5nTW9kdWxlUmVmKS5vbkRlc3Ryb3koKCkgPT4gKGxvYWRpbmdNb2R1bGVSZWYgPSBsb2FkaW5nTW9kdWxlUmVmID09PSBsb2FkaW5nUmVmID8gbnVsbCA6IGxvYWRpbmdNb2R1bGVSZWYpKTtcbiAgICAgICAgICAgICAgICAgICAgdXBkYXRlUGxhdGZvcm1SZWYobG9hZGluZ1JlZiwgcmVhc29uKTtcbiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3R5bGVUYWcgPSBsb2FkaW5nTW9kdWxlUmVmLmluamVjdG9yLmdldChOQVRJVkVTQ1JJUFRfUk9PVF9NT0RVTEVfSUQpO1xuICAgICAgICAgICAgICAgICAgICAobG9hZGluZ01vZHVsZVJlZiBpbnN0YW5jZW9mIEFwcGxpY2F0aW9uUmVmID8gbG9hZGluZ01vZHVsZVJlZi5jb21wb25lbnRzWzBdIDogbG9hZGluZ01vZHVsZVJlZikub25EZXN0cm95KCgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICByZW1vdmVUYWdnZWRBZGRpdGlvbmFsQ1NTKHN0eWxlVGFnKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIHNldFJvb3RWaWV3KGxvYWRpbmdSZWYpO1xuICAgICAgICAgICAgICAgICAgICBvbk1haW5Cb290c3RyYXAgPSAoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgLy8gZGVsYXkgc2hvd2luZyB0aGUgbmV3IHJvb3R2aWV3IHRvIGF2b2lkIGZsYXNoZXNcbiAgICAgICAgICAgICAgICAgICAgICBVdGlscy5xdWV1ZU1hY3JvdGFzaygoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBsb2FkaW5nU2VydmljZSA9IGxvYWRpbmdNb2R1bGVSZWYuaW5qZWN0b3IuZ2V0KE5hdGl2ZVNjcmlwdExvYWRpbmdTZXJ2aWNlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGxvYWRpbmdNb2R1bGVSZWYuaW5qZWN0b3IuZ2V0KE5nWm9uZSkucnVuKCgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgbG9hZGluZ1NlcnZpY2UuX25vdGlmeU1haW5Nb2R1bGVSZWFkeSgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBsb2FkaW5nU2VydmljZS5yZWFkeVRvRGVzdHJveSRcbiAgICAgICAgICAgICAgICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlsdGVyKChyZWFkeSkgPT4gcmVhZHkpLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRha2UoMSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAuc3Vic2NyaWJlKCgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZXN0cm95UmVmKGxvYWRpbmdNb2R1bGVSZWYsICdsb2FkaW5nJywgcmVhc29uKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2FkaW5nTW9kdWxlUmVmID0gbnVsbDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZXRSb290VmlldyhtYWluTW9kdWxlUmVmKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgICAgIGVtaXRNb2R1bGVCb290c3RyYXBFdmVudChsb2FkaW5nTW9kdWxlUmVmLCAnbG9hZGluZycsIHJlYXNvbik7XG4gICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgKGVycikgPT4ge1xuICAgICAgICAgICAgICAgICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5ib290c3RyYXBMb2dFcnJvcihgRXJyb3IgYm9vdHN0cmFwcGluZyBsb2FkaW5nIG1vZHVsZTpcXG4ke2Vyci5tZXNzYWdlfVxcblxcbiR7ZXJyLnN0YWNrfWApO1xuICAgICAgICAgICAgICAgICAgICBzaG93RXJyb3JVSShlcnIpO1xuICAgICAgICAgICAgICAgICAgICB0aHJvdyBlcnI7XG4gICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChvcHRpb25zLmxhdW5jaFZpZXcpIHtcbiAgICAgICAgICAgICAgbGV0IGxhdW5jaFZpZXcgPSBvcHRpb25zLmxhdW5jaFZpZXcocmVhc29uKTtcbiAgICAgICAgICAgICAgc2V0Um9vdFZpZXcobGF1bmNoVmlldyk7XG4gICAgICAgICAgICAgIGlmIChsYXVuY2hWaWV3LnN0YXJ0QW5pbWF0aW9uKSB7XG4gICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAvLyBlbnN1cmUgbGF1bmNoIGFuaW1hdGlvbiBpcyBleGVjdXRlZCBhZnRlciBsYXVuY2hWaWV3IGFkZGVkIHRvIHZpZXcgc3RhY2tcbiAgICAgICAgICAgICAgICAgIGxhdW5jaFZpZXcuc3RhcnRBbmltYXRpb24oKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICBvbk1haW5Cb290c3RyYXAgPSAoKSA9PiB7XG4gICAgICAgICAgICAgICAgLy8gZGVsYXkgc2hvd2luZyB0aGUgbmV3IHJvb3R2aWV3IHRvIGF2b2lkIGZsYXNoZXNcbiAgICAgICAgICAgICAgICBVdGlscy5xdWV1ZU1hY3JvdGFzaygoKSA9PiB7XG4gICAgICAgICAgICAgICAgICBpZiAobGF1bmNoVmlldy5jbGVhbnVwKSB7XG4gICAgICAgICAgICAgICAgICAgIGxhdW5jaFZpZXdcbiAgICAgICAgICAgICAgICAgICAgICAuY2xlYW51cCgpXG4gICAgICAgICAgICAgICAgICAgICAgLmNhdGNoKClcbiAgICAgICAgICAgICAgICAgICAgICAudGhlbigoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBsYXVuY2hWaWV3ID0gbnVsbDtcbiAgICAgICAgICAgICAgICAgICAgICAgIHNldFJvb3RWaWV3KG1haW5Nb2R1bGVSZWYpO1xuICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgbGF1bmNoVmlldyA9IG51bGw7XG4gICAgICAgICAgICAgICAgICAgIHNldFJvb3RWaWV3KG1haW5Nb2R1bGVSZWYpO1xuICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgY29uc29sZS53YXJuKCdBcHAgaXMgYm9vdHN0cmFwcGluZyBhc3luY2hyb25vdXNseSAobGlrZWx5IEFQUF9JTklUSUFMSVpFUikgYnV0IGRpZCBub3QgcHJvdmlkZSBhIGxhdW5jaFZpZXcgb3IgTG9hZGluZ01vZHVsZS4nKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5ib290c3RyYXBMb2dFcnJvcihgRXJyb3IgaW4gQm9vdHN0cmFwIEZ1bmN0aW9uOlxcbiR7ZXJyLm1lc3NhZ2V9XFxuXFxuJHtlcnIuc3RhY2t9YCk7XG4gICAgfVxuICB9O1xuICBjb25zdCBkaXNwb3NlUGxhdGZvcm0gPSAocmVhc29uOiBOZ01vZHVsZVJlYXNvbikgPT4ge1xuICAgIGRlc3Ryb3lSZWYocGxhdGZvcm1SZWYsIHJlYXNvbik7XG4gICAgcGxhdGZvcm1SZWYgPSBudWxsO1xuICB9O1xuICBjb25zdCBkaXNwb3NlTGFzdE1vZHVsZXMgPSAocmVhc29uOiBOZ01vZHVsZVJlYXNvbikgPT4ge1xuICAgIC8vIHJlc2V0IGJvb3RzdHJhcCBJRCB0byBtYWtlIHN1cmUgYW55IG1vZHVsZXMgYm9vdHN0cmFwcGVkIGFmdGVyIHRoaXMgYXJlIGRpc2NhcmRlZFxuICAgIGJvb3RzdHJhcElkID0gLTE7XG4gICAgZGVzdHJveVJlZihsb2FkaW5nTW9kdWxlUmVmLCAnbG9hZGluZycsIHJlYXNvbik7XG4gICAgbG9hZGluZ01vZHVsZVJlZiA9IG51bGw7XG4gICAgZGVzdHJveVJlZihtYWluTW9kdWxlUmVmLCAnbWFpbicsIHJlYXNvbik7XG4gICAgbWFpbk1vZHVsZVJlZiA9IG51bGw7XG4gIH07XG4gIGNvbnN0IGxhdW5jaENhbGxiYWNrID0gcHJvZmlsZSgnQG5hdGl2ZXNjcmlwdC9hbmd1bGFyL3BsYXRmb3JtLWNvbW1vbi5sYXVuY2hDYWxsYmFjaycsIChhcmdzOiBMYXVuY2hFdmVudERhdGEpID0+IHtcbiAgICBsYXVuY2hFdmVudERvbmUgPSBmYWxzZTtcbiAgICBib290c3RyYXBSb290KCdhcHBsYXVuY2gnKTtcbiAgICBsYXVuY2hFdmVudERvbmUgPSB0cnVlO1xuICAgIGFyZ3Mucm9vdCA9IHRhcmdldFJvb3RWaWV3IHx8IG51bGw7XG4gIH0pO1xuICBjb25zdCBleGl0Q2FsbGJhY2sgPSBwcm9maWxlKCdAbmF0aXZlc2NyaXB0L2FuZ3VsYXIvcGxhdGZvcm0tY29tbW9uLmV4aXRDYWxsYmFjaycsIChhcmdzOiBBcHBsaWNhdGlvbkV2ZW50RGF0YSkgPT4ge1xuICAgIGRpc3Bvc2VMYXN0TW9kdWxlcygnYXBwZXhpdCcpO1xuICB9KTtcblxuICBsZXQgb2xkQWRkRXZlbnRMaXN0ZW5lcjtcbiAgaWYgKHR5cGVvZiBab25lICE9PSAndW5kZWZpbmVkJyAmJiBnbG9iYWwuTmF0aXZlU2NyaXB0R2xvYmFscz8uZXZlbnRzPy5bWm9uZS5fX3N5bWJvbF9fKCdhZGRFdmVudExpc3RlbmVyJyldKSB7XG4gICAgb2xkQWRkRXZlbnRMaXN0ZW5lciA9IGdsb2JhbC5OYXRpdmVTY3JpcHRHbG9iYWxzLmV2ZW50cy5hZGRFdmVudExpc3RlbmVyO1xuICAgIGdsb2JhbC5OYXRpdmVTY3JpcHRHbG9iYWxzLmV2ZW50cy5hZGRFdmVudExpc3RlbmVyID0gZ2xvYmFsLk5hdGl2ZVNjcmlwdEdsb2JhbHMuZXZlbnRzW1pvbmUuX19zeW1ib2xfXygnYWRkRXZlbnRMaXN0ZW5lcicpXTtcbiAgfVxuICBpZiAoIW9wdGlvbnMuZW1iZWRkZWQpIHtcbiAgICBBcHBsaWNhdGlvbi5vbihBcHBsaWNhdGlvbi5sYXVuY2hFdmVudCwgbGF1bmNoQ2FsbGJhY2spO1xuICB9XG4gIEFwcGxpY2F0aW9uLm9uKEFwcGxpY2F0aW9uLmV4aXRFdmVudCwgZXhpdENhbGxiYWNrKTtcbiAgaWYgKG9sZEFkZEV2ZW50TGlzdGVuZXIpIHtcbiAgICBnbG9iYWwuTmF0aXZlU2NyaXB0R2xvYmFscy5ldmVudHMuYWRkRXZlbnRMaXN0ZW5lciA9IG9sZEFkZEV2ZW50TGlzdGVuZXI7XG4gIH1cbiAgaWYgKGltcG9ydC5tZXRhWyd3ZWJwYWNrSG90J10pIHtcbiAgICAvLyBoYW5kbGUgSE1SIEFwcGxpY2F0aW9uLnJ1blxuICAgIGdsb2JhbFsnX19kaXNwb3NlX2FwcF9uZ19wbGF0Zm9ybV9fJ10gPSAoKSA9PiB7XG4gICAgICBkaXNwb3NlUGxhdGZvcm0oJ2hvdHJlbG9hZCcpO1xuICAgIH07XG4gICAgZ2xvYmFsWydfX2Rpc3Bvc2VfYXBwX25nX21vZHVsZXNfXyddID0gKCkgPT4ge1xuICAgICAgZGlzcG9zZUxhc3RNb2R1bGVzKCdob3RyZWxvYWQnKTtcbiAgICB9O1xuICAgIGdsb2JhbFsnX19ib290c3RyYXBfYXBwX25nX21vZHVsZXNfXyddID0gKCkgPT4ge1xuICAgICAgYm9vdHN0cmFwUm9vdCgnaG90cmVsb2FkJyk7XG4gICAgfTtcbiAgICBnbG9iYWxbJ19fY2xlYW51cF9uZ19ob3RfXyddID0gKCkgPT4ge1xuICAgICAgQXBwbGljYXRpb24ub2ZmKEFwcGxpY2F0aW9uLmxhdW5jaEV2ZW50LCBsYXVuY2hDYWxsYmFjayk7XG4gICAgICBBcHBsaWNhdGlvbi5vZmYoQXBwbGljYXRpb24uZXhpdEV2ZW50LCBleGl0Q2FsbGJhY2spO1xuICAgICAgZGlzcG9zZUxhc3RNb2R1bGVzKCdob3RyZWxvYWQnKTtcbiAgICAgIGRpc3Bvc2VQbGF0Zm9ybSgnaG90cmVsb2FkJyk7XG4gICAgfTtcbiAgICBnbG9iYWxbJ19fcmVib290X25nX21vZHVsZXNfXyddID0gKHNob3VsZERpc3Bvc2VQbGF0Zm9ybTogYm9vbGVhbiA9IGZhbHNlKSA9PiB7XG4gICAgICBkaXNwb3NlTGFzdE1vZHVsZXMoJ2hvdHJlbG9hZCcpO1xuICAgICAgaWYgKHNob3VsZERpc3Bvc2VQbGF0Zm9ybSkge1xuICAgICAgICBkaXNwb3NlUGxhdGZvcm0oJ2hvdHJlbG9hZCcpO1xuICAgICAgfVxuICAgICAgYm9vdHN0cmFwUm9vdCgnaG90cmVsb2FkJyk7XG4gICAgfTtcblxuICAgIGlmICghQXBwbGljYXRpb24uaGFzTGF1bmNoZWQoKSkge1xuICAgICAgQXBwbGljYXRpb24ucnVuKCk7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGJvb3RzdHJhcFJvb3QoJ2hvdHJlbG9hZCcpO1xuICAgIHJldHVybjtcbiAgfVxuXG4gIGlmIChvcHRpb25zLmVtYmVkZGVkKSB7XG4gICAgYm9vdHN0cmFwUm9vdCgnYXBwbGF1bmNoJyk7XG4gIH0gZWxzZSB7XG4gICAgQXBwbGljYXRpb24ucnVuKCk7XG4gIH1cbn1cbiJdfQ==
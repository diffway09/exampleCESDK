import { __decorate, __metadata, __param } from "tslib";
import { ApplicationRef, ComponentFactoryResolver, Injector, Optional } from '@angular/core';
import { Application, ContentView, Frame } from '@nativescript/core';
import { fromEvent, Subject } from 'rxjs';
import { take } from 'rxjs/operators';
import { AppHostAsyncView, AppHostView } from '../../app-host-view';
import { NSLocationStrategy } from '../../legacy/router/ns-location-strategy';
import { once } from '../../utils/general';
import { NgViewRef } from '../../view-refs';
import { DetachedLoader } from '../detached-loader';
import { NativeScriptDomPortalOutlet } from '../portal/nsdom-portal-outlet';
import { NativeDialogConfig } from './dialog-config';
let NativeModalRef = class NativeModalRef {
    constructor(_config, _injector, location) {
        this._config = _config;
        this._injector = _injector;
        this.location = location;
        this.stateChanged = new Subject();
        this.onDismiss = new Subject();
        this._isDismissed = false;
        const nativeElement = this._config.renderIn === 'root' ? Application.getRootView() : this._config.renderIn === 'viewContainerRef' ? this._config.viewContainerRef?.element.nativeElement : this._config.renderIn;
        let parentView = nativeElement || Application.getRootView();
        if ((parentView instanceof AppHostView || parentView instanceof AppHostAsyncView) && parentView.ngAppRoot) {
            parentView = parentView.ngAppRoot;
        }
        // _ngDialogRoot is the first child of the previously detached proxy.
        // It should have 'viewController' (iOS) or '_dialogFragment' (Android) available for
        // presenting future modal views.
        while (parentView._modal || parentView._ngDialogRoot) {
            parentView = parentView._modal || parentView._ngDialogRoot;
        }
        this.parentView = parentView;
        this._closeCallback = once(async () => {
            this.stateChanged.next({ state: 'closing' });
            if (!this._isDismissed) {
                this.modalViewRef.firstNativeLikeView?.closeModal();
            }
            await this.location?._closeModalNavigation();
            // this.detachedLoaderRef?.destroy();
            if (this.modalViewRef?.firstNativeLikeView.isLoaded) {
                fromEvent(this.modalViewRef.firstNativeLikeView, 'unloaded')
                    .pipe(take(1))
                    .subscribe(() => this.stateChanged.next({ state: 'closed' }));
            }
            else {
                this.stateChanged.next({ state: 'closed' });
            }
        });
    }
    _generateDetachedContainer(vcRef) {
        const detachedFactory = (this._config.componentFactoryResolver || this._injector.get(ComponentFactoryResolver)).resolveComponentFactory(DetachedLoader);
        if (vcRef) {
            this.detachedLoaderRef = vcRef.createComponent(detachedFactory);
        }
        else {
            this.detachedLoaderRef = detachedFactory.create(this._config.viewContainerRef?.injector || this._injector);
            this._injector.get(ApplicationRef).attachView(this.detachedLoaderRef.hostView);
        }
        this.detachedLoaderRef.changeDetectorRef.detectChanges();
    }
    attachTemplatePortal(portal) {
        this.startModalNavigation();
        const vcRef = portal.viewContainerRef || this._config.viewContainerRef;
        this._generateDetachedContainer(vcRef);
        portal.viewContainerRef = this.detachedLoaderRef.instance.vc;
        const targetView = new ContentView();
        this.portalOutlet = new NativeScriptDomPortalOutlet(targetView, this._config.componentFactoryResolver || this._injector.get(ComponentFactoryResolver), this._injector.get(ApplicationRef), this._injector);
        const templateRef = this.portalOutlet.attach(portal);
        this.modalViewRef = new NgViewRef(templateRef);
        this.modalViewRef.firstNativeLikeView['__ng_modal_id__'] = this._id;
        // if we don't detach the view from its parent, ios gets mad
        this.modalViewRef.detachNativeLikeView();
        const userOptions = this._config.nativeOptions || {};
        this.parentView.showModal(this.modalViewRef.firstNativeLikeView, {
            context: null,
            ...userOptions,
            closeCallback: async () => {
                await this.location?._closeModalNavigation();
                this.onDismiss.next();
                this.onDismiss.complete();
            },
            cancelable: !this._config.disableClose,
        });
        //   if (this.modalView !== templateRef.rootNodes[0]) {
        //     componentRef.location.nativeElement._ngDialogRoot = this.modalView;
        //   }
        return templateRef;
    }
    attachComponentPortal(portal) {
        this.startModalNavigation();
        const targetView = new ContentView();
        this.portalOutlet = new NativeScriptDomPortalOutlet(targetView, this._config.componentFactoryResolver || this._injector.get(ComponentFactoryResolver), this._injector.get(ApplicationRef), this._injector);
        const componentRef = this.portalOutlet.attach(portal);
        componentRef.changeDetectorRef.detectChanges();
        this.modalViewRef = new NgViewRef(componentRef);
        if (this.modalViewRef.firstNativeLikeView !== this.modalViewRef.view) {
            this.modalViewRef.view._ngDialogRoot = this.modalViewRef.firstNativeLikeView;
        }
        this.modalViewRef.firstNativeLikeView['__ng_modal_id__'] = this._id;
        // if we don't detach the view from its parent, ios gets mad
        this.modalViewRef.detachNativeLikeView();
        const userOptions = this._config.nativeOptions || {};
        this.parentView.showModal(this.modalViewRef.firstNativeLikeView, {
            context: null,
            ...userOptions,
            closeCallback: async () => {
                this._isDismissed = true;
                this._closeCallback(); // close callback can only be called once, so we call it here to setup the exit events
                this.onDismiss.next();
                this.onDismiss.complete();
            },
            cancelable: !this._config.disableClose,
        });
        return componentRef;
    }
    _startExitAnimation() {
        this._closeCallback();
    }
    dispose() {
        this.portalOutlet.dispose();
    }
    startModalNavigation() {
        const frame = this.parentView instanceof Frame ? this.parentView : this.parentView?.page?.frame || Frame.topmost();
        this.location?._beginModalNavigation(frame);
    }
};
NativeModalRef = __decorate([
    __param(2, Optional()),
    __metadata("design:paramtypes", [NativeDialogConfig,
        Injector,
        NSLocationStrategy])
], NativeModalRef);
export { NativeModalRef };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmF0aXZlLW1vZGFsLXJlZi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uL3BhY2thZ2VzL2FuZ3VsYXIvc3JjL2xpYi9jZGsvZGlhbG9nL25hdGl2ZS1tb2RhbC1yZWYudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxjQUFjLEVBQUUsd0JBQXdCLEVBQWlDLFFBQVEsRUFBRSxRQUFRLEVBQW9CLE1BQU0sZUFBZSxDQUFDO0FBQzlJLE9BQU8sRUFBRSxXQUFXLEVBQUUsV0FBVyxFQUFFLEtBQUssRUFBUSxNQUFNLG9CQUFvQixDQUFDO0FBQzNFLE9BQU8sRUFBRSxTQUFTLEVBQUUsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQzFDLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUN0QyxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsV0FBVyxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDcEUsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sMENBQTBDLENBQUM7QUFDOUUsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQzNDLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUM1QyxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFFcEQsT0FBTyxFQUFFLDJCQUEyQixFQUFFLE1BQU0sK0JBQStCLENBQUM7QUFDNUUsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFFckQsSUFBYSxjQUFjLEdBQTNCLE1BQWEsY0FBYztJQWF6QixZQUNVLE9BQTJCLEVBQzNCLFNBQW1CLEVBQ2YsUUFBcUM7UUFGekMsWUFBTyxHQUFQLE9BQU8sQ0FBb0I7UUFDM0IsY0FBUyxHQUFULFNBQVMsQ0FBVTtRQUNQLGFBQVEsR0FBUixRQUFRLENBQXFCO1FBZG5ELGlCQUFZLEdBQUcsSUFBSSxPQUFP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TyxvQkFBb0I7UUFDMUIsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLFVBQVUsWUFBWSxLQUFLLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFVLEVBQUUsSUFBSSxFQUFFLEtBQUssSUFBSSxLQUFLLENBQUMsT0FBTyxFQUFFLENBQUM7UUFFbkgsSUFBSSxDQUFDLFFBQVEsRUFBRSxxQkFBcUIsQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUM5QyxDQUFDO0NBQ0YsQ0FBQTtBQXJJWSxjQUFjO0lBZ0J0QixXQUFBLFFBQVEsRUFBRSxDQUFBO3FDQUZNLGtCQUFrQjtRQUNoQixRQUFRO1FBQ0ksa0JBQWtCO0dBaEJ4QyxjQUFjLENBcUkxQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEFwcGxpY2F0aW9uUmVmLCBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIsIENvbXBvbmVudFJlZiwgRW1iZWRkZWRWaWV3UmVmLCBJbmplY3RvciwgT3B0aW9uYWwsIFZpZXdDb250YWluZXJSZWYgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEFwcGxpY2F0aW9uLCBDb250ZW50VmlldywgRnJhbWUsIFZpZXcgfSBmcm9tICdAbmF0aXZlc2NyaXB0L2NvcmUnO1xuaW1wb3J0IHsgZnJvbUV2ZW50LCBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyB0YWtlIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgQXBwSG9zdEFzeW5jVmlldywgQXBwSG9zdFZpZXcgfSBmcm9tICcuLi8uLi9hcHAtaG9zdC12aWV3JztcbmltcG9ydCB7IE5TTG9jYXRpb25TdHJhdGVneSB9IGZyb20gJy4uLy4uL2xlZ2FjeS9yb3V0ZXIvbnMtbG9jYXRpb24tc3RyYXRlZ3knO1xuaW1wb3J0IHsgb25jZSB9IGZyb20gJy4uLy4uL3V0aWxzL2dlbmVyYWwnO1xuaW1wb3J0IHsgTmdWaWV3UmVmIH0gZnJvbSAnLi4vLi4vdmlldy1yZWZzJztcbmltcG9ydCB7IERldGFjaGVkTG9hZGVyIH0gZnJvbSAnLi4vZGV0YWNoZWQtbG9hZGVyJztcbmltcG9ydCB7IENvbXBvbmVudFBvcnRhbCwgVGVtcGxhdGVQb3J0YWwgfSBmcm9tICcuLi9wb3J0YWwvY29tbW9uJztcbmltcG9ydCB7IE5hdGl2ZVNjcmlwdERvbVBvcnRhbE91dGxldCB9IGZyb20gJy4uL3BvcnRhbC9uc2RvbS1wb3J0YWwtb3V0bGV0JztcbmltcG9ydCB7IE5hdGl2ZURpYWxvZ0NvbmZpZyB9IGZyb20gJy4vZGlhbG9nLWNvbmZpZyc7XG5cbmV4cG9ydCBjbGFzcyBOYXRpdmVNb2RhbFJlZiB7XG4gIF9pZDogc3RyaW5nO1xuICBzdGF0ZUNoYW5nZWQgPSBuZXcgU3ViamVjdDx7IHN0YXRlOiAnb3BlbmVkJyB8ICdjbG9zZWQnIHwgJ2Nsb3NpbmcnIH0+KCk7XG4gIG9uRGlzbWlzcyA9IG5ldyBTdWJqZWN0PHZvaWQ+KCk7XG5cbiAgcGFyZW50VmlldzogVmlldztcbiAgcG9ydGFsT3V0bGV0OiBOYXRpdmVTY3JpcHREb21Qb3J0YWxPdXRsZXQ7XG4gIGRldGFjaGVkTG9hZGVyUmVmOiBDb21wb25lbnRSZWY8RGV0YWNoZWRMb2FkZXI+O1xuICBtb2RhbFZpZXdSZWY6IE5nVmlld1JlZjxhbnk+O1xuXG4gIHByaXZhdGUgX2Nsb3NlQ2FsbGJhY2s6ICgpID0+IHZvaWQ7XG4gIHByaXZhdGUgX2lzRGlzbWlzc2VkID0gZmFsc2U7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBfY29uZmlnOiBOYXRpdmVEaWFsb2dDb25maWcsXG4gICAgcHJpdmF0ZSBfaW5qZWN0b3I6IEluamVjdG9yLFxuICAgIEBPcHRpb25hbCgpIHByaXZhdGUgbG9jYXRpb24/OiBOU0xvY2F0aW9uU3RyYXRlZ3ksXG4gICkge1xuICAgIGNvbnN0IG5hdGl2ZUVsZW1lbnQgPSB0aGlzLl9jb25maWcucmVuZGVySW4gPT09ICdyb290JyA/IEFwcGxpY2F0aW9uLmdldFJvb3RWaWV3KCkgOiB0aGlzLl9jb25maWcucmVuZGVySW4gPT09ICd2aWV3Q29udGFpbmVyUmVmJyA/IHRoaXMuX2NvbmZpZy52aWV3Q29udGFpbmVyUmVmPy5lbGVtZW50Lm5hdGl2ZUVsZW1lbnQgOiB0aGlzLl9jb25maWcucmVuZGVySW47XG4gICAgbGV0IHBhcmVudFZpZXcgPSBuYXRpdmVFbGVtZW50IHx8IEFwcGxpY2F0aW9uLmdldFJvb3RWaWV3KCk7XG5cbiAgICBpZiAoKHBhcmVudFZpZXcgaW5zdGFuY2VvZiBBcHBIb3N0VmlldyB8fCBwYXJlbnRWaWV3IGluc3RhbmNlb2YgQXBwSG9zdEFzeW5jVmlldykgJiYgcGFyZW50Vmlldy5uZ0FwcFJvb3QpIHtcbiAgICAgIHBhcmVudFZpZXcgPSBwYXJlbnRWaWV3Lm5nQXBwUm9vdDtcbiAgICB9XG5cbiAgICAvLyBfbmdEaWFsb2dSb290IGlzIHRoZSBmaXJzdCBjaGlsZCBvZiB0aGUgcHJldmlvdXNseSBkZXRhY2hlZCBwcm94eS5cbiAgICAvLyBJdCBzaG91bGQgaGF2ZSAndmlld0NvbnRyb2xsZXInIChpT1MpIG9yICdfZGlhbG9nRnJhZ21lbnQnIChBbmRyb2lkKSBhdmFpbGFibGUgZm9yXG4gICAgLy8gcHJlc2VudGluZyBmdXR1cmUgbW9kYWwgdmlld3MuXG4gICAgd2hpbGUgKHBhcmVudFZpZXcuX21vZGFsIHx8IHBhcmVudFZpZXcuX25nRGlhbG9nUm9vdCkge1xuICAgICAgcGFyZW50VmlldyA9IHBhcmVudFZpZXcuX21vZGFsIHx8IHBhcmVudFZpZXcuX25nRGlhbG9nUm9vdDtcbiAgICB9XG4gICAgdGhpcy5wYXJlbnRWaWV3ID0gcGFyZW50VmlldztcblxuICAgIHRoaXMuX2Nsb3NlQ2FsbGJhY2sgPSBvbmNlKGFzeW5jICgpID0+IHtcbiAgICAgIHRoaXMuc3RhdGVDaGFuZ2VkLm5leHQoeyBzdGF0ZTogJ2Nsb3NpbmcnIH0pO1xuICAgICAgaWYgKCF0aGlzLl9pc0Rpc21pc3NlZCkge1xuICAgICAgICB0aGlzLm1vZGFsVmlld1JlZi5maXJzdE5hdGl2ZUxpa2VWaWV3Py5jbG9zZU1vZGFsKCk7XG4gICAgICB9XG4gICAgICBhd2FpdCB0aGlzLmxvY2F0aW9uPy5fY2xvc2VNb2RhbE5hdmlnYXRpb24oKTtcbiAgICAgIC8vIHRoaXMuZGV0YWNoZWRMb2FkZXJSZWY/LmRlc3Ryb3koKTtcbiAgICAgIGlmICh0aGlzLm1vZGFsVmlld1JlZj8uZmlyc3ROYXRpdmVMaWtlVmlldy5pc0xvYWRlZCkge1xuICAgICAgICBmcm9tRXZlbnQodGhpcy5tb2RhbFZpZXdSZWYuZmlyc3ROYXRpdmVMaWtlVmlldywgJ3VubG9hZGVkJylcbiAgICAgICAgICAucGlwZSh0YWtlKDEpKVxuICAgICAgICAgIC5zdWJzY3JpYmUoKCkgPT4gdGhpcy5zdGF0ZUNoYW5nZWQubmV4dCh7IHN0YXRlOiAnY2xvc2VkJyB9KSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLnN0YXRlQ2hhbmdlZC5uZXh0KHsgc3RhdGU6ICdjbG9zZWQnIH0pO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgX2dlbmVyYXRlRGV0YWNoZWRDb250YWluZXIodmNSZWY/OiBWaWV3Q29udGFpbmVyUmVmKSB7XG4gICAgY29uc3QgZGV0YWNoZWRGYWN0b3J5ID0gKHRoaXMuX2NvbmZpZy5jb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIgfHwgdGhpcy5faW5qZWN0b3IuZ2V0KENvbXBvbmVudEZhY3RvcnlSZXNvbHZlcikpLnJlc29sdmVDb21wb25lbnRGYWN0b3J5KERldGFjaGVkTG9hZGVyKTtcbiAgICBpZiAodmNSZWYpIHtcbiAgICAgIHRoaXMuZGV0YWNoZWRMb2FkZXJSZWYgPSB2Y1JlZi5jcmVhdGVDb21wb25lbnQoZGV0YWNoZWRGYWN0b3J5KTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5kZXRhY2hlZExvYWRlclJlZiA9IGRldGFjaGVkRmFjdG9yeS5jcmVhdGUodGhpcy5fY29uZmlnLnZpZXdDb250YWluZXJSZWY/LmluamVjdG9yIHx8IHRoaXMuX2luamVjdG9yKTtcbiAgICAgIHRoaXMuX2luamVjdG9yLmdldChBcHBsaWNhdGlvblJlZikuYXR0YWNoVmlldyh0aGlzLmRldGFjaGVkTG9hZGVyUmVmLmhvc3RWaWV3KTtcbiAgICB9XG4gICAgdGhpcy5kZXRhY2hlZExvYWRlclJlZi5jaGFuZ2VEZXRlY3RvclJlZi5kZXRlY3RDaGFuZ2VzKCk7XG4gIH1cblxuICBhdHRhY2hUZW1wbGF0ZVBvcnRhbDxUPihwb3J0YWw6IFRlbXBsYXRlUG9ydGFsPFQ+KTogRW1iZWRkZWRWaWV3UmVmPFQ+IHtcbiAgICB0aGlzLnN0YXJ0TW9kYWxOYXZpZ2F0aW9uKCk7XG4gICAgY29uc3QgdmNSZWYgPSBwb3J0YWwudmlld0NvbnRhaW5lclJlZiB8fCB0aGlzLl9jb25maWcudmlld0NvbnRhaW5lclJlZjtcbiAgICB0aGlzLl9nZW5lcmF0ZURldGFjaGVkQ29udGFpbmVyKHZjUmVmKTtcbiAgICBwb3J0YWwudmlld0NvbnRhaW5lclJlZiA9IHRoaXMuZGV0YWNoZWRMb2FkZXJSZWYuaW5zdGFuY2UudmM7XG4gICAgY29uc3QgdGFyZ2V0VmlldyA9IG5ldyBDb250ZW50VmlldygpO1xuICAgIHRoaXMucG9ydGFsT3V0bGV0ID0gbmV3IE5hdGl2ZVNjcmlwdERvbVBvcnRhbE91dGxldCh0YXJnZXRWaWV3LCB0aGlzLl9jb25maWcuY29tcG9uZW50RmFjdG9yeVJlc29sdmVyIHx8IHRoaXMuX2luamVjdG9yLmdldChDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIpLCB0aGlzLl9pbmplY3Rvci5nZXQoQXBwbGljYXRpb25SZWYpLCB0aGlzLl9pbmplY3Rvcik7XG4gICAgY29uc3QgdGVtcGxhdGVSZWYgPSB0aGlzLnBvcnRhbE91dGxldC5hdHRhY2gocG9ydGFsKTtcbiAgICB0aGlzLm1vZGFsVmlld1JlZiA9IG5ldyBOZ1ZpZXdSZWYodGVtcGxhdGVSZWYpO1xuICAgIHRoaXMubW9kYWxWaWV3UmVmLmZpcnN0TmF0aXZlTGlrZVZpZXdbJ19fbmdfbW9kYWxfaWRfXyddID0gdGhpcy5faWQ7XG4gICAgLy8gaWYgd2UgZG9uJ3QgZGV0YWNoIHRoZSB2aWV3IGZyb20gaXRzIHBhcmVudCwgaW9zIGdldHMgbWFkXG4gICAgdGhpcy5tb2RhbFZpZXdSZWYuZGV0YWNoTmF0aXZlTGlrZVZpZXcoKTtcblxuICAgIGNvbnN0IHVzZXJPcHRpb25zID0gdGhpcy5fY29uZmlnLm5hdGl2ZU9wdGlvbnMgfHwge307XG4gICAgdGhpcy5wYXJlbnRWaWV3LnNob3dNb2RhbCh0aGlzLm1vZGFsVmlld1JlZi5maXJzdE5hdGl2ZUxpa2VWaWV3LCB7XG4gICAgICBjb250ZXh0OiBudWxsLFxuICAgICAgLi4udXNlck9wdGlvbnMsXG4gICAgICBjbG9zZUNhbGxiYWNrOiBhc3luYyAoKSA9PiB7XG4gICAgICAgIGF3YWl0IHRoaXMubG9jYXRpb24/Ll9jbG9zZU1vZGFsTmF2aWdhdGlvbigpO1xuICAgICAgICB0aGlzLm9uRGlzbWlzcy5uZXh0KCk7XG4gICAgICAgIHRoaXMub25EaXNtaXNzLmNvbXBsZXRlKCk7XG4gICAgICB9LFxuICAgICAgY2FuY2VsYWJsZTogIXRoaXMuX2NvbmZpZy5kaXNhYmxlQ2xvc2UsXG4gICAgfSk7XG4gICAgLy8gICBpZiAodGhpcy5tb2RhbFZpZXcgIT09IHRlbXBsYXRlUmVmLnJvb3ROb2Rlc1swXSkge1xuICAgIC8vICAgICBjb21wb25lbnRSZWYubG9jYXRpb24ubmF0aXZlRWxlbWVudC5fbmdEaWFsb2dSb290ID0gdGhpcy5tb2RhbFZpZXc7XG4gICAgLy8gICB9XG4gICAgcmV0dXJuIHRlbXBsYXRlUmVmO1xuICB9XG5cbiAgYXR0YWNoQ29tcG9uZW50UG9ydGFsPFQ+KHBvcnRhbDogQ29tcG9uZW50UG9ydGFsPFQ+KTogQ29tcG9uZW50UmVmPFQ+IHtcbiAgICB0aGlzLnN0YXJ0TW9kYWxOYXZpZ2F0aW9uKCk7XG5cbiAgICBjb25zdCB0YXJnZXRWaWV3ID0gbmV3IENvbnRlbnRWaWV3KCk7XG4gICAgdGhpcy5wb3J0YWxPdXRsZXQgPSBuZXcgTmF0aXZlU2NyaXB0RG9tUG9ydGFsT3V0bGV0KHRhcmdldFZpZXcsIHRoaXMuX2NvbmZpZy5jb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIgfHwgdGhpcy5faW5qZWN0b3IuZ2V0KENvbXBvbmVudEZhY3RvcnlSZXNvbHZlciksIHRoaXMuX2luamVjdG9yLmdldChBcHBsaWNhdGlvblJlZiksIHRoaXMuX2luamVjdG9yKTtcbiAgICBjb25zdCBjb21wb25lbnRSZWYgPSB0aGlzLnBvcnRhbE91dGxldC5hdHRhY2gocG9ydGFsKTtcbiAgICBjb21wb25lbnRSZWYuY2hhbmdlRGV0ZWN0b3JSZWYuZGV0ZWN0Q2hhbmdlcygpO1xuICAgIHRoaXMubW9kYWxWaWV3UmVmID0gbmV3IE5nVmlld1JlZihjb21wb25lbnRSZWYpO1xuICAgIGlmICh0aGlzLm1vZGFsVmlld1JlZi5maXJzdE5hdGl2ZUxpa2VWaWV3ICE9PSB0aGlzLm1vZGFsVmlld1JlZi52aWV3KSB7XG4gICAgICAoPGFueT50aGlzLm1vZGFsVmlld1JlZi52aWV3KS5fbmdEaWFsb2dSb290ID0gdGhpcy5tb2RhbFZpZXdSZWYuZmlyc3ROYXRpdmVMaWtlVmlldztcbiAgICB9XG4gICAgdGhpcy5tb2RhbFZpZXdSZWYuZmlyc3ROYXRpdmVMaWtlVmlld1snX19uZ19tb2RhbF9pZF9fJ10gPSB0aGlzLl9pZDtcbiAgICAvLyBpZiB3ZSBkb24ndCBkZXRhY2ggdGhlIHZpZXcgZnJvbSBpdHMgcGFyZW50LCBpb3MgZ2V0cyBtYWRcbiAgICB0aGlzLm1vZGFsVmlld1JlZi5kZXRhY2hOYXRpdmVMaWtlVmlldygpO1xuXG4gICAgY29uc3QgdXNlck9wdGlvbnMgPSB0aGlzLl9jb25maWcubmF0aXZlT3B0aW9ucyB8fCB7fTtcbiAgICB0aGlzLnBhcmVudFZpZXcuc2hvd01vZGFsKHRoaXMubW9kYWxWaWV3UmVmLmZpcnN0TmF0aXZlTGlrZVZpZXcsIHtcbiAgICAgIGNvbnRleHQ6IG51bGwsXG4gICAgICAuLi51c2VyT3B0aW9ucyxcbiAgICAgIGNsb3NlQ2FsbGJhY2s6IGFzeW5jICgpID0+IHtcbiAgICAgICAgdGhpcy5faXNEaXNtaXNzZWQgPSB0cnVlO1xuICAgICAgICB0aGlzLl9jbG9zZUNhbGxiYWNrKCk7IC8vIGNsb3NlIGNhbGxiYWNrIGNhbiBvbmx5IGJlIGNhbGxlZCBvbmNlLCBzbyB3ZSBjYWxsIGl0IGhlcmUgdG8gc2V0dXAgdGhlIGV4aXQgZXZlbnRzXG4gICAgICAgIHRoaXMub25EaXNtaXNzLm5leHQoKTtcbiAgICAgICAgdGhpcy5vbkRpc21pc3MuY29tcGxldGUoKTtcbiAgICAgIH0sXG4gICAgICBjYW5jZWxhYmxlOiAhdGhpcy5fY29uZmlnLmRpc2FibGVDbG9zZSxcbiAgICB9KTtcbiAgICByZXR1cm4gY29tcG9uZW50UmVmO1xuICB9XG5cbiAgX3N0YXJ0RXhpdEFuaW1hdGlvbigpIHtcbiAgICB0aGlzLl9jbG9zZUNhbGxiYWNrKCk7XG4gIH1cblxuICBkaXNwb3NlKCkge1xuICAgIHRoaXMucG9ydGFsT3V0bGV0LmRpc3Bvc2UoKTtcbiAgfVxuICBwcml2YXRlIHN0YXJ0TW9kYWxOYXZpZ2F0aW9uKCkge1xuICAgIGNvbnN0IGZyYW1lID0gdGhpcy5wYXJlbnRWaWV3IGluc3RhbmNlb2YgRnJhbWUgPyB0aGlzLnBhcmVudFZpZXcgOiB0aGlzLnBhcmVudFZpZXc/LnBhZ2U/LmZyYW1lIHx8IEZyYW1lLnRvcG1vc3QoKTtcblxuICAgIHRoaXMubG9jYXRpb24/Ll9iZWdpbk1vZGFsTmF2aWdhdGlvbihmcmFtZSk7XG4gIH1cbn1cbiJdfQ==
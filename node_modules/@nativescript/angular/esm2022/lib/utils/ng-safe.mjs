/**
 * This decorator delays a potentially unsafe event (like loaded/unloaded that will sometimes be called before ngOnInit) to be handled safely by ensuring it's called after a lifecycle hook.
 * @param runAfterEvent event/function call to wait until the event can be fired ('ngOnInit', 'ngAfterViewInit', ...)
 * @param options Optional event handling params
 * @returns decorator
 */
export function NativeScriptNgSafeEvent(runAfterEvent, options = {}) {
    const event = runAfterEvent;
    return function (target, propertyKey, descriptor) {
        function getNgSafe() {
            return target['__ng_safe__'];
        }
        if (!target['__ng_safe__']) {
            const defaultNgSafe = {
                events: {},
                runBefore: {},
            };
            target['__ng_safe__'] = defaultNgSafe;
        }
        if (!getNgSafe().events[event]) {
            getNgSafe().events[event] = {
                done: false,
                buffer: [],
                originalDelegate: target[event],
            };
            target[event] = function (...args) {
                try {
                    if (getNgSafe().events[event].originalDelegate) {
                        return getNgSafe().events[event].originalDelegate.apply(this, args);
                    }
                }
                finally {
                    getNgSafe().events[event].done = true;
                    getNgSafe().events[event].buffer.forEach((fn) => fn.fn());
                    getNgSafe().events[event].buffer = [];
                }
            };
        }
        if (options.alwaysRunBefore) {
            getNgSafe().runBefore[propertyKey] = target[options.alwaysRunBefore];
            target[`${options.alwaysRunBefore}`] = function (...args) {
                getNgSafe()
                    .events[event].buffer.filter((v) => v.key === propertyKey)
                    .forEach((fn) => fn.fn());
                getNgSafe().events[event].buffer = getNgSafe().events[event].buffer.filter((v) => v.key !== propertyKey);
                getNgSafe().runBefore[propertyKey];
                if (getNgSafe().runBefore[propertyKey]) {
                    return getNgSafe().runBefore[propertyKey].apply(this, args);
                }
            };
        }
        const oldFn = descriptor.value;
        descriptor.value = function (...args) {
            if (getNgSafe().events[event].done) {
                return oldFn.apply(this, args);
            }
            let shouldPush = true;
            if (options.onlyFirst || options.onlyLast) {
                for (let i = 0; i < getNgSafe().events[event].buffer.length; i++) {
                    if (getNgSafe().events[event].buffer[i].key === propertyKey) {
                        if (options.onlyFirst) {
                            shouldPush = false;
                            break;
                        }
                        if (options.onlyLast) {
                            getNgSafe().events[event].buffer.splice(i, 1);
                            break;
                        }
                    }
                }
            }
            if (shouldPush) {
                getNgSafe().events[event].buffer.push({
                    key: propertyKey,
                    fn: oldFn.bind(this, args),
                });
            }
        };
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmctc2FmZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3BhY2thZ2VzL2FuZ3VsYXIvc3JjL2xpYi91dGlscy9uZy1zYWZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7OztHQUtHO0FBQ0gsTUFBTSxVQUFVLHVCQUF1QixDQUNyQyxhQUFxQixFQUNyQixVQUlJLEVBQUU7SUFFTixNQUFNLEtBQUssR0FBRyxhQUFhLENBQUM7SUFDNUIsT0FBTyxVQUFVLE1BQWUsRUFBRSxXQUFtQixFQUFFLFVBQThCO1FBZ0JuRixTQUFTLFNBQVM7WUFDaEIsT0FBTyxNQUFNLENBQUMsYUFBYSxDQUFDLENBQUM7UUFDL0IsQ0FBQztRQUNELElBQUksQ0FBQyxNQUFNLENBQUMsYUFBYSxDQUFDLEVBQUUsQ0FBQztZQUMzQixNQUFNLGFBQWEsR0FBZTtnQkFDaEMsTUFBTSxFQUFFLEVBQUU7Z0JBQ1YsU0FBUyxFQUFFLEVBQUU7YUFDZCxDQUFDO1lBQ0YsTUFBTSxDQUFDLGFBQWEsQ0FBQyxHQUFHLGFBQWEsQ0FBQztRQUN4QyxDQUFDO1FBQ0QsSUFBSSxDQUFDLFNBQVMsRUFBRSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDO1lBQy9CLFNBQVMsRUFBRSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsR0FBRztnQkFDMUIsSUFBSSxFQUFFLEtBQUs7Z0JBQ1gsTUFBTSxFQUFFLEVBQUU7Z0JBQ1YsZ0JBQWdCLEVBQUUsTUFBTSxDQUFDLEtBQUssQ0FBQzthQUNoQyxDQUFDO1lBQ0YsTUFBTSxDQUFDLEtBQUssQ0FBQyxHQUFHLFVBQVUsR0FBRyxJQUFJO2dCQUMvQixJQUFJLENBQUM7b0JBQ0gsSUFBSSxTQUFTLEVBQUUsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQzt3QkFDL0MsT0FBTyxTQUFTLEVBQUUsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsZ0JBQWdCLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQztvQkFDdEUsQ0FBQztnQkFDSCxDQUFDO3dCQUFTLENBQUM7b0JBQ1QsU0FBUyxFQUFFLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7b0JBQ3RDLFNBQVMsRUFBRSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUMsRUFBRSxFQUFFLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQztvQkFDMUQsU0FBUyxFQUFFLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLE1BQU0sR0FBRyxFQUFFLENBQUM7Z0JBQ3hDLENBQUM7WUFDSCxDQUFDLENBQUM7UUFDSixDQUFDO1FBRUQsSUFBSSxPQUFPLENBQUMsZUFBZSxFQUFFLENBQUM7WUFDNUIsU0FBUyxFQUFFLENBQUMsU0FBUyxDQUFDLFdBQVcsQ0FBQyxHQUFHLE1BQU0sQ0FBQyxPQUFPLENBQUMsZUFBZSxDQUFDLENBQUM7WUFFckUsTUFBTSxDQUFDLEdBQUcsT0FBTyxDQUFDLGVBQWUsRUFBRSxDQUFDLEdBQUcsVUFBVSxHQUFHLElBQUk7Z0JBQ3RELFNBQVMsRUFBRTtxQkFDUixNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLEdBQUcsS0FBSyxXQUFXLENBQUM7cUJBQ3pELE9BQU8sQ0FBQyxDQUFDLEVBQUUsRUFBRSxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUM7Z0JBQzVCLFNBQVMsRUFBRSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxNQUFNLEdBQUcsU0FBUyxFQUFFLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxHQUFHLEtBQUssV0FBVyxDQUFDLENBQUM7Z0JBQ3pHLFNBQVMsRUFBRSxDQUFDLFNBQVMsQ0FBQyxXQUFXLENBQUMsQ0FBQztnQkFDbkMsSUFBSSxTQUFTLEVBQUUsQ0FBQyxTQUFTLENBQUMsV0FBVyxDQUFDLEVBQUUsQ0FBQztvQkFDdkMsT0FBTyxTQUFTLEVBQUUsQ0FBQyxTQUFTLENBQUMsV0FBVyxDQUFDLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQztnQkFDOUQsQ0FBQztZQUNILENBQUMsQ0FBQztRQUNKLENBQUM7UUFFRCxNQUFNLEtBQUssR0FBRyxVQUFVLENBQUMsS0FBSyxDQUFDO1FBQy9CLFVBQVUsQ0FBQyxLQUFLLEdBQUcsVUFBVSxHQUFHLElBQUk7WUFDbEMsSUFBSSxTQUFTLEVBQUUsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUM7Z0JBQ25DLE9BQU8sS0FBSyxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7WUFDakMsQ0FBQztZQUNELElBQUksVUFBVSxHQUFHLElBQUksQ0FBQztZQUN0QixJQUFJLE9BQU8sQ0FBQyxTQUFTLElBQUksT0FBTyxDQUFDLFFBQVEsRUFBRSxDQUFDO2dCQUMxQyxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsU0FBUyxFQUFFLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLE1BQU0sQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQztvQkFDakUsSUFBSSxTQUFTLEVBQUUsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsS0FBSyxXQUFXLEVBQUUsQ0FBQzt3QkFDNUQsSUFBSSxPQUFPLENBQUMsU0FBUyxFQUFFLENBQUM7NEJBQ3RCLFVBQVUsR0FBRyxLQUFLLENBQUM7NEJBQ25CLE1BQU07d0JBQ1IsQ0FBQzt3QkFDRCxJQUFJLE9BQU8sQ0FBQyxRQUFRLEVBQUUsQ0FBQzs0QkFDckIsU0FBUyxFQUFFLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDOzRCQUM5QyxNQUFNO3dCQUNSLENBQUM7b0JBQ0gsQ0FBQztnQkFDSCxDQUFDO1lBQ0gsQ0FBQztZQUNELElBQUksVUFBVSxFQUFFLENBQUM7Z0JBQ2YsU0FBUyxFQUFFLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUM7b0JBQ3BDLEdBQUcsRUFBRSxXQUFXO29CQUNoQixFQUFFLEVBQUUsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDO2lCQUMzQixDQUFDLENBQUM7WUFDTCxDQUFDO1FBQ0gsQ0FBQyxDQUFDO0lBQ0osQ0FBQyxDQUFDO0FBQ0osQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogVGhpcyBkZWNvcmF0b3IgZGVsYXlzIGEgcG90ZW50aWFsbHkgdW5zYWZlIGV2ZW50IChsaWtlIGxvYWRlZC91bmxvYWRlZCB0aGF0IHdpbGwgc29tZXRpbWVzIGJlIGNhbGxlZCBiZWZvcmUgbmdPbkluaXQpIHRvIGJlIGhhbmRsZWQgc2FmZWx5IGJ5IGVuc3VyaW5nIGl0J3MgY2FsbGVkIGFmdGVyIGEgbGlmZWN5Y2xlIGhvb2suXG4gKiBAcGFyYW0gcnVuQWZ0ZXJFdmVudCBldmVudC9mdW5jdGlvbiBjYWxsIHRvIHdhaXQgdW50aWwgdGhlIGV2ZW50IGNhbiBiZSBmaXJlZCAoJ25nT25Jbml0JywgJ25nQWZ0ZXJWaWV3SW5pdCcsIC4uLilcbiAqIEBwYXJhbSBvcHRpb25zIE9wdGlvbmFsIGV2ZW50IGhhbmRsaW5nIHBhcmFtc1xuICogQHJldHVybnMgZGVjb3JhdG9yXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBOYXRpdmVTY3JpcHROZ1NhZmVFdmVudChcbiAgcnVuQWZ0ZXJFdmVudDogc3RyaW5nLFxuICBvcHRpb25zOiB7XG4gICAgb25seUxhc3Q/OiBib29sZWFuO1xuICAgIG9ubHlGaXJzdD86IGJvb2xlYW47XG4gICAgYWx3YXlzUnVuQmVmb3JlPzogc3RyaW5nO1xuICB9ID0ge31cbikge1xuICBjb25zdCBldmVudCA9IHJ1bkFmdGVyRXZlbnQ7XG4gIHJldHVybiBmdW5jdGlvbiAodGFyZ2V0OiB1bmtub3duLCBwcm9wZXJ0eUtleTogc3RyaW5nLCBkZXNjcmlwdG9yOiBQcm9wZXJ0eURlc2NyaXB0b3IpIHtcbiAgICB0eXBlIE5nU2FmZVR5cGUgPSB7XG4gICAgICBldmVudHM6IHtcbiAgICAgICAgW2tleTogc3RyaW5nXToge1xuICAgICAgICAgIGRvbmU6IGJvb2xlYW47XG4gICAgICAgICAgb3JpZ2luYWxEZWxlZ2F0ZTogKC4uLmFyZ3M6IHVua25vd25bXSkgPT4gdW5rbm93bjtcbiAgICAgICAgICBidWZmZXI6IEFycmF5PHtcbiAgICAgICAgICAgIGtleTogc3RyaW5nO1xuICAgICAgICAgICAgZm46ICguLi5hcmdzOiB1bmtub3duW10pID0+IHVua25vd247XG4gICAgICAgICAgfT47XG4gICAgICAgIH07XG4gICAgICB9O1xuICAgICAgcnVuQmVmb3JlOiB7XG4gICAgICAgIFtwcm9wZXJ0eUtleTogc3RyaW5nXTogKC4uLmFyZ3M6IHVua25vd25bXSkgPT4gdW5rbm93bjtcbiAgICAgIH07XG4gICAgfTtcbiAgICBmdW5jdGlvbiBnZXROZ1NhZmUoKTogTmdTYWZlVHlwZSB7XG4gICAgICByZXR1cm4gdGFyZ2V0WydfX25nX3NhZmVfXyddO1xuICAgIH1cbiAgICBpZiAoIXRhcmdldFsnX19uZ19zYWZlX18nXSkge1xuICAgICAgY29uc3QgZGVmYXVsdE5nU2FmZTogTmdTYWZlVHlwZSA9IHtcbiAgICAgICAgZXZlbnRzOiB7fSxcbiAgICAgICAgcnVuQmVmb3JlOiB7fSxcbiAgICAgIH07XG4gICAgICB0YXJnZXRbJ19fbmdfc2FmZV9fJ10gPSBkZWZhdWx0TmdTYWZlO1xuICAgIH1cbiAgICBpZiAoIWdldE5nU2FmZSgpLmV2ZW50c1tldmVudF0pIHtcbiAgICAgIGdldE5nU2FmZSgpLmV2ZW50c1tldmVudF0gPSB7XG4gICAgICAgIGRvbmU6IGZhbHNlLFxuICAgICAgICBidWZmZXI6IFtdLFxuICAgICAgICBvcmlnaW5hbERlbGVnYXRlOiB0YXJnZXRbZXZlbnRdLFxuICAgICAgfTtcbiAgICAgIHRhcmdldFtldmVudF0gPSBmdW5jdGlvbiAoLi4uYXJncykge1xuICAgICAgICB0cnkge1xuICAgICAgICAgIGlmIChnZXROZ1NhZmUoKS5ldmVudHNbZXZlbnRdLm9yaWdpbmFsRGVsZWdhdGUpIHtcbiAgICAgICAgICAgIHJldHVybiBnZXROZ1NhZmUoKS5ldmVudHNbZXZlbnRdLm9yaWdpbmFsRGVsZWdhdGUuYXBwbHkodGhpcywgYXJncyk7XG4gICAgICAgICAgfVxuICAgICAgICB9IGZpbmFsbHkge1xuICAgICAgICAgIGdldE5nU2FmZSgpLmV2ZW50c1tldmVudF0uZG9uZSA9IHRydWU7XG4gICAgICAgICAgZ2V0TmdTYWZlKCkuZXZlbnRzW2V2ZW50XS5idWZmZXIuZm9yRWFjaCgoZm4pID0+IGZuLmZuKCkpO1xuICAgICAgICAgIGdldE5nU2FmZSgpLmV2ZW50c1tldmVudF0uYnVmZmVyID0gW107XG4gICAgICAgIH1cbiAgICAgIH07XG4gICAgfVxuXG4gICAgaWYgKG9wdGlvbnMuYWx3YXlzUnVuQmVmb3JlKSB7XG4gICAgICBnZXROZ1NhZmUoKS5ydW5CZWZvcmVbcHJvcGVydHlLZXldID0gdGFyZ2V0W29wdGlvbnMuYWx3YXlzUnVuQmVmb3JlXTtcblxuICAgICAgdGFyZ2V0W2Ake29wdGlvbnMuYWx3YXlzUnVuQmVmb3JlfWBdID0gZnVuY3Rpb24gKC4uLmFyZ3MpIHtcbiAgICAgICAgZ2V0TmdTYWZlKClcbiAgICAgICAgICAuZXZlbnRzW2V2ZW50XS5idWZmZXIuZmlsdGVyKCh2KSA9PiB2LmtleSA9PT0gcHJvcGVydHlLZXkpXG4gICAgICAgICAgLmZvckVhY2goKGZuKSA9PiBmbi5mbigpKTtcbiAgICAgICAgZ2V0TmdTYWZlKCkuZXZlbnRzW2V2ZW50XS5idWZmZXIgPSBnZXROZ1NhZmUoKS5ldmVudHNbZXZlbnRdLmJ1ZmZlci5maWx0ZXIoKHYpID0+IHYua2V5ICE9PSBwcm9wZXJ0eUtleSk7XG4gICAgICAgIGdldE5nU2FmZSgpLnJ1bkJlZm9yZVtwcm9wZXJ0eUtleV07XG4gICAgICAgIGlmIChnZXROZ1NhZmUoKS5ydW5CZWZvcmVbcHJvcGVydHlLZXldKSB7XG4gICAgICAgICAgcmV0dXJuIGdldE5nU2FmZSgpLnJ1bkJlZm9yZVtwcm9wZXJ0eUtleV0uYXBwbHkodGhpcywgYXJncyk7XG4gICAgICAgIH1cbiAgICAgIH07XG4gICAgfVxuXG4gICAgY29uc3Qgb2xkRm4gPSBkZXNjcmlwdG9yLnZhbHVlO1xuICAgIGRlc2NyaXB0b3IudmFsdWUgPSBmdW5jdGlvbiAoLi4uYXJncykge1xuICAgICAgaWYgKGdldE5nU2FmZSgpLmV2ZW50c1tldmVudF0uZG9uZSkge1xuICAgICAgICByZXR1cm4gb2xkRm4uYXBwbHkodGhpcywgYXJncyk7XG4gICAgICB9XG4gICAgICBsZXQgc2hvdWxkUHVzaCA9IHRydWU7XG4gICAgICBpZiAob3B0aW9ucy5vbmx5Rmlyc3QgfHwgb3B0aW9ucy5vbmx5TGFzdCkge1xuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGdldE5nU2FmZSgpLmV2ZW50c1tldmVudF0uYnVmZmVyLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgaWYgKGdldE5nU2FmZSgpLmV2ZW50c1tldmVudF0uYnVmZmVyW2ldLmtleSA9PT0gcHJvcGVydHlLZXkpIHtcbiAgICAgICAgICAgIGlmIChvcHRpb25zLm9ubHlGaXJzdCkge1xuICAgICAgICAgICAgICBzaG91bGRQdXNoID0gZmFsc2U7XG4gICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKG9wdGlvbnMub25seUxhc3QpIHtcbiAgICAgICAgICAgICAgZ2V0TmdTYWZlKCkuZXZlbnRzW2V2ZW50XS5idWZmZXIuc3BsaWNlKGksIDEpO1xuICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGlmIChzaG91bGRQdXNoKSB7XG4gICAgICAgIGdldE5nU2FmZSgpLmV2ZW50c1tldmVudF0uYnVmZmVyLnB1c2goe1xuICAgICAgICAgIGtleTogcHJvcGVydHlLZXksXG4gICAgICAgICAgZm46IG9sZEZuLmJpbmQodGhpcywgYXJncyksXG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH07XG4gIH07XG59XG4iXX0=
import { __decorate, __metadata } from "tslib";
import { Injectable, Injector, RendererStyleFlags2, ViewEncapsulation, inject, runInInjectionContext } from '@angular/core';
import { addTaggedAdditionalCSS, Application, ContentView, getViewById, Observable, profile, View } from '@nativescript/core';
import { isKnownView } from './element-registry';
import { getFirstNativeLikeView, TextNode } from './views';
import { NAMESPACE_FILTERS } from './property-filter';
import { APP_ROOT_VIEW, ENABLE_REUSABE_VIEWS, NATIVESCRIPT_ROOT_MODULE_ID, PREVENT_SPECIFIC_EVENTS_DURING_CD } from './tokens';
import { NativeScriptDebug } from './trace';
import { ViewUtil } from './view-util';
import * as i0 from "@angular/core";
import * as i1 from "@nativescript/core";
const addStyleToCss = profile('"renderer".addStyleToCss', function addStyleToCss(style, tag) {
    if (tag) {
        addTaggedAdditionalCSS(style, tag);
    }
    else {
        Application.addCss(style);
    }
});
function runInRootZone(fn) {
    if (typeof Zone === 'undefined') {
        return fn();
    }
    return Zone.root.run(fn);
}
function inRootZone() {
    return function (target, key, descriptor) {
        const childFunction = descriptor.value;
        descriptor.value = function (...args) {
            const fn = childFunction.bind(this);
            return runInRootZone(() => fn(...args));
        };
        return descriptor;
    };
}
export class NativeScriptRendererHelperService {
    constructor() {
        this._executingDomChanges = 0;
    }
    get executingDomChanges() {
        return this._executingDomChanges;
    }
    get isExecutingDomChanges() {
        return this._executingDomChanges > 0;
    }
    beginDomChanges() {
        this._executingDomChanges++;
    }
    endDomChanges() {
        this._executingDomChanges--;
    }
    executeDomChange(fn) {
        try {
            this.beginDomChanges();
            return fn();
        }
        finally {
            this.endDomChanges();
        }
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "18.1.0", ngImport: i0, type: NativeScriptRendererHelperService, deps: [], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "18.1.0", ngImport: i0, type: NativeScriptRendererHelperService, providedIn: 'root' }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "18.1.0", ngImport: i0, type: NativeScriptRendererHelperService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root',
                }]
        }] });
function modifiesDom() {
    return function (target, key, descriptor) {
        const childFunction = descriptor.value;
        descriptor.value = function (...args) {
            const fn = childFunction.bind(this);
            return this._rendererHelper.executeDomChange(() => fn(...args));
        };
        return descriptor;
    };
}
export class NativeScriptRendererFactory {
    constructor() {
        this.componentRenderers = new Map();
        // backwards compatibility with RadListView
        this.rootView = inject(APP_ROOT_VIEW);
        this.namespaceFilters = inject(NAMESPACE_FILTERS);
        this.rootModuleID = inject(NATIVESCRIPT_ROOT_MODULE_ID);
        this.reuseViews = inject(ENABLE_REUSABE_VIEWS, {
            optional: true,
        });
        this.injector = inject(Injector);
        this.viewUtil = new ViewUtil(this.namespaceFilters, this.reuseViews);
        if (typeof this.reuseViews !== 'boolean') {
            this.reuseViews = false; // default to false
        }
        this.defaultRenderer = new NativeScriptRenderer(this.rootView);
    }
    createRenderer(hostElement, type) {
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog(`NativeScriptRendererFactory.createRenderer ${hostElement}. type.id: ${type.id} type.encapsulation: ${type.encapsulation}`);
        }
        if (!hostElement || !type) {
            return this.defaultRenderer;
        }
        let renderer = this.componentRenderers.get(type.id);
        /**
         *! WARNING
         *! We're reusing the renderer for the components
         *! this might cause unexpected behavior as the "rootView" is an arbitrary hostElement
         *! also, the renderer has it's .destroy() called!
         *! might be useful to create a BaseEmulatedRender and a ProxyEmulatedRender
         *! every component type gets a BaseEmulatedRender (singleton) which is passed to ProxyEmulatedRender
         *! ProxyEmulatedRenderer registers with BaseEmulatedRender so we can clean up things like CSS when it's not needed
         *! this might be useful if we find a way to HMR component styling without a full rebootstrap
         */
        if (renderer) {
            if (renderer instanceof EmulatedRenderer) {
                renderer.applyToHost(hostElement);
            }
            return renderer;
        }
        if (type.encapsulation === ViewEncapsulation.None) {
            type.styles.map((s) => s.toString()).forEach((v) => addStyleToCss(v, this.rootModuleID));
            renderer = this.defaultRenderer;
        }
        else {
            runInInjectionContext(this.injector, () => {
                renderer = new EmulatedRenderer(type, hostElement);
            });
            renderer.applyToHost(hostElement);
        }
        this.componentRenderers.set(type.id, renderer);
        return renderer;
    }
    // begin?(): void {
    //     throw new Error("Method not implemented.");
    // }
    // end?(): void {
    //     throw new Error("Method not implemented.");
    // }
    whenRenderingDone() {
        if (!this.rootView) {
            return Promise.resolve();
        }
        return new Promise((resolve) => {
            let interval = 0;
            function scheduleResolve() {
                // iOS really hates synchronous things...
                // Utils.queueMacrotask(resolve);
                setTimeout(resolve, 15);
            }
            function fireWhenLoaded() {
                const view = rootFactory();
                if (view.isLoaded) {
                    scheduleResolve();
                }
                else {
                    view.once('loaded', scheduleResolve);
                }
            }
            const rootFactory = () => (this.rootView instanceof ContentView ? this.rootView.content : this.rootView);
            if (!rootFactory()) {
                interval = setInterval(() => {
                    if (rootFactory()) {
                        clearInterval(interval);
                        fireWhenLoaded();
                    }
                }, 10);
            }
            else {
                fireWhenLoaded();
            }
        });
        // throw new Error("Method not implemented.");
    }
}
class NativeScriptRenderer {
    constructor(rootView) {
        this.rootView = rootView;
        this.namespaceFilters = inject(NAMESPACE_FILTERS);
        this.reuseViews = inject(ENABLE_REUSABE_VIEWS, {
            optional: true,
        });
        this.viewUtil = new ViewUtil(this.namespaceFilters, this.reuseViews);
        this._rendererHelper = inject(NativeScriptRendererHelperService);
        this.specificPreventedEvents = new Set(inject(PREVENT_SPECIFIC_EVENTS_DURING_CD, {
            optional: true,
        }) ?? []);
        this.preventChangeEvents = inject(PREVENT_SPECIFIC_EVENTS_DURING_CD, {
            optional: true,
        }) ?? false;
        this.destroyNode = (node) => runInRootZone(() => {
            if (NativeScriptDebug.enabled) {
                NativeScriptDebug.rendererLog(`NativeScriptRenderer.destroyNode node: ${node}`);
            }
            if (node?.destroyNode) {
                node?.destroyNode();
            }
        });
    }
    get data() {
        throw new Error('Method not implemented.');
    }
    destroy() {
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog('NativeScriptRenderer.destroy');
        }
    }
    createElement(name, namespace) {
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog(`NativeScriptRenderer.createElement: ${name}`);
        }
        let oldName;
        if (!isKnownView(name)) {
            oldName = name;
            name = 'ProxyViewContainer';
        }
        const view = this.viewUtil.createView(name);
        if (oldName) {
            view.customCSSName = oldName;
        }
        return view;
    }
    createComment(value) {
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog(`NativeScriptRenderer.createComment ${value}`);
        }
        return this.viewUtil.createComment(value);
    }
    createText(value) {
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog(`NativeScriptRenderer.createText ${value}`);
        }
        return this.viewUtil.createText(value);
    }
    appendChild(parent, newChild) {
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog(`NativeScriptRenderer.appendChild child: ${newChild} parent: ${parent}`);
        }
        this.viewUtil.appendChild(parent, newChild);
    }
    insertBefore(parent, newChild, refChild) {
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog(`NativeScriptRenderer.insertBefore child: ${newChild} ` + `parent: ${parent} refChild: ${refChild}`);
        }
        this.viewUtil.insertBefore(parent, newChild, refChild);
    }
    removeChild(parent, oldChild, isHostElement) {
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog(`NativeScriptRenderer.removeChild child: ${oldChild} parent: ${parent}`);
        }
        this.viewUtil.removeChild(parent, oldChild);
    }
    selectRootElement(selectorOrNode, preserveContent) {
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog(`NativeScriptRenderer.selectRootElement: ${selectorOrNode}`);
        }
        if (selectorOrNode instanceof View) {
            return selectorOrNode;
        }
        if (selectorOrNode && selectorOrNode[0] === '#') {
            const result = getViewById(this.rootView, selectorOrNode.slice(1));
            return (result || this.rootView);
        }
        if (typeof selectorOrNode === 'string') {
            const view = this.viewUtil.createView(selectorOrNode);
            if (getFirstNativeLikeView(view) === view) {
                // view is nativelike!
                this.appendChild(this.rootView, view);
                return view;
            }
        }
        return this.rootView;
    }
    parentNode(node) {
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog(`NativeScriptRenderer.parentNode for node: ${node} is ${node.parentNode}`);
        }
        return node.parentNode;
    }
    nextSibling(node) {
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog(`NativeScriptRenderer.nextSibling of ${node} is ${node.nextSibling}`);
        }
        return node.nextSibling;
    }
    setAttribute(el, name, value, namespace) {
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog(`NativeScriptRenderer.setAttribute ${namespace ? namespace + ':' : ''}${el}.${name} = ${value}`);
        }
        this.viewUtil.setProperty(el, name, value, namespace);
    }
    removeAttribute(el, name, namespace) {
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog(`NativeScriptRenderer.removeAttribute ${namespace ? namespace + ':' : ''}${el}.${name}`);
        }
    }
    addClass(el, name) {
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog(`NativeScriptRenderer.addClass ${name}`);
        }
        this.viewUtil.addClass(el, name);
    }
    removeClass(el, name) {
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog(`NativeScriptRenderer.removeClass ${name}`);
        }
        this.viewUtil.removeClass(el, name);
    }
    setStyle(el, style, value, flags) {
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog(`NativeScriptRenderer.setStyle: ${el}, ${style} = ${value}`);
        }
        this.viewUtil.setStyle(el, style, value);
    }
    removeStyle(el, style, flags) {
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog('NativeScriptRenderer.removeStyle: ${styleName}');
        }
        this.viewUtil.removeStyle(el, style);
    }
    setProperty(el, name, value) {
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog(`NativeScriptRenderer.setProperty ${el}.${name} = ${value}`);
        }
        this.viewUtil.setProperty(el, name, value);
    }
    setValue(node, value) {
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog(`NativeScriptRenderer.setValue renderNode: ${node}, value: ${value}`);
        }
        if (node instanceof TextNode) {
            node.text = value;
        }
        // throw new Error("Method not implemented.");
    }
    listen(target, eventName, callback) {
        // throw new Error("Method not implemented.");
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog(`NativeScriptRenderer.listen: ${eventName}`);
        }
        let modifiedCallback = callback;
        if ((this.preventChangeEvents && eventName.endsWith('Change')) || this.specificPreventedEvents.has(eventName)) {
            modifiedCallback = (...args) => {
                if (this._rendererHelper.isExecutingDomChanges) {
                    return;
                }
                return callback(...args);
            };
        }
        target.on(eventName, modifiedCallback);
        if (eventName === View.loadedEvent && target.isLoaded) {
            // we must create a new obervable here to ensure that the event goes through whatever zone patches are applied
            const obs = new Observable();
            obs.once(eventName, modifiedCallback);
            obs.notify({
                eventName,
                object: target,
            });
        }
        return () => target.off(eventName, modifiedCallback);
    }
}
__decorate([
    inRootZone(),
    modifiesDom(),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String, String]),
    __metadata("design:returntype", void 0)
], NativeScriptRenderer.prototype, "createElement", null);
__decorate([
    inRootZone(),
    modifiesDom(),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String]),
    __metadata("design:returntype", void 0)
], NativeScriptRenderer.prototype, "createComment", null);
__decorate([
    inRootZone(),
    modifiesDom(),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String]),
    __metadata("design:returntype", void 0)
], NativeScriptRenderer.prototype, "createText", null);
__decorate([
    inRootZone(),
    modifiesDom(),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [View, View]),
    __metadata("design:returntype", void 0)
], NativeScriptRenderer.prototype, "appendChild", null);
__decorate([
    inRootZone(),
    modifiesDom(),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object, Object, Object]),
    __metadata("design:returntype", void 0)
], NativeScriptRenderer.prototype, "insertBefore", null);
__decorate([
    inRootZone(),
    modifiesDom(),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object, Object, Boolean]),
    __metadata("design:returntype", void 0)
], NativeScriptRenderer.prototype, "removeChild", null);
__decorate([
    inRootZone(),
    modifiesDom(),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object, String, String, String]),
    __metadata("design:returntype", void 0)
], NativeScriptRenderer.prototype, "setAttribute", null);
__decorate([
    inRootZone(),
    modifiesDom(),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object, String]),
    __metadata("design:returntype", void 0)
], NativeScriptRenderer.prototype, "addClass", null);
__decorate([
    inRootZone(),
    modifiesDom(),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object, String]),
    __metadata("design:returntype", void 0)
], NativeScriptRenderer.prototype, "removeClass", null);
__decorate([
    inRootZone(),
    modifiesDom(),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object, String, Object, Number]),
    __metadata("design:returntype", void 0)
], NativeScriptRenderer.prototype, "setStyle", null);
__decorate([
    inRootZone(),
    modifiesDom(),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object, String, Number]),
    __metadata("design:returntype", void 0)
], NativeScriptRenderer.prototype, "removeStyle", null);
__decorate([
    inRootZone(),
    modifiesDom(),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object, String, Object]),
    __metadata("design:returntype", void 0)
], NativeScriptRenderer.prototype, "setProperty", null);
__decorate([
    inRootZone(),
    modifiesDom(),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object, String]),
    __metadata("design:returntype", void 0)
], NativeScriptRenderer.prototype, "setValue", null);
// CONTENT_ATTR not exported from nativescript-renderer - we need it for styles application.
const COMPONENT_REGEX = /%COMP%/g;
const ATTR_SANITIZER = /-/g;
export const COMPONENT_VARIABLE = '%COMP%';
export const HOST_ATTR = `_nghost-${COMPONENT_VARIABLE}`;
export const CONTENT_ATTR = `_ngcontent-${COMPONENT_VARIABLE}`;
const replaceNgAttribute = function (input, componentId) {
    return input.replace(COMPONENT_REGEX, componentId);
};
const addScopedStyleToCss = profile(`"renderer".addScopedStyleToCss`, function addScopedStyleToCss(style, tag) {
    if (tag) {
        addTaggedAdditionalCSS(style, tag);
    }
    else {
        Application.addCss(style);
    }
});
export class EmulatedRenderer extends NativeScriptRenderer {
    constructor(component, rootView) {
        super(rootView);
        this.rootModuleId = inject(NATIVESCRIPT_ROOT_MODULE_ID);
        const componentId = component.id.replace(ATTR_SANITIZER, '_');
        this.contentAttr = replaceNgAttribute(CONTENT_ATTR, componentId);
        this.hostAttr = replaceNgAttribute(HOST_ATTR, componentId);
        this.addStyles(component.styles, componentId);
    }
    applyToHost(view) {
        super.setAttribute(view, this.hostAttr, '');
    }
    appendChild(parent, newChild) {
        super.appendChild(parent, newChild);
    }
    createElement(parent, name) {
        const view = super.createElement(parent, name);
        // Set an attribute to the view to scope component-specific css.
        // The property name is pre-generated by Angular.
        super.setAttribute(view, this.contentAttr, '');
        return view;
    }
    addStyles(styles, componentId) {
        styles
            .map((s) => s.toString())
            .map((s) => replaceNgAttribute(s, componentId))
            .forEach((s) => addScopedStyleToCss(s, this.rootModuleId));
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "18.1.0", ngImport: i0, type: EmulatedRenderer, deps: "invalid", target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "18.1.0", ngImport: i0, type: EmulatedRenderer }); }
}
__decorate([
    profile,
    inRootZone(),
    modifiesDom(),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Array, String]),
    __metadata("design:returntype", void 0)
], EmulatedRenderer.prototype, "addStyles", null);
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "18.1.0", ngImport: i0, type: EmulatedRenderer, decorators: [{
            type: Injectable
        }], ctorParameters: () => [{ type: undefined }, { type: i1.View }], propDecorators: { addStyles: [] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmF0aXZlc2NyaXB0LXJlbmRlcmVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vcGFja2FnZXMvYW5ndWxhci9zcmMvbGliL25hdGl2ZXNjcmlwdC1yZW5kZXJlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFVLFVBQVUsRUFBRSxRQUFRLEVBQWlELG1CQUFtQixFQUFpQixpQkFBaUIsRUFBRSxNQUFNLEVBQUUscUJBQXFCLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDbE0sT0FBTyxFQUFFLHNCQUFzQixFQUFFLFdBQVcsRUFBRSxXQUFXLEVBQVUsV0FBVyxFQUFFLFVBQVUsRUFBRSxPQUFPLEVBQVMsSUFBSSxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDN0ksT0FBTyxFQUFnQixXQUFXLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUMvRCxPQUFPLEVBQUUsc0JBQXNCLEVBQVUsUUFBUSxFQUFFLE1BQU0sU0FBUyxDQUFDO0FBRW5FLE9BQU8sRUFBbUIsaUJBQWlCLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUN2RSxPQUFPLEVBQUUsYUFBYSxFQUFFLG9CQUFvQixFQUFFLDJCQUEyQixFQUFFLGlDQUFpQyxFQUFFLE1BQU0sVUFBVSxDQUFDO0FBQy9ILE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLFNBQVMsQ0FBQztBQUM1QyxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sYUFBYSxDQUFDOzs7QUFFdkMsTUFBTSxhQUFhLEdBQUcsT0FBTyxDQUFDLDBCQUEwQixFQUFFLFNBQVMsYUFBYSxDQUFDLEtBQWEsRUFBRSxHQUFxQjtJQUNuSCxJQUFJLEdBQUcsRUFBRSxDQUFDO1FBQ1Isc0JBQXNCLENBQUMsS0FBSyxFQUFFLEdBQUcsQ0FBQyxDQUFDO0lBQ3JDLENBQUM7U0FBTSxDQUFDO1FBQ04sV0FBVyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUM1QixDQUFDO0FBQ0gsQ0FBQyxD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QyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsa0JBQWtCLENBQUMsQ0FBQyxFQUFFLFdBQVcsQ0FBQyxDQUFDO2FBQzlDLE9BQU8sQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsbUJBQW1CLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDO0lBQy9ELENBQUM7OEdBeENVLGdCQUFnQjtrSEFBaEIsZ0JBQWdCOztBQW1DbkI7SUFIUCxPQUFPO0lBQ1AsVUFBVSxFQUFFO0lBQ1osV0FBVyxFQUFFOzs7O2lEQU1iOzJGQXhDVSxnQkFBZ0I7a0JBRDVCLFVBQVU7OEZBb0NELFNBQVMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3QsIEluamVjdGFibGUsIEluamVjdG9yLCBOZ1pvbmUsIE9wdGlvbmFsLCBSZW5kZXJlcjIsIFJlbmRlcmVyRmFjdG9yeTIsIFJlbmRlcmVyU3R5bGVGbGFnczIsIFJlbmRlcmVyVHlwZTIsIFZpZXdFbmNhcHN1bGF0aW9uLCBpbmplY3QsIHJ1bkluSW5qZWN0aW9uQ29udGV4dCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgYWRkVGFnZ2VkQWRkaXRpb25hbENTUywgQXBwbGljYXRpb24sIENvbnRlbnRWaWV3LCBEZXZpY2UsIGdldFZpZXdCeUlkLCBPYnNlcnZhYmxlLCBwcm9maWxlLCBVdGlscywgVmlldyB9IGZyb20gJ0BuYXRpdmVzY3JpcHQvY29yZSc7XG5pbXBvcnQgeyBnZXRWaWV3Q2xhc3MsIGlzS25vd25WaWV3IH0gZnJvbSAnLi9lbGVtZW50LXJlZ2lzdHJ5JztcbmltcG9ydCB7IGdldEZpcnN0TmF0aXZlTGlrZVZpZXcsIE5nVmlldywgVGV4dE5vZGUgfSBmcm9tICcuL3ZpZXdzJztcblxuaW1wb3J0IHsgTmFtZXNwYWNlRmlsdGVyLCBOQU1FU1BBQ0VfRklMVEVSUyB9IGZyb20gJy4vcHJvcGVydHktZmlsdGVyJztcbmltcG9ydCB7IEFQUF9ST09UX1ZJRVcsIEVOQUJMRV9SRVVTQUJFX1ZJRVdTLCBOQVRJVkVTQ1JJUFRfUk9PVF9NT0RVTEVfSUQsIFBSRVZFTlRfU1BFQ0lGSUNfRVZFTlRTX0RVUklOR19DRCB9IGZyb20gJy4vdG9rZW5zJztcbmltcG9ydCB7IE5hdGl2ZVNjcmlwdERlYnVnIH0gZnJvbSAnLi90cmFjZSc7XG5pbXBvcnQgeyBWaWV3VXRpbCB9IGZyb20gJy4vdmlldy11dGlsJztcblxuY29uc3QgYWRkU3R5bGVUb0NzcyA9IHByb2ZpbGUoJ1wicmVuZGVyZXJcIi5hZGRTdHlsZVRvQ3NzJywgZnVuY3Rpb24gYWRkU3R5bGVUb0NzcyhzdHlsZTogc3RyaW5nLCB0YWc/OiBzdHJpbmcgfCBudW1iZXIpOiB2b2lkIHtcbiAgaWYgKHRhZykge1xuICAgIGFkZFRhZ2dlZEFkZGl0aW9uYWxDU1Moc3R5bGUsIHRhZyk7XG4gIH0gZWxzZSB7XG4gICAgQXBwbGljYXRpb24uYWRkQ3NzKHN0eWxlKTtcbiAgfVxufSk7XG5cbmZ1bmN0aW9uIHJ1bkluUm9vdFpvbmU8VD4oZm46ICgpID0+IFQpOiBUIHtcbiAgaWYgKHR5cGVvZiBab25lID09PSAndW5kZWZpbmVkJykge1xuICAgIHJldHVybiBmbigpO1xuICB9XG4gIHJldHVybiBab25lLnJvb3QucnVuKGZuKTtcbn1cblxuZnVuY3Rpb24gaW5Sb290Wm9uZSgpIHtcbiAgcmV0dXJuIGZ1bmN0aW9uICh0YXJnZXQ6IHVua25vd24sIGtleTogc3RyaW5nIHwgc3ltYm9sLCBkZXNjcmlwdG9yOiBQcm9wZXJ0eURlc2NyaXB0b3IpIHtcbiAgICBjb25zdCBjaGlsZEZ1bmN0aW9uID0gZGVzY3JpcHRvci52YWx1ZTtcbiAgICBkZXNjcmlwdG9yLnZhbHVlID0gZnVuY3Rpb24gKC4uLmFyZ3M6IHVua25vd25bXSkge1xuICAgICAgY29uc3QgZm4gPSBjaGlsZEZ1bmN0aW9uLmJpbmQodGhpcyk7XG4gICAgICByZXR1cm4gcnVuSW5Sb290Wm9uZSgoKSA9PiBmbiguLi5hcmdzKSk7XG4gICAgfTtcbiAgICByZXR1cm4gZGVzY3JpcHRvcjtcbiAgfTtcbn1cblxuQEluamVjdGFibGUoe1xuICBwcm92aWRlZEluOiAncm9vdCcsXG59KVxuZXhwb3J0IGNsYXNzIE5hdGl2ZVNjcmlwdFJlbmRlcmVySGVscGVyU2VydmljZSB7XG4gIHByaXZhdGUgX2V4ZWN1dGluZ0RvbUNoYW5nZXMgPSAwO1xuICBnZXQgZXhlY3V0aW5nRG9tQ2hhbmdlcygpIHtcbiAgICByZXR1cm4gdGhpcy5fZXhlY3V0aW5nRG9tQ2hhbmdlcztcbiAgfVxuICBnZXQgaXNFeGVjdXRpbmdEb21DaGFuZ2VzKCkge1xuICAgIHJldHVybiB0aGlzLl9leGVjdXRpbmdEb21DaGFuZ2VzID4gMDtcbiAgfVxuICBiZWdpbkRvbUNoYW5nZXMoKSB7XG4gICAgdGhpcy5fZXhlY3V0aW5nRG9tQ2hhbmdlcysrO1xuICB9XG4gIGVuZERvbUNoYW5nZXMoKSB7XG4gICAgdGhpcy5fZXhlY3V0aW5nRG9tQ2hhbmdlcy0tO1xuICB9XG4gIGV4ZWN1dGVEb21DaGFuZ2U8VD4oZm46ICgpID0+IFQpOiBUIHtcbiAgICB0cnkge1xuICAgICAgdGhpcy5iZWdpbkRvbUNoYW5nZXMoKTtcbiAgICAgIHJldHVybiBmbigpO1xuICAgIH0gZmluYWxseSB7XG4gICAgICB0aGlzLmVuZERvbUNoYW5nZXMoKTtcbiAgICB9XG4gIH1cbn1cblxuZnVuY3Rpb24gbW9kaWZpZXNEb20oKSB7XG4gIHJldHVybiBmdW5jdGlvbiAoXG4gICAgdGFyZ2V0OiB7XG4gICAgICBfcmVuZGVyZXJIZWxwZXI6IE5hdGl2ZVNjcmlwdFJlbmRlcmVySGVscGVyU2VydmljZTtcbiAgICB9LFxuICAgIGtleTogc3RyaW5nIHwgc3ltYm9sLFxuICAgIGRlc2NyaXB0b3I6IFByb3BlcnR5RGVzY3JpcHRvcixcbiAgKSB7XG4gICAgY29uc3QgY2hpbGRGdW5jdGlvbiA9IGRlc2NyaXB0b3IudmFsdWU7XG4gICAgZGVzY3JpcHRvci52YWx1ZSA9IGZ1bmN0aW9uICguLi5hcmdzOiB1bmtub3duW10pIHtcbiAgICAgIGNvbnN0IGZuID0gY2hpbGRGdW5jdGlvbi5iaW5kKHRoaXMpO1xuICAgICAgcmV0dXJuIHRoaXMuX3JlbmRlcmVySGVscGVyLmV4ZWN1dGVEb21DaGFuZ2UoKCkgPT4gZm4oLi4uYXJncykpO1xuICAgIH07XG4gICAgcmV0dXJuIGRlc2NyaXB0b3I7XG4gIH07XG59XG5cbmV4cG9ydCBjbGFzcyBOYXRpdmVTY3JpcHRSZW5kZXJlckZhY3RvcnkgaW1wbGVtZW50cyBSZW5kZXJlckZhY3RvcnkyIHtcbiAgcHJpdmF0ZSBjb21wb25lbnRSZW5kZXJlcnMgPSBuZXcgTWFwPHN0cmluZywgUmVuZGVyZXIyPigpO1xuICBwcml2YXRlIGRlZmF1bHRSZW5kZXJlcjogUmVuZGVyZXIyO1xuICAvLyBiYWNrd2FyZHMgY29tcGF0aWJpbGl0eSB3aXRoIFJhZExpc3RWaWV3XG4gIHByaXZhdGUgcm9vdFZpZXcgPSBpbmplY3QoQVBQX1JPT1RfVklFVyk7XG4gIHByaXZhdGUgbmFtZXNwYWNlRmlsdGVycyA9IGluamVjdChOQU1FU1BBQ0VfRklMVEVSUyk7XG4gIHByaXZhdGUgcm9vdE1vZHVsZUlEID0gaW5qZWN0KE5BVElWRVNDUklQVF9ST09UX01PRFVMRV9JRCk7XG4gIHByaXZhdGUgcmV1c2VWaWV3cyA9IGluamVjdChFTkFCTEVfUkVVU0FCRV9WSUVXUywge1xuICAgIG9wdGlvbmFsOiB0cnVlLFxuICB9KTtcbiAgcHJpdmF0ZSBpbmplY3RvciA9IGluamVjdChJbmplY3Rvcik7XG4gIHByaXZhdGUgdmlld1V0aWwgPSBuZXcgVmlld1V0aWwodGhpcy5uYW1lc3BhY2VGaWx0ZXJzLCB0aGlzLnJldXNlVmlld3MpO1xuXG4gIGNvbnN0cnVjdG9yKCkge1xuICAgIGlmICh0eXBlb2YgdGhpcy5yZXVzZVZpZXdzICE9PSAnYm9vbGVhbicpIHtcbiAgICAgIHRoaXMucmV1c2VWaWV3cyA9IGZhbHNlOyAvLyBkZWZhdWx0IHRvIGZhbHNlXG4gICAgfVxuICAgIHRoaXMuZGVmYXVsdFJlbmRlcmVyID0gbmV3IE5hdGl2ZVNjcmlwdFJlbmRlcmVyKHRoaXMucm9vdFZpZXcpO1xuICB9XG4gIGNyZWF0ZVJlbmRlcmVyKGhvc3RFbGVtZW50OiBhbnksIHR5cGU6IFJlbmRlcmVyVHlwZTIpOiBSZW5kZXJlcjIge1xuICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5lbmFibGVkKSB7XG4gICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yZW5kZXJlckxvZyhgTmF0aXZlU2NyaXB0UmVuZGVyZXJGYWN0b3J5LmNyZWF0ZVJlbmRlcmVyICR7aG9zdEVsZW1lbnR9LiB0eXBlLmlkOiAke3R5cGUuaWR9IHR5cGUuZW5jYXBzdWxhdGlvbjogJHt0eXBlLmVuY2Fwc3VsYXRpb259YCk7XG4gICAgfVxuICAgIGlmICghaG9zdEVsZW1lbnQgfHwgIXR5cGUpIHtcbiAgICAgIHJldHVybiB0aGlzLmRlZmF1bHRSZW5kZXJlcjtcbiAgICB9XG5cbiAgICBsZXQgcmVuZGVyZXIgPSB0aGlzLmNvbXBvbmVudFJlbmRlcmVycy5nZXQodHlwZS5pZCk7XG4gICAgLyoqXG4gICAgICohIFdBUk5JTkdcbiAgICAgKiEgV2UncmUgcmV1c2luZyB0aGUgcmVuZGVyZXIgZm9yIHRoZSBjb21wb25lbnRzXG4gICAgICohIHRoaXMgbWlnaHQgY2F1c2UgdW5leHBlY3RlZCBiZWhhdmlvciBhcyB0aGUgXCJyb290Vmlld1wiIGlzIGFuIGFyYml0cmFyeSBob3N0RWxlbWVudFxuICAgICAqISBhbHNvLCB0aGUgcmVuZGVyZXIgaGFzIGl0J3MgLmRlc3Ryb3koKSBjYWxsZWQhXG4gICAgICohIG1pZ2h0IGJlIHVzZWZ1bCB0byBjcmVhdGUgYSBCYXNlRW11bGF0ZWRSZW5kZXIgYW5kIGEgUHJveHlFbXVsYXRlZFJlbmRlclxuICAgICAqISBldmVyeSBjb21wb25lbnQgdHlwZSBnZXRzIGEgQmFzZUVtdWxhdGVkUmVuZGVyIChzaW5nbGV0b24pIHdoaWNoIGlzIHBhc3NlZCB0byBQcm94eUVtdWxhdGVkUmVuZGVyXG4gICAgICohIFByb3h5RW11bGF0ZWRSZW5kZXJlciByZWdpc3RlcnMgd2l0aCBCYXNlRW11bGF0ZWRSZW5kZXIgc28gd2UgY2FuIGNsZWFuIHVwIHRoaW5ncyBsaWtlIENTUyB3aGVuIGl0J3Mgbm90IG5lZWRlZFxuICAgICAqISB0aGlzIG1pZ2h0IGJlIHVzZWZ1bCBpZiB3ZSBmaW5kIGEgd2F5IHRvIEhNUiBjb21wb25lbnQgc3R5bGluZyB3aXRob3V0IGEgZnVsbCByZWJvb3RzdHJhcFxuICAgICAqL1xuICAgIGlmIChyZW5kZXJlcikge1xuICAgICAgaWYgKHJlbmRlcmVyIGluc3RhbmNlb2YgRW11bGF0ZWRSZW5kZXJlcikge1xuICAgICAgICByZW5kZXJlci5hcHBseVRvSG9zdChob3N0RWxlbWVudCk7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiByZW5kZXJlcjtcbiAgICB9XG5cbiAgICBpZiAodHlwZS5lbmNhcHN1bGF0aW9uID09PSBWaWV3RW5jYXBzdWxhdGlvbi5Ob25lKSB7XG4gICAgICB0eXBlLnN0eWxlcy5tYXAoKHMpID0+IHMudG9TdHJpbmcoKSkuZm9yRWFjaCgodikgPT4gYWRkU3R5bGVUb0Nzcyh2LCB0aGlzLnJvb3RNb2R1bGVJRCkpO1xuICAgICAgcmVuZGVyZXIgPSB0aGlzLmRlZmF1bHRSZW5kZXJlcjtcbiAgICB9IGVsc2Uge1xuICAgICAgcnVuSW5JbmplY3Rpb25Db250ZXh0KHRoaXMuaW5qZWN0b3IsICgpID0+IHtcbiAgICAgICAgcmVuZGVyZXIgPSBuZXcgRW11bGF0ZWRSZW5kZXJlcih0eXBlLCBob3N0RWxlbWVudCk7XG4gICAgICB9KTtcbiAgICAgICg8RW11bGF0ZWRSZW5kZXJlcj5yZW5kZXJlcikuYXBwbHlUb0hvc3QoaG9zdEVsZW1lbnQpO1xuICAgIH1cblxuICAgIHRoaXMuY29tcG9uZW50UmVuZGVyZXJzLnNldCh0eXBlLmlkLCByZW5kZXJlcik7XG4gICAgcmV0dXJuIHJlbmRlcmVyO1xuICB9XG4gIC8vIGJlZ2luPygpOiB2b2lkIHtcbiAgLy8gICAgIHRocm93IG5ldyBFcnJvcihcIk1ldGhvZCBub3QgaW1wbGVtZW50ZWQuXCIpO1xuICAvLyB9XG4gIC8vIGVuZD8oKTogdm9pZCB7XG4gIC8vICAgICB0aHJvdyBuZXcgRXJyb3IoXCJNZXRob2Qgbm90IGltcGxlbWVudGVkLlwiKTtcbiAgLy8gfVxuICB3aGVuUmVuZGVyaW5nRG9uZSgpOiBQcm9taXNlPGFueT4ge1xuICAgIGlmICghdGhpcy5yb290Vmlldykge1xuICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpO1xuICAgIH1cbiAgICByZXR1cm4gbmV3IFByb21pc2U8dm9pZD4oKHJlc29sdmUpID0+IHtcbiAgICAgIGxldCBpbnRlcnZhbDogYW55ID0gMDtcbiAgICAgIGZ1bmN0aW9uIHNjaGVkdWxlUmVzb2x2ZSgpIHtcbiAgICAgICAgLy8gaU9TIHJlYWxseSBoYXRlcyBzeW5jaHJvbm91cyB0aGluZ3MuLi5cbiAgICAgICAgLy8gVXRpbHMucXVldWVNYWNyb3Rhc2socmVzb2x2ZSk7XG4gICAgICAgIHNldFRpbWVvdXQocmVzb2x2ZSwgMTUpO1xuICAgICAgfVxuICAgICAgZnVuY3Rpb24gZmlyZVdoZW5Mb2FkZWQoKSB7XG4gICAgICAgIGNvbnN0IHZpZXcgPSByb290RmFjdG9yeSgpO1xuICAgICAgICBpZiAodmlldy5pc0xvYWRlZCkge1xuICAgICAgICAgIHNjaGVkdWxlUmVzb2x2ZSgpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHZpZXcub25jZSgnbG9hZGVkJywgc2NoZWR1bGVSZXNvbHZlKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgY29uc3Qgcm9vdEZhY3RvcnkgPSAoKSA9PiAodGhpcy5yb290VmlldyBpbnN0YW5jZW9mIENvbnRlbnRWaWV3ID8gdGhpcy5yb290Vmlldy5jb250ZW50IDogdGhpcy5yb290Vmlldyk7XG4gICAgICBpZiAoIXJvb3RGYWN0b3J5KCkpIHtcbiAgICAgICAgaW50ZXJ2YWwgPSBzZXRJbnRlcnZhbCgoKSA9PiB7XG4gICAgICAgICAgaWYgKHJvb3RGYWN0b3J5KCkpIHtcbiAgICAgICAgICAgIGNsZWFySW50ZXJ2YWwoaW50ZXJ2YWwpO1xuICAgICAgICAgICAgZmlyZVdoZW5Mb2FkZWQoKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0sIDEwKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGZpcmVXaGVuTG9hZGVkKCk7XG4gICAgICB9XG4gICAgfSk7XG4gICAgLy8gdGhyb3cgbmV3IEVycm9yKFwiTWV0aG9kIG5vdCBpbXBsZW1lbnRlZC5cIik7XG4gIH1cbn1cblxuY2xhc3MgTmF0aXZlU2NyaXB0UmVuZGVyZXIgaW1wbGVtZW50cyBSZW5kZXJlcjIge1xuICBwcml2YXRlIG5hbWVzcGFjZUZpbHRlcnMgPSBpbmplY3QoTkFNRVNQQUNFX0ZJTFRFUlMpO1xuICBwcml2YXRlIHJldXNlVmlld3MgPSBpbmplY3QoRU5BQkxFX1JFVVNBQkVfVklFV1MsIHtcbiAgICBvcHRpb25hbDogdHJ1ZSxcbiAgfSk7XG4gIHByaXZhdGUgdmlld1V0aWwgPSBuZXcgVmlld1V0aWwodGhpcy5uYW1lc3BhY2VGaWx0ZXJzLCB0aGlzLnJldXNlVmlld3MpO1xuICBfcmVuZGVyZXJIZWxwZXIgPSBpbmplY3QoTmF0aXZlU2NyaXB0UmVuZGVyZXJIZWxwZXJTZXJ2aWNlKTtcbiAgcHJpdmF0ZSBzcGVjaWZpY1ByZXZlbnRlZEV2ZW50cyA9IG5ldyBTZXQoXG4gICAgaW5qZWN0KFBSRVZFTlRfU1BFQ0lGSUNfRVZFTlRTX0RVUklOR19DRCwge1xuICAgICAgb3B0aW9uYWw6IHRydWUsXG4gICAgfSkgPz8gW10sXG4gICk7XG4gIHByaXZhdGUgcHJldmVudENoYW5nZUV2ZW50cyA9XG4gICAgaW5qZWN0KFBSRVZFTlRfU1BFQ0lGSUNfRVZFTlRTX0RVUklOR19DRCwge1xuICAgICAgb3B0aW9uYWw6IHRydWUsXG4gICAgfSkgPz8gZmFsc2U7XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSByb290VmlldzogVmlldykge31cbiAgZ2V0IGRhdGEoKTogeyBba2V5OiBzdHJpbmddOiBhbnkgfSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdNZXRob2Qgbm90IGltcGxlbWVudGVkLicpO1xuICB9XG4gIGRlc3Ryb3koKTogdm9pZCB7XG4gICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmVuYWJsZWQpIHtcbiAgICAgIE5hdGl2ZVNjcmlwdERlYnVnLnJlbmRlcmVyTG9nKCdOYXRpdmVTY3JpcHRSZW5kZXJlci5kZXN0cm95Jyk7XG4gICAgfVxuICB9XG4gIEBpblJvb3Rab25lKClcbiAgQG1vZGlmaWVzRG9tKClcbiAgY3JlYXRlRWxlbWVudChuYW1lOiBzdHJpbmcsIG5hbWVzcGFjZT86IHN0cmluZykge1xuICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5lbmFibGVkKSB7XG4gICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yZW5kZXJlckxvZyhgTmF0aXZlU2NyaXB0UmVuZGVyZXIuY3JlYXRlRWxlbWVudDogJHtuYW1lfWApO1xuICAgIH1cbiAgICBsZXQgb2xkTmFtZTtcbiAgICBpZiAoIWlzS25vd25WaWV3KG5hbWUpKSB7XG4gICAgICBvbGROYW1lID0gbmFtZTtcbiAgICAgIG5hbWUgPSAnUHJveHlWaWV3Q29udGFpbmVyJztcbiAgICB9XG4gICAgY29uc3QgdmlldyA9IHRoaXMudmlld1V0aWwuY3JlYXRlVmlldyhuYW1lKTtcbiAgICBpZiAob2xkTmFtZSkge1xuICAgICAgKHZpZXcgYXMgYW55KS5jdXN0b21DU1NOYW1lID0gb2xkTmFtZTtcbiAgICB9XG4gICAgcmV0dXJuIHZpZXc7XG4gIH1cbiAgQGluUm9vdFpvbmUoKVxuICBAbW9kaWZpZXNEb20oKVxuICBjcmVhdGVDb21tZW50KHZhbHVlOiBzdHJpbmcpIHtcbiAgICBpZiAoTmF0aXZlU2NyaXB0RGVidWcuZW5hYmxlZCkge1xuICAgICAgTmF0aXZlU2NyaXB0RGVidWcucmVuZGVyZXJMb2coYE5hdGl2ZVNjcmlwdFJlbmRlcmVyLmNyZWF0ZUNvbW1lbnQgJHt2YWx1ZX1gKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMudmlld1V0aWwuY3JlYXRlQ29tbWVudCh2YWx1ZSk7XG4gIH1cbiAgQGluUm9vdFpvbmUoKVxuICBAbW9kaWZpZXNEb20oKVxuICBjcmVhdGVUZXh0KHZhbHVlOiBzdHJpbmcpIHtcbiAgICBpZiAoTmF0aXZlU2NyaXB0RGVidWcuZW5hYmxlZCkge1xuICAgICAgTmF0aXZlU2NyaXB0RGVidWcucmVuZGVyZXJMb2coYE5hdGl2ZVNjcmlwdFJlbmRlcmVyLmNyZWF0ZVRleHQgJHt2YWx1ZX1gKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMudmlld1V0aWwuY3JlYXRlVGV4dCh2YWx1ZSk7XG4gIH1cbiAgZGVzdHJveU5vZGU6IChub2RlOiBhbnkpID0+IHZvaWQgPSAobm9kZTogVmlldykgPT5cbiAgICBydW5JblJvb3Rab25lKCgpID0+IHtcbiAgICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5lbmFibGVkKSB7XG4gICAgICAgIE5hdGl2ZVNjcmlwdERlYnVnLnJlbmRlcmVyTG9nKGBOYXRpdmVTY3JpcHRSZW5kZXJlci5kZXN0cm95Tm9kZSBub2RlOiAke25vZGV9YCk7XG4gICAgICB9XG4gICAgICBpZiAobm9kZT8uZGVzdHJveU5vZGUpIHtcbiAgICAgICAgbm9kZT8uZGVzdHJveU5vZGUoKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgQGluUm9vdFpvbmUoKVxuICBAbW9kaWZpZXNEb20oKVxuICBhcHBlbmRDaGlsZChwYXJlbnQ6IFZpZXcsIG5ld0NoaWxkOiBWaWV3KTogdm9pZCB7XG4gICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmVuYWJsZWQpIHtcbiAgICAgIE5hdGl2ZVNjcmlwdERlYnVnLnJlbmRlcmVyTG9nKGBOYXRpdmVTY3JpcHRSZW5kZXJlci5hcHBlbmRDaGlsZCBjaGlsZDogJHtuZXdDaGlsZH0gcGFyZW50OiAke3BhcmVudH1gKTtcbiAgICB9XG4gICAgdGhpcy52aWV3VXRpbC5hcHBlbmRDaGlsZChwYXJlbnQsIG5ld0NoaWxkKTtcbiAgfVxuICBAaW5Sb290Wm9uZSgpXG4gIEBtb2RpZmllc0RvbSgpXG4gIGluc2VydEJlZm9yZShwYXJlbnQ6IGFueSwgbmV3Q2hpbGQ6IGFueSwgcmVmQ2hpbGQ6IGFueSk6IHZvaWQge1xuICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5lbmFibGVkKSB7XG4gICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yZW5kZXJlckxvZyhgTmF0aXZlU2NyaXB0UmVuZGVyZXIuaW5zZXJ0QmVmb3JlIGNoaWxkOiAke25ld0NoaWxkfSBgICsgYHBhcmVudDogJHtwYXJlbnR9IHJlZkNoaWxkOiAke3JlZkNoaWxkfWApO1xuICAgIH1cbiAgICB0aGlzLnZpZXdVdGlsLmluc2VydEJlZm9yZShwYXJlbnQsIG5ld0NoaWxkLCByZWZDaGlsZCk7XG4gIH1cbiAgQGluUm9vdFpvbmUoKVxuICBAbW9kaWZpZXNEb20oKVxuICByZW1vdmVDaGlsZChwYXJlbnQ6IGFueSwgb2xkQ2hpbGQ6IGFueSwgaXNIb3N0RWxlbWVudD86IGJvb2xlYW4pOiB2b2lkIHtcbiAgICBpZiAoTmF0aXZlU2NyaXB0RGVidWcuZW5hYmxlZCkge1xuICAgICAgTmF0aXZlU2NyaXB0RGVidWcucmVuZGVyZXJMb2coYE5hdGl2ZVNjcmlwdFJlbmRlcmVyLnJlbW92ZUNoaWxkIGNoaWxkOiAke29sZENoaWxkfSBwYXJlbnQ6ICR7cGFyZW50fWApO1xuICAgIH1cbiAgICB0aGlzLnZpZXdVdGlsLnJlbW92ZUNoaWxkKHBhcmVudCwgb2xkQ2hpbGQpO1xuICB9XG4gIHNlbGVjdFJvb3RFbGVtZW50KHNlbGVjdG9yT3JOb2RlOiBhbnksIHByZXNlcnZlQ29udGVudD86IGJvb2xlYW4pIHtcbiAgICBpZiAoTmF0aXZlU2NyaXB0RGVidWcuZW5hYmxlZCkge1xuICAgICAgTmF0aXZlU2NyaXB0RGVidWcucmVuZGVyZXJMb2coYE5hdGl2ZVNjcmlwdFJlbmRlcmVyLnNlbGVjdFJvb3RFbGVtZW50OiAke3NlbGVjdG9yT3JOb2RlfWApO1xuICAgIH1cbiAgICBpZiAoc2VsZWN0b3JPck5vZGUgaW5zdGFuY2VvZiBWaWV3KSB7XG4gICAgICByZXR1cm4gc2VsZWN0b3JPck5vZGU7XG4gICAgfVxuICAgIGlmIChzZWxlY3Rvck9yTm9kZSAmJiBzZWxlY3Rvck9yTm9kZVswXSA9PT0gJyMnKSB7XG4gICAgICBjb25zdCByZXN1bHQgPSBnZXRWaWV3QnlJZCh0aGlzLnJvb3RWaWV3LCBzZWxlY3Rvck9yTm9kZS5zbGljZSgxKSk7XG4gICAgICByZXR1cm4gKHJlc3VsdCB8fCB0aGlzLnJvb3RWaWV3KSBhcyBWaWV3O1xuICAgIH1cbiAgICBpZiAodHlwZW9mIHNlbGVjdG9yT3JOb2RlID09PSAnc3RyaW5nJykge1xuICAgICAgY29uc3QgdmlldyA9IHRoaXMudmlld1V0aWwuY3JlYXRlVmlldyhzZWxlY3Rvck9yTm9kZSk7XG4gICAgICBpZiAoZ2V0Rmlyc3ROYXRpdmVMaWtlVmlldyh2aWV3KSA9PT0gdmlldykge1xuICAgICAgICAvLyB2aWV3IGlzIG5hdGl2ZWxpa2UhXG4gICAgICAgIHRoaXMuYXBwZW5kQ2hpbGQodGhpcy5yb290Vmlldywgdmlldyk7XG4gICAgICAgIHJldHVybiB2aWV3O1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gdGhpcy5yb290VmlldztcbiAgfVxuICBwYXJlbnROb2RlKG5vZGU6IE5nVmlldykge1xuICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5lbmFibGVkKSB7XG4gICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yZW5kZXJlckxvZyhgTmF0aXZlU2NyaXB0UmVuZGVyZXIucGFyZW50Tm9kZSBmb3Igbm9kZTogJHtub2RlfSBpcyAke25vZGUucGFyZW50Tm9kZX1gKTtcbiAgICB9XG4gICAgcmV0dXJuIG5vZGUucGFyZW50Tm9kZTtcbiAgfVxuICBuZXh0U2libGluZyhub2RlOiBOZ1ZpZXcpIHtcbiAgICBpZiAoTmF0aXZlU2NyaXB0RGVidWcuZW5hYmxlZCkge1xuICAgICAgTmF0aXZlU2NyaXB0RGVidWcucmVuZGVyZXJMb2coYE5hdGl2ZVNjcmlwdFJlbmRlcmVyLm5leHRTaWJsaW5nIG9mICR7bm9kZX0gaXMgJHtub2RlLm5leHRTaWJsaW5nfWApO1xuICAgIH1cbiAgICByZXR1cm4gbm9kZS5uZXh0U2libGluZztcbiAgfVxuICBAaW5Sb290Wm9uZSgpXG4gIEBtb2RpZmllc0RvbSgpXG4gIHNldEF0dHJpYnV0ZShlbDogYW55LCBuYW1lOiBzdHJpbmcsIHZhbHVlOiBzdHJpbmcsIG5hbWVzcGFjZT86IHN0cmluZyk6IHZvaWQge1xuICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5lbmFibGVkKSB7XG4gICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yZW5kZXJlckxvZyhgTmF0aXZlU2NyaXB0UmVuZGVyZXIuc2V0QXR0cmlidXRlICR7bmFtZXNwYWNlID8gbmFtZXNwYWNlICsgJzonIDogJyd9JHtlbH0uJHtuYW1lfSA9ICR7dmFsdWV9YCk7XG4gICAgfVxuICAgIHRoaXMudmlld1V0aWwuc2V0UHJvcGVydHkoZWwsIG5hbWUsIHZhbHVlLCBuYW1lc3BhY2UpO1xuICB9XG4gIHJlbW92ZUF0dHJpYnV0ZShlbDogYW55LCBuYW1lOiBzdHJpbmcsIG5hbWVzcGFjZT86IHN0cmluZyk6IHZvaWQge1xuICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5lbmFibGVkKSB7XG4gICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yZW5kZXJlckxvZyhgTmF0aXZlU2NyaXB0UmVuZGVyZXIucmVtb3ZlQXR0cmlidXRlICR7bmFtZXNwYWNlID8gbmFtZXNwYWNlICsgJzonIDogJyd9JHtlbH0uJHtuYW1lfWApO1xuICAgIH1cbiAgfVxuICBAaW5Sb290Wm9uZSgpXG4gIEBtb2RpZmllc0RvbSgpXG4gIGFkZENsYXNzKGVsOiBhbnksIG5hbWU6IHN0cmluZyk6IHZvaWQge1xuICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5lbmFibGVkKSB7XG4gICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yZW5kZXJlckxvZyhgTmF0aXZlU2NyaXB0UmVuZGVyZXIuYWRkQ2xhc3MgJHtuYW1lfWApO1xuICAgIH1cbiAgICB0aGlzLnZpZXdVdGlsLmFkZENsYXNzKGVsLCBuYW1lKTtcbiAgfVxuICBAaW5Sb290Wm9uZSgpXG4gIEBtb2RpZmllc0RvbSgpXG4gIHJlbW92ZUNsYXNzKGVsOiBhbnksIG5hbWU6IHN0cmluZyk6IHZvaWQge1xuICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5lbmFibGVkKSB7XG4gICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yZW5kZXJlckxvZyhgTmF0aXZlU2NyaXB0UmVuZGVyZXIucmVtb3ZlQ2xhc3MgJHtuYW1lfWApO1xuICAgIH1cbiAgICB0aGlzLnZpZXdVdGlsLnJlbW92ZUNsYXNzKGVsLCBuYW1lKTtcbiAgfVxuICBAaW5Sb290Wm9uZSgpXG4gIEBtb2RpZmllc0RvbSgpXG4gIHNldFN0eWxlKGVsOiBhbnksIHN0eWxlOiBzdHJpbmcsIHZhbHVlOiBhbnksIGZsYWdzPzogUmVuZGVyZXJTdHlsZUZsYWdzMik6IHZvaWQge1xuICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5lbmFibGVkKSB7XG4gICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yZW5kZXJlckxvZyhgTmF0aXZlU2NyaXB0UmVuZGVyZXIuc2V0U3R5bGU6ICR7ZWx9LCAke3N0eWxlfSA9ICR7dmFsdWV9YCk7XG4gICAgfVxuICAgIHRoaXMudmlld1V0aWwuc2V0U3R5bGUoZWwsIHN0eWxlLCB2YWx1ZSk7XG4gIH1cbiAgQGluUm9vdFpvbmUoKVxuICBAbW9kaWZpZXNEb20oKVxuICByZW1vdmVTdHlsZShlbDogYW55LCBzdHlsZTogc3RyaW5nLCBmbGFncz86IFJlbmRlcmVyU3R5bGVGbGFnczIpOiB2b2lkIHtcbiAgICBpZiAoTmF0aXZlU2NyaXB0RGVidWcuZW5hYmxlZCkge1xuICAgICAgTmF0aXZlU2NyaXB0RGVidWcucmVuZGVyZXJMb2coJ05hdGl2ZVNjcmlwdFJlbmRlcmVyLnJlbW92ZVN0eWxlOiAke3N0eWxlTmFtZX0nKTtcbiAgICB9XG4gICAgdGhpcy52aWV3VXRpbC5yZW1vdmVTdHlsZShlbCwgc3R5bGUpO1xuICB9XG4gIEBpblJvb3Rab25lKClcbiAgQG1vZGlmaWVzRG9tKClcbiAgc2V0UHJvcGVydHkoZWw6IGFueSwgbmFtZTogc3RyaW5nLCB2YWx1ZTogYW55KTogdm9pZCB7XG4gICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmVuYWJsZWQpIHtcbiAgICAgIE5hdGl2ZVNjcmlwdERlYnVnLnJlbmRlcmVyTG9nKGBOYXRpdmVTY3JpcHRSZW5kZXJlci5zZXRQcm9wZXJ0eSAke2VsfS4ke25hbWV9ID0gJHt2YWx1ZX1gKTtcbiAgICB9XG4gICAgdGhpcy52aWV3VXRpbC5zZXRQcm9wZXJ0eShlbCwgbmFtZSwgdmFsdWUpO1xuICB9XG4gIEBpblJvb3Rab25lKClcbiAgQG1vZGlmaWVzRG9tKClcbiAgc2V0VmFsdWUobm9kZTogYW55LCB2YWx1ZTogc3RyaW5nKTogdm9pZCB7XG4gICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmVuYWJsZWQpIHtcbiAgICAgIE5hdGl2ZVNjcmlwdERlYnVnLnJlbmRlcmVyTG9nKGBOYXRpdmVTY3JpcHRSZW5kZXJlci5zZXRWYWx1ZSByZW5kZXJOb2RlOiAke25vZGV9LCB2YWx1ZTogJHt2YWx1ZX1gKTtcbiAgICB9XG4gICAgaWYgKG5vZGUgaW5zdGFuY2VvZiBUZXh0Tm9kZSkge1xuICAgICAgbm9kZS50ZXh0ID0gdmFsdWU7XG4gICAgfVxuICAgIC8vIHRocm93IG5ldyBFcnJvcihcIk1ldGhvZCBub3QgaW1wbGVtZW50ZWQuXCIpO1xuICB9XG4gIGxpc3Rlbih0YXJnZXQ6IFZpZXcsIGV2ZW50TmFtZTogc3RyaW5nLCBjYWxsYmFjazogKGV2ZW50OiBhbnkpID0+IGJvb2xlYW4gfCB2b2lkKTogKCkgPT4gdm9pZCB7XG4gICAgLy8gdGhyb3cgbmV3IEVycm9yKFwiTWV0aG9kIG5vdCBpbXBsZW1lbnRlZC5cIik7XG4gICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmVuYWJsZWQpIHtcbiAgICAgIE5hdGl2ZVNjcmlwdERlYnVnLnJlbmRlcmVyTG9nKGBOYXRpdmVTY3JpcHRSZW5kZXJlci5saXN0ZW46ICR7ZXZlbnROYW1lfWApO1xuICAgIH1cbiAgICBsZXQgbW9kaWZpZWRDYWxsYmFjayA9IGNhbGxiYWNrO1xuICAgIGlmICgodGhpcy5wcmV2ZW50Q2hhbmdlRXZlbnRzICYmIGV2ZW50TmFtZS5lbmRzV2l0aCgnQ2hhbmdlJykpIHx8IHRoaXMuc3BlY2lmaWNQcmV2ZW50ZWRFdmVudHMuaGFzKGV2ZW50TmFtZSkpIHtcbiAgICAgIG1vZGlmaWVkQ2FsbGJhY2sgPSAoLi4uYXJncykgPT4ge1xuICAgICAgICBpZiAodGhpcy5fcmVuZGVyZXJIZWxwZXIuaXNFeGVjdXRpbmdEb21DaGFuZ2VzKSB7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBjYWxsYmFjayguLi5hcmdzKTtcbiAgICAgIH07XG4gICAgfVxuICAgIHRhcmdldC5vbihldmVudE5hbWUsIG1vZGlmaWVkQ2FsbGJhY2spO1xuICAgIGlmIChldmVudE5hbWUgPT09IFZpZXcubG9hZGVkRXZlbnQgJiYgdGFyZ2V0LmlzTG9hZGVkKSB7XG4gICAgICAvLyB3ZSBtdXN0IGNyZWF0ZSBhIG5ldyBvYmVydmFibGUgaGVyZSB0byBlbnN1cmUgdGhhdCB0aGUgZXZlbnQgZ29lcyB0aHJvdWdoIHdoYXRldmVyIHpvbmUgcGF0Y2hlcyBhcmUgYXBwbGllZFxuICAgICAgY29uc3Qgb2JzID0gbmV3IE9ic2VydmFibGUoKTtcbiAgICAgIG9icy5vbmNlKGV2ZW50TmFtZSwgbW9kaWZpZWRDYWxsYmFjayk7XG4gICAgICBvYnMubm90aWZ5KHtcbiAgICAgICAgZXZlbnROYW1lLFxuICAgICAgICBvYmplY3Q6IHRhcmdldCxcbiAgICAgIH0pO1xuICAgIH1cbiAgICByZXR1cm4gKCkgPT4gdGFyZ2V0Lm9mZihldmVudE5hbWUsIG1vZGlmaWVkQ2FsbGJhY2spO1xuICB9XG59XG5cbi8vIENPTlRFTlRfQVRUUiBub3QgZXhwb3J0ZWQgZnJvbSBuYXRpdmVzY3JpcHQtcmVuZGVyZXIgLSB3ZSBuZWVkIGl0IGZvciBzdHlsZXMgYXBwbGljYXRpb24uXG5jb25zdCBDT01QT05FTlRfUkVHRVggPSAvJUNPTVAlL2c7XG5jb25zdCBBVFRSX1NBTklUSVpFUiA9IC8tL2c7XG5leHBvcnQgY29uc3QgQ09NUE9ORU5UX1ZBUklBQkxFID0gJyVDT01QJSc7XG5leHBvcnQgY29uc3QgSE9TVF9BVFRSID0gYF9uZ2hvc3QtJHtDT01QT05FTlRfVkFSSUFCTEV9YDtcbmV4cG9ydCBjb25zdCBDT05URU5UX0FUVFIgPSBgX25nY29udGVudC0ke0NPTVBPTkVOVF9WQVJJQUJMRX1gO1xuXG5jb25zdCByZXBsYWNlTmdBdHRyaWJ1dGUgPSBmdW5jdGlvbiAoaW5wdXQ6IHN0cmluZywgY29tcG9uZW50SWQ6IHN0cmluZyk6IHN0cmluZyB7XG4gIHJldHVybiBpbnB1dC5yZXBsYWNlKENPTVBPTkVOVF9SRUdFWCwgY29tcG9uZW50SWQpO1xufTtcblxuY29uc3QgYWRkU2NvcGVkU3R5bGVUb0NzcyA9IHByb2ZpbGUoYFwicmVuZGVyZXJcIi5hZGRTY29wZWRTdHlsZVRvQ3NzYCwgZnVuY3Rpb24gYWRkU2NvcGVkU3R5bGVUb0NzcyhzdHlsZTogc3RyaW5nLCB0YWc/OiBudW1iZXIgfCBzdHJpbmcpOiB2b2lkIHtcbiAgaWYgKHRhZykge1xuICAgIGFkZFRhZ2dlZEFkZGl0aW9uYWxDU1Moc3R5bGUsIHRhZyk7XG4gIH0gZWxzZSB7XG4gICAgQXBwbGljYXRpb24uYWRkQ3NzKHN0eWxlKTtcbiAgfVxufSk7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBFbXVsYXRlZFJlbmRlcmVyIGV4dGVuZHMgTmF0aXZlU2NyaXB0UmVuZGVyZXIge1xuICBwcml2YXRlIGNvbnRlbnRBdHRyOiBzdHJpbmc7XG4gIHByaXZhdGUgaG9zdEF0dHI6IHN0cmluZztcbiAgcHJpdmF0ZSByb290TW9kdWxlSWQgPSBpbmplY3QoTkFUSVZFU0NSSVBUX1JPT1RfTU9EVUxFX0lEKTtcblxuICBjb25zdHJ1Y3Rvcihjb21wb25lbnQ6IFJlbmRlcmVyVHlwZTIsIHJvb3RWaWV3OiBWaWV3KSB7XG4gICAgc3VwZXIocm9vdFZpZXcpO1xuXG4gICAgY29uc3QgY29tcG9uZW50SWQgPSBjb21wb25lbnQuaWQucmVwbGFjZShBVFRSX1NBTklUSVpFUiwgJ18nKTtcbiAgICB0aGlzLmNvbnRlbnRBdHRyID0gcmVwbGFjZU5nQXR0cmlidXRlKENPTlRFTlRfQVRUUiwgY29tcG9uZW50SWQpO1xuICAgIHRoaXMuaG9zdEF0dHIgPSByZXBsYWNlTmdBdHRyaWJ1dGUoSE9TVF9BVFRSLCBjb21wb25lbnRJZCk7XG4gICAgdGhpcy5hZGRTdHlsZXMoY29tcG9uZW50LnN0eWxlcywgY29tcG9uZW50SWQpO1xuICB9XG5cbiAgYXBwbHlUb0hvc3QodmlldzogTmdWaWV3KSB7XG4gICAgc3VwZXIuc2V0QXR0cmlidXRlKHZpZXcsIHRoaXMuaG9zdEF0dHIsICcnKTtcbiAgfVxuXG4gIGFwcGVuZENoaWxkKHBhcmVudDogYW55LCBuZXdDaGlsZDogTmdWaWV3KTogdm9pZCB7XG4gICAgc3VwZXIuYXBwZW5kQ2hpbGQocGFyZW50LCBuZXdDaGlsZCk7XG4gIH1cblxuICBjcmVhdGVFbGVtZW50KHBhcmVudDogYW55LCBuYW1lOiBzdHJpbmcpOiBOZ1ZpZXcge1xuICAgIGNvbnN0IHZpZXcgPSBzdXBlci5jcmVhdGVFbGVtZW50KHBhcmVudCwgbmFtZSk7XG5cbiAgICAvLyBTZXQgYW4gYXR0cmlidXRlIHRvIHRoZSB2aWV3IHRvIHNjb3BlIGNvbXBvbmVudC1zcGVjaWZpYyBjc3MuXG4gICAgLy8gVGhlIHByb3BlcnR5IG5hbWUgaXMgcHJlLWdlbmVyYXRlZCBieSBBbmd1bGFyLlxuICAgIHN1cGVyLnNldEF0dHJpYnV0ZSh2aWV3LCB0aGlzLmNvbnRlbnRBdHRyLCAnJyk7XG5cbiAgICByZXR1cm4gdmlldztcbiAgfVxuXG4gIEBwcm9maWxlXG4gIEBpblJvb3Rab25lKClcbiAgQG1vZGlmaWVzRG9tKClcbiAgcHJpdmF0ZSBhZGRTdHlsZXMoc3R5bGVzOiAoc3RyaW5nIHwgYW55W10pW10sIGNvbXBvbmVudElkOiBzdHJpbmcpIHtcbiAgICBzdHlsZXNcbiAgICAgIC5tYXAoKHMpID0+IHMudG9TdHJpbmcoKSlcbiAgICAgIC5tYXAoKHMpID0+IHJlcGxhY2VOZ0F0dHJpYnV0ZShzLCBjb21wb25lbnRJZCkpXG4gICAgICAuZm9yRWFjaCgocykgPT4gYWRkU2NvcGVkU3R5bGVUb0NzcyhzLCB0aGlzLnJvb3RNb2R1bGVJZCkpO1xuICB9XG59XG4iXX0=
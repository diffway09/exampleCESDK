import { ProxyViewContainer, eachDescendant, CssAnimationProperty, CSSHelper } from '@nativescript/core';
import { NativeScriptAnimationPlayer } from './animation-player';
import { dashCaseToCamelCase } from './utils';
import { InvisibleNode } from '../views/invisible-nodes';
import { NativeScriptDebug } from '../trace';
class Selector {
    constructor(rawSelector) {
        this.parse(rawSelector);
    }
    match(element) {
        return this.nsSelectorMatch(element) || this.classSelectorsMatch(element);
    }
    parse(rawSelector) {
        const selectors = rawSelector.split(',').map((s) => s.trim());
        this.nsSelectors = selectors.map(CSSHelper.createSelector);
        this.classSelectors = selectors.filter((s) => s.startsWith('.')).map((s) => s.substring(1));
    }
    nsSelectorMatch(element) {
        return this.nsSelectors.some((s) => s.match(element));
    }
    classSelectorsMatch(element) {
        return this.classSelectors.some((s) => this.hasClass(element, s));
    }
    // we're using that instead of match for classes
    // that are dynamically added by the animation engine
    // such as .ng-trigger, that's added for every :enter view
    hasClass(element, cls) {
        return element && element['$$classes'] && element['$$classes'][cls];
    }
}
export class NativeScriptAnimationDriver {
    static { this.validProperties = [...CssAnimationProperty._getPropertyNames(), 'transform']; }
    getParentElement(element) {
        return element?.parent;
    }
    validateStyleProperty(property) {
        NativeScriptDebug.animationsLog(`CssAnimationProperty.validateStyleProperty: ${property}`);
        return NativeScriptAnimationDriver.validProperties.indexOf(property) !== -1;
    }
    matchesElement(element, rawSelector) {
        NativeScriptDebug.animationsLog(`NativeScriptAnimationDriver.matchesElement ` + `element: ${element}, selector: ${rawSelector}`);
        const selector = this.makeSelector(rawSelector);
        return selector.match(element);
    }
    containsElement(elm1, elm2) {
        NativeScriptDebug.animationsLog(`NativeScriptAnimationDriver.containsElement ` + `element1: ${elm1}, element2: ${elm2}`);
        // Checking if the parent is our fake body object
        if (elm1['isOverride']) {
            return true;
        }
        const params = { originalView: elm2 };
        const result = this.visitDescendants(elm1, viewMatches, params);
        return result.found;
    }
    query(element, rawSelector, multi) {
        NativeScriptDebug.animationsLog(`NativeScriptAnimationDriver.query ` + `element: ${element}, selector: ${rawSelector} ` + `multi: ${multi}`);
        const selector = this.makeSelector(rawSelector);
        const params = { selector, multi };
        const result = this.visitDescendants(element, queryDescendants, params);
        return result.matches || [];
    }
    computeStyle(element, prop) {
        NativeScriptDebug.animationsLog(`NativeScriptAnimationDriver.computeStyle ` + `element: ${element}, prop: ${prop}`);
        const camelCaseProp = dashCaseToCamelCase(prop);
        return element.style[camelCaseProp];
    }
    animate(element, keyframes, duration, delay, easing) {
        NativeScriptDebug.animationsLog(`NativeScriptAnimationDriver.animate ` + `element: ${element}, keyframes: ${keyframes} ` + `duration: ${duration}, delay: ${delay} ` + `easing: ${easing}`);
        return new NativeScriptAnimationPlayer(element, keyframes, duration, delay, easing);
    }
    makeSelector(rawSelector) {
        return new Selector(rawSelector);
    }
    visitDescendants(element, cb, cbParams) {
        const result = {};
        // fill the result obj with the result from the callback function
        eachDescendant(element, (child) => cb(child, result, cbParams));
        return result;
    }
}
function viewMatches(element, result, params) {
    if (element === params.originalView) {
        result.found = true;
    }
    return !result.found;
}
function queryDescendants(element, result, params) {
    if (!result.matches) {
        result.matches = [];
    }
    const { selector, multi } = params;
    // skip comment and text nodes
    // because they are not actual Views
    // and cannot be animated
    if (element instanceof InvisibleNode || !selector.match(element)) {
        return true;
    }
    if (element instanceof ProxyViewContainer) {
        element.eachChild((child) => {
            result.matches.push(child);
            return true;
        });
    }
    else {
        result.matches.push(element);
    }
    return multi;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYW5pbWF0aW9uLWRyaXZlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3BhY2thZ2VzL2FuZ3VsYXIvc3JjL2xpYi9hbmltYXRpb25zL2FuaW1hdGlvbi1kcml2ZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBRUEsT0FBTyxFQUFFLGtCQUFrQixFQUFFLGNBQWMsRUFBRSxvQkFBb0IsRUFBRSxTQUFTLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUV6RyxPQUFPLEVBQUUsMkJBQTJCLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUNqRSxPQUFPLEVBQVksbUJBQW1CLEVBQUUsTUFBTSxTQUFTLENBQUM7QUFDeEQsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBRXpELE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLFVBQVUsQ0FBQztBQW1CN0MsTUFBTSxRQUFRO0lBSVosWUFBWSxXQUFtQjtRQUM3QixJQUFJLENBQUMsS0FBSyxDQUFDLFdBQVcsQ0FBQyxDQUFDO0lBQzFCLENBQUM7SUFFRCxLQUFLLENBQUMsT0FBZTtRQUNuQixPQUFPLElBQUksQ0FBQyxlQUFlLENBQUMsT0FBTyxDQUFDLElBQUksSUFBSSxDQUFDLG1CQUFtQixDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQzVFLENBQUM7SUFFTyxLQUFLLENBQUMsV0FBbUI7UUFDL0IsTUFBTSxTQUFTLEdBQUcsV0FBVyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDO1FBRTlELElBQUksQ0FBQyxXQUFXLEdBQUcsU0FBUyxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsY0FBYyxDQUFDLENBQUM7UUFDM0QsSUFBSSxDQUFDLGNBQWMsR0FBRyxTQUFTLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDOUYsQ0FBQztJQUVPLGVBQWUsQ0FBQyxPQUFlO1FBQ3JDLE9BQU8sSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztJQUN4RCxDQUFDO0lBRU8sbUJBQW1CLENBQUMsT0FBZTtRQUN6QyxPQUFPLElBQUksQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ3BFLENBQUM7SUFFRCxnREFBZ0Q7SUFDaEQscURBQXFEO0lBQ3JELDBEQUEwRDtJQUNsRCxRQUFRLENBQUMsT0FBZSxFQUFFLEdBQVc7UUFDM0MsT0FBTyxPQUFPLElBQUksT0FBTyxDQUFDLFdBQVcsQ0FBQyxJQUFJLE9BQU8sQ0FBQyxXQUFXLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUN0RSxDQUFDO0NBQ0Y7QUFFRCxNQUFNLE9BQU8sMkJBQTJCO2FBQ3ZCLG9CQUFlLEdBQUcsQ0FBQyxHQUFHLG9CQUFvQixDQUFDLGlCQUFpQixFQUFFLEVBQUUsV0FBVyxDQUFDLENBQUM7SUFFNUYsZ0JBQWdCLENBQUMsT0FBZTtRQUM5QixPQUFPLE9BQU8sRUFBRSxNQUFnQixDQUFDO0lBQ25DLENBQUM7SUFFRCxxQkFBcUIsQ0FBQyxRQUFnQjtRQUNwQyxpQkFBaUIsQ0FBQyxhQUFhLENBQUMsK0NBQStDLFFBQVEsRUFBRSxDQUFDLENBQUM7UUFDM0YsT0FBTywyQkFBMkIsQ0FBQyxlQUFlLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO0lBQzlFLENBQUM7SUFFRCxjQUFjLENBQUMsT0FBZSxFQUFFLFdBQW1CO1FBQ2pELGlCQUFpQixDQUFDLGFBQWEsQ0FBQyw2Q0FBNkMsR0FBRyxZQUFZLE9BQU8sZUFBZSxXQUFXLEVBQUUsQ0FBQyxDQUFDO1FBRWpJLE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsV0FBVyxDQUFDLENBQUM7UUFDaEQsT0FBTyxRQUFRLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQ2pDLENBQUM7SUFFRCxlQUFlLENBQUMsSUFBWSxFQUFFLElBQVk7UUFDeEMsaUJBQWlCLENBQUMsYUFBYSxDQUFDLDhDQUE4QyxHQUFHLGFBQWEsSUFBSSxlQUFlLElBQUksRUFBRSxDQUFDLENBQUM7UUFFekgsaURBQWlEO1FBQ2pELElBQUksSUFBSSxDQUFDLFlBQVksQ0FBQyxFQUFFLENBQUM7WUFDdkIsT0FBTyxJQUFJLENBQUM7UUFDZCxDQUFDO1FBRUQsTUFBTSxNQUFNLEdBQW9CLEVBQUUsWUFBWSxFQUFFLElBQUksRUFBRSxDQUFDO1FBQ3ZELE1BQU0sTUFBTSxHQUFvQixJQUFJLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxFQUFFLFdBQVcsRUFBRSxNQUFNLENBQUMsQ0FBQztRQUVqRixPQUFPLE1BQU0sQ0FBQyxLQUFLLENBQUM7SUFDdEIsQ0FBQztJQUVELEtBQUssQ0FBQyxPQUFlLEVBQUUsV0FBbUIsRUFBRSxLQUFjO1FBQ3hELGlCQUFpQixDQUFDLGFBQWEsQ0FBQyxvQ0FBb0MsR0FBRyxZQUFZLE9BQU8sZUFBZSxXQUFXLEdBQUcsR0FBRyxVQUFVLEtBQUssRUFBRSxDQUFDLENBQUM7UUFFN0ksTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUNoRCxNQUFNLE1BQU0sR0FBZ0IsRUFBRSxRQUFRLEVBQUUsS0FBSyxFQUFFLENBQUM7UUFDaEQsTUFBTSxNQUFNLEdBQWdCLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxDQUFDLENBQUM7UUFFckYsT0FBTyxNQUFNLENBQUMsT0FBTyxJQUFJLEVBQUUsQ0FBQztJQUM5QixDQUFDO0lBRUQsWUFBWSxDQUFDLE9BQWUsRUFBRSxJQUFZO1FBQ3hDLGlCQUFpQixDQUFDLGFBQWEsQ0FBQywyQ0FBMkMsR0FBRyxZQUFZLE9BQU8sV0FBVyxJQUFJLEVBQUUsQ0FBQyxDQUFDO1FBRXBILE1BQU0sYUFBYSxHQUFHLG1CQUFtQixDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ2hELE9BQU8sT0FBTyxDQUFDLEtBQUssQ0FBQyxhQUFhLENBQUMsQ0FBQztJQUN0QyxDQUFDO0lBRUQsT0FBTyxDQUFDLE9BQWUsRUFBRSxTQUFxQixFQUFFLFFBQWdCLEVBQUUsS0FBYSxFQUFFLE1BQWM7UUFDN0YsaUJBQWlCLENBQUMsYUFBYSxDQUFDLHNDQUFzQyxHQUFHLFlBQVksT0FBTyxnQkFBZ0IsU0FBUyxHQUFHLEdBQUcsYUFBYSxRQUFRLFlBQVksS0FBSyxHQUFHLEdBQUcsV0FBVyxNQUFNLEVBQUUsQ0FBQyxDQUFDO1FBRTVMLE9BQU8sSUFBSSwyQkFBMkIsQ0FBQyxPQUFPLEVBQUUsU0FBUyxFQUFFLFFBQVEsRUFBRSxLQUFLLEVBQUUsTUFBTSxDQUFDLENBQUM7SUFDdEYsQ0FBQztJQUVPLFlBQVksQ0FBQyxXQUFtQjtRQUN0QyxPQUFPLElBQUksUUFBUSxDQUFDLFdBQVcsQ0FBQyxDQUFDO0lBQ25DLENBQUM7SUFFTyxnQkFBZ0IsQ0FBQyxPQUFlLEVBQUUsRUFBd0QsRUFBRSxRQUFhO1FBQy9HLE1BQU0sTUFBTSxHQUFHLEVBQUUsQ0FBQztRQUNsQixpRUFBaUU7UUFDakUsY0FBYyxDQUFDLE9BQU8sRUFBRSxDQUFDLEtBQWEsRUFBRSxFQUFFLENBQUMsRUFBRSxDQUFDLEtBQUssRUFBRSxNQUFNLEVBQUUsUUFBUSxDQUFDLENBQUMsQ0FBQztRQUV4RSxPQUFPLE1BQU0sQ0FBQztJQUNoQixDQUFDOztBQUdILFNBQVMsV0FBVyxDQUFDLE9BQWUsRUFBRSxNQUF1QixFQUFFLE1BQXVCO0lBQ3BGLElBQUksT0FBTyxLQUFLLE1BQU0sQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQUNwQyxNQUFNLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQztJQUN0QixDQUFDO0lBRUQsT0FBTyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUM7QUFDdkIsQ0FBQztBQUVELFNBQVMsZ0JBQWdCLENBQUMsT0FBZSxFQUFFLE1BQW1CLEVBQUUsTUFBbUI7SUFDakYsSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUNwQixNQUFNLENBQUMsT0FBTyxHQUFHLEVBQUUsQ0FBQztJQUN0QixDQUFDO0lBRUQsTUFBTSxFQUFFLFFBQVEsRUFBRSxLQUFLLEVBQUUsR0FBRyxNQUFNLENBQUM7SUFFbkMsOEJBQThCO0lBQzlCLG9DQUFvQztJQUNwQyx5QkFBeUI7SUFDekIsSUFBSSxPQUFPLFlBQVksYUFBYSxJQUFJLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDO1FBQ2pFLE9BQU8sSUFBSSxDQUFDO0lBQ2QsQ0FBQztJQUVELElBQUksT0FBTyxZQUFZLGtCQUFrQixFQUFFLENBQUM7UUFDMUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDLEtBQWEsRUFBRSxFQUFFO1lBQ2xDLE1BQU0sQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQzNCLE9BQU8sSUFBSSxDQUFDO1FBQ2QsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO1NBQU0sQ0FBQztRQUNOLE1BQU0sQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQy9CLENBQUM7SUFFRCxPQUFPLEtBQUssQ0FBQztBQUNmLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBbmltYXRpb25QbGF5ZXIgfSBmcm9tICdAYW5ndWxhci9hbmltYXRpb25zJztcbmltcG9ydCB7IEFuaW1hdGlvbkRyaXZlciB9IGZyb20gJ0Bhbmd1bGFyL2FuaW1hdGlvbnMvYnJvd3Nlcic7XG5pbXBvcnQgeyBQcm94eVZpZXdDb250YWluZXIsIGVhY2hEZXNjZW5kYW50LCBDc3NBbmltYXRpb25Qcm9wZXJ0eSwgQ1NTSGVscGVyIH0gZnJvbSAnQG5hdGl2ZXNjcmlwdC9jb3JlJztcblxuaW1wb3J0IHsgTmF0aXZlU2NyaXB0QW5pbWF0aW9uUGxheWVyIH0gZnJvbSAnLi9hbmltYXRpb24tcGxheWVyJztcbmltcG9ydCB7IEtleWZyYW1lLCBkYXNoQ2FzZVRvQ2FtZWxDYXNlIH0gZnJvbSAnLi91dGlscyc7XG5pbXBvcnQgeyBJbnZpc2libGVOb2RlIH0gZnJvbSAnLi4vdmlld3MvaW52aXNpYmxlLW5vZGVzJztcbmltcG9ydCB7IE5nVmlldyB9IGZyb20gJy4uL3ZpZXdzL3ZpZXctdHlwZXMnO1xuaW1wb3J0IHsgTmF0aXZlU2NyaXB0RGVidWcgfSBmcm9tICcuLi90cmFjZSc7XG5cbmludGVyZmFjZSBWaWV3TWF0Y2hSZXN1bHQge1xuICBmb3VuZDogYm9vbGVhbjtcbn1cblxuaW50ZXJmYWNlIFZpZXdNYXRjaFBhcmFtcyB7XG4gIG9yaWdpbmFsVmlldzogTmdWaWV3O1xufVxuXG5pbnRlcmZhY2UgUXVlcnlQYXJhbXMge1xuICBzZWxlY3RvcjogU2VsZWN0b3I7XG4gIG11bHRpOiBib29sZWFuO1xufVxuXG5pbnRlcmZhY2UgUXVlcnlSZXN1bHQge1xuICBtYXRjaGVzOiBOZ1ZpZXdbXTtcbn1cblxuY2xhc3MgU2VsZWN0b3Ige1xuICBwcml2YXRlIG5zU2VsZWN0b3JzOiBBcnJheTxhbnk+O1xuICBwcml2YXRlIGNsYXNzU2VsZWN0b3JzOiBzdHJpbmdbXTtcblxuICBjb25zdHJ1Y3RvcihyYXdTZWxlY3Rvcjogc3RyaW5nKSB7XG4gICAgdGhpcy5wYXJzZShyYXdTZWxlY3Rvcik7XG4gIH1cblxuICBtYXRjaChlbGVtZW50OiBOZ1ZpZXcpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy5uc1NlbGVjdG9yTWF0Y2goZWxlbWVudCkgfHwgdGhpcy5jbGFzc1NlbGVjdG9yc01hdGNoKGVsZW1lbnQpO1xuICB9XG5cbiAgcHJpdmF0ZSBwYXJzZShyYXdTZWxlY3Rvcjogc3RyaW5nKSB7XG4gICAgY29uc3Qgc2VsZWN0b3JzID0gcmF3U2VsZWN0b3Iuc3BsaXQoJywnKS5tYXAoKHMpID0+IHMudHJpbSgpKTtcblxuICAgIHRoaXMubnNTZWxlY3RvcnMgPSBzZWxlY3RvcnMubWFwKENTU0hlbHBlci5jcmVhdGVTZWxlY3Rvcik7XG4gICAgdGhpcy5jbGFzc1NlbGVjdG9ycyA9IHNlbGVjdG9ycy5maWx0ZXIoKHMpID0+IHMuc3RhcnRzV2l0aCgnLicpKS5tYXAoKHMpID0+IHMuc3Vic3RyaW5nKDEpKTtcbiAgfVxuXG4gIHByaXZhdGUgbnNTZWxlY3Rvck1hdGNoKGVsZW1lbnQ6IE5nVmlldykge1xuICAgIHJldHVybiB0aGlzLm5zU2VsZWN0b3JzLnNvbWUoKHMpID0+IHMubWF0Y2goZWxlbWVudCkpO1xuICB9XG5cbiAgcHJpdmF0ZSBjbGFzc1NlbGVjdG9yc01hdGNoKGVsZW1lbnQ6IE5nVmlldykge1xuICAgIHJldHVybiB0aGlzLmNsYXNzU2VsZWN0b3JzLnNvbWUoKHMpID0+IHRoaXMuaGFzQ2xhc3MoZWxlbWVudCwgcykpO1xuICB9XG5cbiAgLy8gd2UncmUgdXNpbmcgdGhhdCBpbnN0ZWFkIG9mIG1hdGNoIGZvciBjbGFzc2VzXG4gIC8vIHRoYXQgYXJlIGR5bmFtaWNhbGx5IGFkZGVkIGJ5IHRoZSBhbmltYXRpb24gZW5naW5lXG4gIC8vIHN1Y2ggYXMgLm5nLXRyaWdnZXIsIHRoYXQncyBhZGRlZCBmb3IgZXZlcnkgOmVudGVyIHZpZXdcbiAgcHJpdmF0ZSBoYXNDbGFzcyhlbGVtZW50OiBOZ1ZpZXcsIGNsczogc3RyaW5nKSB7XG4gICAgcmV0dXJuIGVsZW1lbnQgJiYgZWxlbWVudFsnJCRjbGFzc2VzJ10gJiYgZWxlbWVudFsnJCRjbGFzc2VzJ11bY2xzXTtcbiAgfVxufVxuXG5leHBvcnQgY2xhc3MgTmF0aXZlU2NyaXB0QW5pbWF0aW9uRHJpdmVyIGltcGxlbWVudHMgQW5pbWF0aW9uRHJpdmVyIHtcbiAgcHJpdmF0ZSBzdGF0aWMgdmFsaWRQcm9wZXJ0aWVzID0gWy4uLkNzc0FuaW1hdGlvblByb3BlcnR5Ll9nZXRQcm9wZXJ0eU5hbWVzKCksICd0cmFuc2Zvcm0nXTtcblxuICBnZXRQYXJlbnRFbGVtZW50KGVsZW1lbnQ6IE5nVmlldyk6IE5nVmlldyB7XG4gICAgcmV0dXJuIGVsZW1lbnQ/LnBhcmVudCBhcyBOZ1ZpZXc7XG4gIH1cblxuICB2YWxpZGF0ZVN0eWxlUHJvcGVydHkocHJvcGVydHk6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgIE5hdGl2ZVNjcmlwdERlYnVnLmFuaW1hdGlvbnNMb2coYENzc0FuaW1hdGlvblByb3BlcnR5LnZhbGlkYXRlU3R5bGVQcm9wZXJ0eTogJHtwcm9wZXJ0eX1gKTtcbiAgICByZXR1cm4gTmF0aXZlU2NyaXB0QW5pbWF0aW9uRHJpdmVyLnZhbGlkUHJvcGVydGllcy5pbmRleE9mKHByb3BlcnR5KSAhPT0gLTE7XG4gIH1cblxuICBtYXRjaGVzRWxlbWVudChlbGVtZW50OiBOZ1ZpZXcsIHJhd1NlbGVjdG9yOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICBOYXRpdmVTY3JpcHREZWJ1Zy5hbmltYXRpb25zTG9nKGBOYXRpdmVTY3JpcHRBbmltYXRpb25Ecml2ZXIubWF0Y2hlc0VsZW1lbnQgYCArIGBlbGVtZW50OiAke2VsZW1lbnR9LCBzZWxlY3RvcjogJHtyYXdTZWxlY3Rvcn1gKTtcblxuICAgIGNvbnN0IHNlbGVjdG9yID0gdGhpcy5tYWtlU2VsZWN0b3IocmF3U2VsZWN0b3IpO1xuICAgIHJldHVybiBzZWxlY3Rvci5tYXRjaChlbGVtZW50KTtcbiAgfVxuXG4gIGNvbnRhaW5zRWxlbWVudChlbG0xOiBOZ1ZpZXcsIGVsbTI6IE5nVmlldyk6IGJvb2xlYW4ge1xuICAgIE5hdGl2ZVNjcmlwdERlYnVnLmFuaW1hdGlvbnNMb2coYE5hdGl2ZVNjcmlwdEFuaW1hdGlvbkRyaXZlci5jb250YWluc0VsZW1lbnQgYCArIGBlbGVtZW50MTogJHtlbG0xfSwgZWxlbWVudDI6ICR7ZWxtMn1gKTtcblxuICAgIC8vIENoZWNraW5nIGlmIHRoZSBwYXJlbnQgaXMgb3VyIGZha2UgYm9keSBvYmplY3RcbiAgICBpZiAoZWxtMVsnaXNPdmVycmlkZSddKSB7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG5cbiAgICBjb25zdCBwYXJhbXM6IFZpZXdNYXRjaFBhcmFtcyA9IHsgb3JpZ2luYWxWaWV3OiBlbG0yIH07XG4gICAgY29uc3QgcmVzdWx0OiBWaWV3TWF0Y2hSZXN1bHQgPSB0aGlzLnZpc2l0RGVzY2VuZGFudHMoZWxtMSwgdmlld01hdGNoZXMsIHBhcmFtcyk7XG5cbiAgICByZXR1cm4gcmVzdWx0LmZvdW5kO1xuICB9XG5cbiAgcXVlcnkoZWxlbWVudDogTmdWaWV3LCByYXdTZWxlY3Rvcjogc3RyaW5nLCBtdWx0aTogYm9vbGVhbik6IE5nVmlld1tdIHtcbiAgICBOYXRpdmVTY3JpcHREZWJ1Zy5hbmltYXRpb25zTG9nKGBOYXRpdmVTY3JpcHRBbmltYXRpb25Ecml2ZXIucXVlcnkgYCArIGBlbGVtZW50OiAke2VsZW1lbnR9LCBzZWxlY3RvcjogJHtyYXdTZWxlY3Rvcn0gYCArIGBtdWx0aTogJHttdWx0aX1gKTtcblxuICAgIGNvbnN0IHNlbGVjdG9yID0gdGhpcy5tYWtlU2VsZWN0b3IocmF3U2VsZWN0b3IpO1xuICAgIGNvbnN0IHBhcmFtczogUXVlcnlQYXJhbXMgPSB7IHNlbGVjdG9yLCBtdWx0aSB9O1xuICAgIGNvbnN0IHJlc3VsdDogUXVlcnlSZXN1bHQgPSB0aGlzLnZpc2l0RGVzY2VuZGFudHMoZWxlbWVudCwgcXVlcnlEZXNjZW5kYW50cywgcGFyYW1zKTtcblxuICAgIHJldHVybiByZXN1bHQubWF0Y2hlcyB8fCBbXTtcbiAgfVxuXG4gIGNvbXB1dGVTdHlsZShlbGVtZW50OiBOZ1ZpZXcsIHByb3A6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgTmF0aXZlU2NyaXB0RGVidWcuYW5pbWF0aW9uc0xvZyhgTmF0aXZlU2NyaXB0QW5pbWF0aW9uRHJpdmVyLmNvbXB1dGVTdHlsZSBgICsgYGVsZW1lbnQ6ICR7ZWxlbWVudH0sIHByb3A6ICR7cHJvcH1gKTtcblxuICAgIGNvbnN0IGNhbWVsQ2FzZVByb3AgPSBkYXNoQ2FzZVRvQ2FtZWxDYXNlKHByb3ApO1xuICAgIHJldHVybiBlbGVtZW50LnN0eWxlW2NhbWVsQ2FzZVByb3BdO1xuICB9XG5cbiAgYW5pbWF0ZShlbGVtZW50OiBOZ1ZpZXcsIGtleWZyYW1lczogS2V5ZnJhbWVbXSwgZHVyYXRpb246IG51bWJlciwgZGVsYXk6IG51bWJlciwgZWFzaW5nOiBzdHJpbmcpOiBBbmltYXRpb25QbGF5ZXIge1xuICAgIE5hdGl2ZVNjcmlwdERlYnVnLmFuaW1hdGlvbnNMb2coYE5hdGl2ZVNjcmlwdEFuaW1hdGlvbkRyaXZlci5hbmltYXRlIGAgKyBgZWxlbWVudDogJHtlbGVtZW50fSwga2V5ZnJhbWVzOiAke2tleWZyYW1lc30gYCArIGBkdXJhdGlvbjogJHtkdXJhdGlvbn0sIGRlbGF5OiAke2RlbGF5fSBgICsgYGVhc2luZzogJHtlYXNpbmd9YCk7XG5cbiAgICByZXR1cm4gbmV3IE5hdGl2ZVNjcmlwdEFuaW1hdGlvblBsYXllcihlbGVtZW50LCBrZXlmcmFtZXMsIGR1cmF0aW9uLCBkZWxheSwgZWFzaW5nKTtcbiAgfVxuXG4gIHByaXZhdGUgbWFrZVNlbGVjdG9yKHJhd1NlbGVjdG9yOiBzdHJpbmcpOiBTZWxlY3RvciB7XG4gICAgcmV0dXJuIG5ldyBTZWxlY3RvcihyYXdTZWxlY3Rvcik7XG4gIH1cblxuICBwcml2YXRlIHZpc2l0RGVzY2VuZGFudHMoZWxlbWVudDogTmdWaWV3LCBjYjogKGNoaWxkOiBOZ1ZpZXcsIHJlc3VsdDogYW55LCBwYXJhbXM6IGFueSkgPT4gYm9vbGVhbiwgY2JQYXJhbXM6IGFueSk6IGFueSB7XG4gICAgY29uc3QgcmVzdWx0ID0ge307XG4gICAgLy8gZmlsbCB0aGUgcmVzdWx0IG9iaiB3aXRoIHRoZSByZXN1bHQgZnJvbSB0aGUgY2FsbGJhY2sgZnVuY3Rpb25cbiAgICBlYWNoRGVzY2VuZGFudChlbGVtZW50LCAoY2hpbGQ6IE5nVmlldykgPT4gY2IoY2hpbGQsIHJlc3VsdCwgY2JQYXJhbXMpKTtcblxuICAgIHJldHVybiByZXN1bHQ7XG4gIH1cbn1cblxuZnVuY3Rpb24gdmlld01hdGNoZXMoZWxlbWVudDogTmdWaWV3LCByZXN1bHQ6IFZpZXdNYXRjaFJlc3VsdCwgcGFyYW1zOiBWaWV3TWF0Y2hQYXJhbXMpOiBib29sZWFuIHtcbiAgaWYgKGVsZW1lbnQgPT09IHBhcmFtcy5vcmlnaW5hbFZpZXcpIHtcbiAgICByZXN1bHQuZm91bmQgPSB0cnVlO1xuICB9XG5cbiAgcmV0dXJuICFyZXN1bHQuZm91bmQ7XG59XG5cbmZ1bmN0aW9uIHF1ZXJ5RGVzY2VuZGFudHMoZWxlbWVudDogTmdWaWV3LCByZXN1bHQ6IFF1ZXJ5UmVzdWx0LCBwYXJhbXM6IFF1ZXJ5UGFyYW1zKTogYm9vbGVhbiB7XG4gIGlmICghcmVzdWx0Lm1hdGNoZXMpIHtcbiAgICByZXN1bHQubWF0Y2hlcyA9IFtdO1xuICB9XG5cbiAgY29uc3QgeyBzZWxlY3RvciwgbXVsdGkgfSA9IHBhcmFtcztcblxuICAvLyBza2lwIGNvbW1lbnQgYW5kIHRleHQgbm9kZXNcbiAgLy8gYmVjYXVzZSB0aGV5IGFyZSBub3QgYWN0dWFsIFZpZXdzXG4gIC8vIGFuZCBjYW5ub3QgYmUgYW5pbWF0ZWRcbiAgaWYgKGVsZW1lbnQgaW5zdGFuY2VvZiBJbnZpc2libGVOb2RlIHx8ICFzZWxlY3Rvci5tYXRjaChlbGVtZW50KSkge1xuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgaWYgKGVsZW1lbnQgaW5zdGFuY2VvZiBQcm94eVZpZXdDb250YWluZXIpIHtcbiAgICBlbGVtZW50LmVhY2hDaGlsZCgoY2hpbGQ6IE5nVmlldykgPT4ge1xuICAgICAgcmVzdWx0Lm1hdGNoZXMucHVzaChjaGlsZCk7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9KTtcbiAgfSBlbHNlIHtcbiAgICByZXN1bHQubWF0Y2hlcy5wdXNoKGVsZW1lbnQpO1xuICB9XG5cbiAgcmV0dXJuIG11bHRpO1xufVxuIl19
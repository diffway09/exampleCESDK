import { ApplicationRef, ComponentFactoryResolver, TemplateRef } from '@angular/core';
import { ContentView } from '@nativescript/core';
import { DetachedLoader } from './cdk/detached-loader';
import { ComponentPortal, NativeScriptDomPortalOutlet, TemplatePortal } from './cdk/portal';
import { NgViewRef } from './view-refs';
/**
 * creates a DetachedLoader either linked to the ViewContainerRef or the ApplicationRef if ViewContainerRef is not defined
 * @param resolver component factory resolver
 * @param injector default injector, unused if viewContainerRef is set
 * @param viewContainerRef where the view should live in the angular tree
 * @returns reference to the DetachedLoader
 */
export function generateDetachedLoader(resolver, injector, viewContainerRef) {
    injector = viewContainerRef?.injector || injector;
    const detachedFactory = resolver.resolveComponentFactory(DetachedLoader);
    const detachedLoaderRef = viewContainerRef?.createComponent(detachedFactory) || detachedFactory.create(injector);
    if (!viewContainerRef) {
        injector.get(ApplicationRef).attachView(detachedLoaderRef.hostView);
    }
    detachedLoaderRef.changeDetectorRef.detectChanges();
    return detachedLoaderRef;
}
/**
 * Generates a NgViewRef from a component or template. @see NgViewRef
 * Pass keepNativeViewAttached as `true` if you don't want the first native view to be detached from its parent.
 * For opening modals and others, the firstNativeLikeView should be detached.
 * @param typeOrTemplate ComponentType or TemplateRef that should be instanced
 * @param options options for creating the view
 * @returns NgViewRef
 */
export function generateNativeScriptView(typeOrTemplate, options) {
    let detachedLoaderRef = options.detachedLoaderRef;
    const reusingDetachedLoader = !!detachedLoaderRef;
    if (reusingDetachedLoader) {
        options.viewContainerRef = detachedLoaderRef.instance.vc;
    }
    const injector = options.viewContainerRef?.injector || options.injector;
    const resolver = options.resolver || injector.get(ComponentFactoryResolver);
    if (!detachedLoaderRef && (options.viewContainerRef || typeOrTemplate instanceof TemplateRef)) {
        detachedLoaderRef = generateDetachedLoader(resolver, injector, options.viewContainerRef);
    }
    let portal;
    if (typeOrTemplate instanceof TemplateRef) {
        portal = new TemplatePortal(typeOrTemplate, detachedLoaderRef.instance.vc);
    }
    else {
        portal = new ComponentPortal(typeOrTemplate, detachedLoaderRef?.instance.vc);
    }
    const parentView = new ContentView();
    const portalOutlet = new NativeScriptDomPortalOutlet(parentView, resolver, injector.get(ApplicationRef), injector);
    const componentOrTemplateRef = portalOutlet.attach(portal);
    componentOrTemplateRef.onDestroy(() => {
        portalOutlet.dispose();
    });
    if (detachedLoaderRef && !reusingDetachedLoader) {
        componentOrTemplateRef.onDestroy(() => {
            detachedLoaderRef.destroy();
        });
    }
    const viewRef = new NgViewRef(componentOrTemplateRef);
    viewRef.detachedLoaderRef = detachedLoaderRef;
    if (!options.keepNativeViewAttached) {
        viewRef.detachNativeLikeView();
    }
    return viewRef;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGV0YWNoZWQtbG9hZGVyLXV0aWxzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vcGFja2FnZXMvYW5ndWxhci9zcmMvbGliL2RldGFjaGVkLWxvYWRlci11dGlscy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsY0FBYyxFQUFFLHdCQUF3QixFQUEyQyxXQUFXLEVBQTBCLE1BQU0sZUFBZSxDQUFDO0FBQ3ZKLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUNqRCxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFDdkQsT0FBTyxFQUFFLGVBQWUsRUFBRSwyQkFBMkIsRUFBRSxjQUFjLEVBQUUsTUFBTSxjQUFjLENBQUM7QUFDNUYsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUV4Qzs7Ozs7O0dBTUc7QUFDSCxNQUFNLFVBQVUsc0JBQXNCLENBQUMsUUFBa0MsRUFBRSxRQUFrQixFQUFFLGdCQUFtQztJQUNoSSxRQUFRLEdBQUcsZ0JBQWdCLEVBQUUsUUFBUSxJQUFJLFFBQVEsQ0FBQztJQUNsRCxNQUFNLGVBQWUsR0FBRyxRQUFRLENBQUMsdUJBQXVCLENBQUMsY0FBYyxDQUFDLENBQUM7SUFDekUsTUFBTSxpQkFBaUIsR0FBRyxnQkFBZ0IsRUFBRSxlQUFlLENBQUMsZUFBZSxDQUFDLElBQUksZUFBZSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUNqSCxJQUFJLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztRQUN0QixRQUFRLENBQUMsR0FBRyxDQUFDLGNBQWMsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxpQkFBaUIsQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUN0RSxDQUFDO0lBQ0QsaUJBQWlCLENBQUMsaUJBQWlCLENBQUMsYUFBYSxFQUFFLENBQUM7SUFDcEQsT0FBTyxpQkFBaUIsQ0FBQztBQUMzQixDQUFDO0FBRUQ7Ozs7Ozs7R0FPRztBQUNILE1BQU0sVUFBVSx3QkFBd0IsQ0FDdEMsY0FBd0MsRUFDeEMsT0FTQztJQUVELElBQUksaUJBQWlCLEdBQWlDLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQztJQUNoRixNQUFNLHFCQUFxQixHQUFHLENBQUMsQ0FBQyxpQkFBaUIsQ0FBQztJQUNsRCxJQUFJLHFCQUFxQixFQUFFLENBQUM7UUFDMUIsT0FBTyxDQUFDLGdCQUFnQixHQUFHLGlCQUFpQixDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUM7SUFDM0QsQ0FBQztJQUNELE1BQU0sUUFBUSxHQUFHLE9BQU8sQ0FBQyxnQkFBZ0IsRUFBRSxRQUFRLElBQUksT0FBTyxDQUFDLFFBQVEsQ0FBQztJQUN4RSxNQUFNLFFBQVEsR0FBRyxPQUFPLENBQUMsUUFBUSxJQUFJLFFBQVEsQ0FBQyxHQUFHLENBQUMsd0JBQXdCLENBQUMsQ0FBQztJQUM1RSxJQUFJLENBQUMsaUJBQWlCLElBQUksQ0FBQyxPQUFPLENBQUMsZ0JBQWdCLElBQUksY0FBYyxZQUFZLFdBQVcsQ0FBQyxFQUFFLENBQUM7UUFDOUYsaUJBQWlCLEdBQUcsc0JBQXNCLENBQUMsUUFBUSxFQUFFLFFBQVEsRUFBRSxPQUFPLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztJQUMzRixDQUFDO0lBQ0QsSUFBSSxNQUE4QyxDQUFDO0lBQ25ELElBQUksY0FBYyxZQUFZLFdBQVcsRUFBRSxDQUFDO1FBQzFDLE1BQU0sR0FBRyxJQUFJLGNBQWMsQ0FBQyxjQUFjLEVBQUUsaUJBQWlCLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFDO0lBQzdFLENBQUM7U0FBTSxDQUFDO1FBQ04sTUFBTSxHQUFHLElBQUksZUFBZSxDQUFDLGNBQWMsRUFBRSxpQkFBaUIsRUFBRSxRQUFRLENBQUMsRUFBRSxDQUFDLENBQUM7SUFDL0UsQ0FBQztJQUNELE1BQU0sVUFBVSxHQUFHLElBQUksV0FBVyxFQUFFLENBQUM7SUFDckMsTUFBTSxZQUFZLEdBQUcsSUFBSSwyQkFBMkIsQ0FBQyxVQUFVLEVBQUUsUUFBUSxFQUFFLFFBQVEsQ0FBQyxHQUFHLENBQUMsY0FBYyxDQUFDLEVBQUUsUUFBUSxDQUFDLENBQUM7SUFDbkgsTUFBTSxzQkFBc0IsR0FBeUMsWUFBWSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUNqRyxzQkFBc0IsQ0FBQyxTQUFTLENBQUMsR0FBRyxFQUFFO1FBQ3BDLFlBQVksQ0FBQyxPQUFPLEVBQUUsQ0FBQztJQUN6QixDQUFDLENBQUMsQ0FBQztJQUNILElBQUksaUJBQWlCLElBQUksQ0FBQyxxQkFBcUIsRUFBRSxDQUFDO1FBQ2hELHNCQUFzQixDQUFDLFNBQVMsQ0FBQyxHQUFHLEVBQUU7WUFDcEMsaUJBQWlCLENBQUMsT0FBTyxFQUFFLENBQUM7UUFDOUIsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBQ0QsTUFBTSxPQUFPLEdBQUcsSUFBSSxTQUFTLENBQUMsc0JBQXNCLENBQUMsQ0FBQztJQUNyRCxPQUFlLENBQUMsaUJBQWlCLEdBQUcsaUJBQWlCLENBQUM7SUFDdkQsSUFBSSxDQUFDLE9BQU8sQ0FBQyxzQkFBc0IsRUFBRSxDQUFDO1FBQ3BDLE9BQU8sQ0FBQyxvQkFBb0IsRUFBRSxDQUFDO0lBQ2pDLENBQUM7SUFDRCxPQUFPLE9BQU8sQ0FBQztBQUNqQixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQXBwbGljYXRpb25SZWYsIENvbXBvbmVudEZhY3RvcnlSZXNvbHZlciwgQ29tcG9uZW50UmVmLCBFbWJlZGRlZFZpZXdSZWYsIEluamVjdG9yLCBUZW1wbGF0ZVJlZiwgVHlwZSwgVmlld0NvbnRhaW5lclJlZiB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgQ29udGVudFZpZXcgfSBmcm9tICdAbmF0aXZlc2NyaXB0L2NvcmUnO1xuaW1wb3J0IHsgRGV0YWNoZWRMb2FkZXIgfSBmcm9tICcuL2Nkay9kZXRhY2hlZC1sb2FkZXInO1xuaW1wb3J0IHsgQ29tcG9uZW50UG9ydGFsLCBOYXRpdmVTY3JpcHREb21Qb3J0YWxPdXRsZXQsIFRlbXBsYXRlUG9ydGFsIH0gZnJvbSAnLi9jZGsvcG9ydGFsJztcbmltcG9ydCB7IE5nVmlld1JlZiB9IGZyb20gJy4vdmlldy1yZWZzJztcblxuLyoqXG4gKiBjcmVhdGVzIGEgRGV0YWNoZWRMb2FkZXIgZWl0aGVyIGxpbmtlZCB0byB0aGUgVmlld0NvbnRhaW5lclJlZiBvciB0aGUgQXBwbGljYXRpb25SZWYgaWYgVmlld0NvbnRhaW5lclJlZiBpcyBub3QgZGVmaW5lZFxuICogQHBhcmFtIHJlc29sdmVyIGNvbXBvbmVudCBmYWN0b3J5IHJlc29sdmVyXG4gKiBAcGFyYW0gaW5qZWN0b3IgZGVmYXVsdCBpbmplY3RvciwgdW51c2VkIGlmIHZpZXdDb250YWluZXJSZWYgaXMgc2V0XG4gKiBAcGFyYW0gdmlld0NvbnRhaW5lclJlZiB3aGVyZSB0aGUgdmlldyBzaG91bGQgbGl2ZSBpbiB0aGUgYW5ndWxhciB0cmVlXG4gKiBAcmV0dXJucyByZWZlcmVuY2UgdG8gdGhlIERldGFjaGVkTG9hZGVyXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBnZW5lcmF0ZURldGFjaGVkTG9hZGVyKHJlc29sdmVyOiBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIsIGluamVjdG9yOiBJbmplY3Rvciwgdmlld0NvbnRhaW5lclJlZj86IFZpZXdDb250YWluZXJSZWYpIHtcbiAgaW5qZWN0b3IgPSB2aWV3Q29udGFpbmVyUmVmPy5pbmplY3RvciB8fCBpbmplY3RvcjtcbiAgY29uc3QgZGV0YWNoZWRGYWN0b3J5ID0gcmVzb2x2ZXIucmVzb2x2ZUNvbXBvbmVudEZhY3RvcnkoRGV0YWNoZWRMb2FkZXIpO1xuICBjb25zdCBkZXRhY2hlZExvYWRlclJlZiA9IHZpZXdDb250YWluZXJSZWY/LmNyZWF0ZUNvbXBvbmVudChkZXRhY2hlZEZhY3RvcnkpIHx8IGRldGFjaGVkRmFjdG9yeS5jcmVhdGUoaW5qZWN0b3IpO1xuICBpZiAoIXZpZXdDb250YWluZXJSZWYpIHtcbiAgICBpbmplY3Rvci5nZXQoQXBwbGljYXRpb25SZWYpLmF0dGFjaFZpZXcoZGV0YWNoZWRMb2FkZXJSZWYuaG9zdFZpZXcpO1xuICB9XG4gIGRldGFjaGVkTG9hZGVyUmVmLmNoYW5nZURldGVjdG9yUmVmLmRldGVjdENoYW5nZXMoKTtcbiAgcmV0dXJuIGRldGFjaGVkTG9hZGVyUmVmO1xufVxuXG4vKipcbiAqIEdlbmVyYXRlcyBhIE5nVmlld1JlZiBmcm9tIGEgY29tcG9uZW50IG9yIHRlbXBsYXRlLiBAc2VlIE5nVmlld1JlZlxuICogUGFzcyBrZWVwTmF0aXZlVmlld0F0dGFjaGVkIGFzIGB0cnVlYCBpZiB5b3UgZG9uJ3Qgd2FudCB0aGUgZmlyc3QgbmF0aXZlIHZpZXcgdG8gYmUgZGV0YWNoZWQgZnJvbSBpdHMgcGFyZW50LlxuICogRm9yIG9wZW5pbmcgbW9kYWxzIGFuZCBvdGhlcnMsIHRoZSBmaXJzdE5hdGl2ZUxpa2VWaWV3IHNob3VsZCBiZSBkZXRhY2hlZC5cbiAqIEBwYXJhbSB0eXBlT3JUZW1wbGF0ZSBDb21wb25lbnRUeXBlIG9yIFRlbXBsYXRlUmVmIHRoYXQgc2hvdWxkIGJlIGluc3RhbmNlZFxuICogQHBhcmFtIG9wdGlvbnMgb3B0aW9ucyBmb3IgY3JlYXRpbmcgdGhlIHZpZXdcbiAqIEByZXR1cm5zIE5nVmlld1JlZlxuICovXG5leHBvcnQgZnVuY3Rpb24gZ2VuZXJhdGVOYXRpdmVTY3JpcHRWaWV3PFQ+KFxuICB0eXBlT3JUZW1wbGF0ZTogVHlwZTxUPiB8IFRlbXBsYXRlUmVmPFQ+LFxuICBvcHRpb25zOiB7XG4gICAgcmVzb2x2ZXI/OiBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXI7XG4gICAgdmlld0NvbnRhaW5lclJlZj86IFZpZXdDb250YWluZXJSZWY7XG4gICAgaW5qZWN0b3I6IEluamVjdG9yO1xuICAgIGtlZXBOYXRpdmVWaWV3QXR0YWNoZWQ/OiBib29sZWFuO1xuICAgIC8qKlxuICAgICAqIHJldXNlIGEgZGV0YWNoZWRMb2FkZXJSZWYuIFRoaXMgd2lsbCBvdmVycmlkZSB2aWV3Q29udGFpbmVyUmVmXG4gICAgICovXG4gICAgZGV0YWNoZWRMb2FkZXJSZWY/OiBDb21wb25lbnRSZWY8RGV0YWNoZWRMb2FkZXI+O1xuICB9XG4pIHtcbiAgbGV0IGRldGFjaGVkTG9hZGVyUmVmOiBDb21wb25lbnRSZWY8RGV0YWNoZWRMb2FkZXI+ID0gb3B0aW9ucy5kZXRhY2hlZExvYWRlclJlZjtcbiAgY29uc3QgcmV1c2luZ0RldGFjaGVkTG9hZGVyID0gISFkZXRhY2hlZExvYWRlclJlZjtcbiAgaWYgKHJldXNpbmdEZXRhY2hlZExvYWRlcikge1xuICAgIG9wdGlvbnMudmlld0NvbnRhaW5lclJlZiA9IGRldGFjaGVkTG9hZGVyUmVmLmluc3RhbmNlLnZjO1xuICB9XG4gIGNvbnN0IGluamVjdG9yID0gb3B0aW9ucy52aWV3Q29udGFpbmVyUmVmPy5pbmplY3RvciB8fCBvcHRpb25zLmluamVjdG9yO1xuICBjb25zdCByZXNvbHZlciA9IG9wdGlvbnMucmVzb2x2ZXIgfHwgaW5qZWN0b3IuZ2V0KENvbXBvbmVudEZhY3RvcnlSZXNvbHZlcik7XG4gIGlmICghZGV0YWNoZWRMb2FkZXJSZWYgJiYgKG9wdGlvbnMudmlld0NvbnRhaW5lclJlZiB8fCB0eXBlT3JUZW1wbGF0ZSBpbnN0YW5jZW9mIFRlbXBsYXRlUmVmKSkge1xuICAgIGRldGFjaGVkTG9hZGVyUmVmID0gZ2VuZXJhdGVEZXRhY2hlZExvYWRlcihyZXNvbHZlciwgaW5qZWN0b3IsIG9wdGlvbnMudmlld0NvbnRhaW5lclJlZik7XG4gIH1cbiAgbGV0IHBvcnRhbDogQ29tcG9uZW50UG9ydGFsPFQ+IHwgVGVtcGxhdGVQb3J0YWw8VD47XG4gIGlmICh0eXBlT3JUZW1wbGF0ZSBpbnN0YW5jZW9mIFRlbXBsYXRlUmVmKSB7XG4gICAgcG9ydGFsID0gbmV3IFRlbXBsYXRlUG9ydGFsKHR5cGVPclRlbXBsYXRlLCBkZXRhY2hlZExvYWRlclJlZi5pbnN0YW5jZS52Yyk7XG4gIH0gZWxzZSB7XG4gICAgcG9ydGFsID0gbmV3IENvbXBvbmVudFBvcnRhbCh0eXBlT3JUZW1wbGF0ZSwgZGV0YWNoZWRMb2FkZXJSZWY/Lmluc3RhbmNlLnZjKTtcbiAgfVxuICBjb25zdCBwYXJlbnRWaWV3ID0gbmV3IENvbnRlbnRWaWV3KCk7XG4gIGNvbnN0IHBvcnRhbE91dGxldCA9IG5ldyBOYXRpdmVTY3JpcHREb21Qb3J0YWxPdXRsZXQocGFyZW50VmlldywgcmVzb2x2ZXIsIGluamVjdG9yLmdldChBcHBsaWNhdGlvblJlZiksIGluamVjdG9yKTtcbiAgY29uc3QgY29tcG9uZW50T3JUZW1wbGF0ZVJlZjogQ29tcG9uZW50UmVmPFQ+IHwgRW1iZWRkZWRWaWV3UmVmPFQ+ID0gcG9ydGFsT3V0bGV0LmF0dGFjaChwb3J0YWwpO1xuICBjb21wb25lbnRPclRlbXBsYXRlUmVmLm9uRGVzdHJveSgoKSA9PiB7XG4gICAgcG9ydGFsT3V0bGV0LmRpc3Bvc2UoKTtcbiAgfSk7XG4gIGlmIChkZXRhY2hlZExvYWRlclJlZiAmJiAhcmV1c2luZ0RldGFjaGVkTG9hZGVyKSB7XG4gICAgY29tcG9uZW50T3JUZW1wbGF0ZVJlZi5vbkRlc3Ryb3koKCkgPT4ge1xuICAgICAgZGV0YWNoZWRMb2FkZXJSZWYuZGVzdHJveSgpO1xuICAgIH0pO1xuICB9XG4gIGNvbnN0IHZpZXdSZWYgPSBuZXcgTmdWaWV3UmVmKGNvbXBvbmVudE9yVGVtcGxhdGVSZWYpO1xuICAodmlld1JlZiBhcyBhbnkpLmRldGFjaGVkTG9hZGVyUmVmID0gZGV0YWNoZWRMb2FkZXJSZWY7XG4gIGlmICghb3B0aW9ucy5rZWVwTmF0aXZlVmlld0F0dGFjaGVkKSB7XG4gICAgdmlld1JlZi5kZXRhY2hOYXRpdmVMaWtlVmlldygpO1xuICB9XG4gIHJldHVybiB2aWV3UmVmO1xufVxuIl19